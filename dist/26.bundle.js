/*! For license information please see 26.bundle.js.LICENSE.txt */
"use strict";(self.webpackChunkclass11=self.webpackChunkclass11||[]).push([[26],{26:(t,e,n)=>{n.r(e),n.d(e,{AbstractUserDataWriter:()=>xg,AggregateField:()=>vm,AggregateQuerySnapshot:()=>bm,Bytes:()=>Im,CACHE_SIZE_UNLIMITED:()=>nm,CollectionReference:()=>Qf,DocumentReference:()=>$f,DocumentSnapshot:()=>Lg,FieldPath:()=>_m,FieldValue:()=>Em,Firestore:()=>rm,FirestoreError:()=>zr,GeoPoint:()=>Sm,LoadBundleTask:()=>em,PersistentCacheIndexManager:()=>Dp,Query:()=>jf,QueryCompositeFilterConstraint:()=>ag,QueryConstraint:()=>rg,QueryDocumentSnapshot:()=>Fg,QueryEndAtConstraint:()=>wg,QueryFieldFilterConstraint:()=>ig,QueryLimitConstraint:()=>dg,QueryOrderByConstraint:()=>lg,QuerySnapshot:()=>Og,QueryStartAtConstraint:()=>gg,SnapshotMetadata:()=>Pg,Timestamp:()=>ss,Transaction:()=>wp,WriteBatch:()=>pp,_AutoId:()=>ts,_ByteString:()=>Di,_DatabaseId:()=>Oi,_DocumentKey:()=>ls,_EmptyAppCheckTokenProvider:()=>Jr,_EmptyAuthCredentialsProvider:()=>jr,_FieldPath:()=>cs,_TestingHooks:()=>Lp,_cast:()=>Uf,_debugAssert:()=>qr,_isBase64Available:()=>Ci,_logWarn:()=>Lr,_validateIsNotUsedTogether:()=>Ff,addDoc:()=>Yg,aggregateFieldEqual:()=>Rg,aggregateQuerySnapshotEqual:()=>Mg,and:()=>cg,arrayRemove:()=>Tp,arrayUnion:()=>_p,average:()=>Ng,clearIndexedDbPersistence:()=>hm,collection:()=>Wf,collectionGroup:()=>Hf,connectFirestoreEmulator:()=>Gf,count:()=>kg,deleteAllPersistentCacheIndexes:()=>Rp,deleteDoc:()=>Hg,deleteField:()=>bp,disableNetwork:()=>mm,disablePersistentCacheIndexAutoCreation:()=>kp,doc:()=>Yf,documentId:()=>Tm,enableIndexedDbPersistence:()=>um,enableMultiTabIndexedDbPersistence:()=>cm,enableNetwork:()=>fm,enablePersistentCacheIndexAutoCreation:()=>Np,endAt:()=>bg,endBefore:()=>vg,ensureFirestoreConfigured:()=>om,executeWrite:()=>Zg,getAggregateFromServer:()=>np,getCountFromServer:()=>ep,getDoc:()=>Ug,getDocFromCache:()=>zg,getDocFromServer:()=>Kg,getDocs:()=>Gg,getDocsFromCache:()=>jg,getDocsFromServer:()=>$g,getFirestore:()=>im,getPersistentCacheIndexManager:()=>Ap,increment:()=>Ep,initializeFirestore:()=>sm,limit:()=>fg,limitToLast:()=>mg,loadBundle:()=>pm,memoryEagerGarbageCollector:()=>ap,memoryLocalCache:()=>cp,memoryLruGarbageCollector:()=>up,namedQuery:()=>ym,onSnapshot:()=>Xg,onSnapshotsInSync:()=>Jg,or:()=>ug,orderBy:()=>hg,persistentLocalCache:()=>lp,persistentMultipleTabManager:()=>mp,persistentSingleTabManager:()=>fp,query:()=>sg,queryEqual:()=>Jf,refEqual:()=>Xf,runTransaction:()=>vp,serverTimestamp:()=>Ip,setDoc:()=>Qg,setIndexConfiguration:()=>xp,setLogLevel:()=>Rr,snapshotEqual:()=>qg,startAfter:()=>yg,startAt:()=>pg,sum:()=>Ag,terminate:()=>gm,updateDoc:()=>Wg,waitForPendingWrites:()=>dm,where:()=>og,writeBatch:()=>Sp});var r,s=n(990),i=n(125),o=n(424),a=n(743),u="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},c={},l=l||{},h=u||self;function d(t){var e=typeof t;return"array"==(e="object"!=e?e:t?Array.isArray(t)?"array":e:"null")||"object"==e&&"number"==typeof t.length}function f(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var m="closure_uid_"+(1e9*Math.random()>>>0),g=0;function p(t,e,n){return t.call.apply(t.bind,arguments)}function y(t,e,n){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function w(t,e,n){return(w=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?p:y).apply(null,arguments)}function v(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function b(t,e){function n(){}n.prototype=e.prototype,t.$=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.ac=function(t,n,r){for(var s=Array(arguments.length-2),i=2;i<arguments.length;i++)s[i-2]=arguments[i];return e.prototype[n].apply(t,s)}}function I(){this.s=this.s,this.o=this.o}I.prototype.s=!1,I.prototype.sa=function(){var t;!this.s&&(this.s=!0,this.N(),0)&&(t=this,Object.prototype.hasOwnProperty.call(t,m)&&t[m]||(t[m]=++g))},I.prototype.N=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const _=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if("string"==typeof t)return"string"!=typeof e||1!=e.length?-1:t.indexOf(e,0);for(let n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1};function T(t){const e=t.length;if(0<e){const n=Array(e);for(let r=0;r<e;r++)n[r]=t[r];return n}return[]}function E(t,e){for(let e=1;e<arguments.length;e++){const n=arguments[e];if(d(n)){const e=t.length||0,r=n.length||0;t.length=e+r;for(let s=0;s<r;s++)t[e+s]=n[s]}else t.push(n)}}function S(t,e){this.type=t,this.g=this.target=e,this.defaultPrevented=!1}S.prototype.h=function(){this.defaultPrevented=!0};var x=function(){if(!h.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{const t=()=>{};h.addEventListener("test",t,e),h.removeEventListener("test",t,e)}catch(t){}return t}();function C(t){return/^[\s\xa0]*$/.test(t)}function D(){var t=h.navigator;return t&&(t=t.userAgent)?t:""}function A(t){return-1!=D().indexOf(t)}function N(t){return N[" "](t),t}N[" "]=function(){};var k,R,M,P=A("Opera"),L=A("Trident")||A("MSIE"),F=A("Edge"),O=F||L,V=A("Gecko")&&!(-1!=D().toLowerCase().indexOf("webkit")&&!A("Edge"))&&!(A("Trident")||A("MSIE"))&&!A("Edge"),q=-1!=D().toLowerCase().indexOf("webkit")&&!A("Edge");function U(){var t=h.document;return t?t.documentMode:void 0}t:{var B="",z=(R=D(),V?/rv:([^\);]+)(\)|;)/.exec(R):F?/Edge\/([\d\.]+)/.exec(R):L?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(R):q?/WebKit\/(\S+)/.exec(R):P?/(?:Version)[ \/]?(\S+)/.exec(R):void 0);if(z&&(B=z?z[1]:""),L){var K=U();if(null!=K&&K>parseFloat(B)){k=String(K);break t}}k=B}if(h.document&&L){var G=U();M=G||(parseInt(k,10)||void 0)}else M=void 0;var j=M;function $(t,e){if(S.call(this,t?t.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,t){var n=this.type=t.type,r=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.g=e,e=t.relatedTarget){if(V){t:{try{N(e.nodeName);var s=!0;break t}catch(t){}s=!1}s||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType="string"==typeof t.pointerType?t.pointerType:Q[t.pointerType]||"",this.state=t.state,this.i=t,t.defaultPrevented&&$.$.h.call(this)}}b($,S);var Q={2:"touch",3:"pen",4:"mouse"};$.prototype.h=function(){$.$.h.call(this);var t=this.i;t.preventDefault?t.preventDefault():t.returnValue=!1};var W="closure_listenable_"+(1e6*Math.random()|0),H=0;function Y(t,e,n,r,s){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.la=s,this.key=++H,this.fa=this.ia=!1}function X(t){t.fa=!0,t.listener=null,t.proxy=null,t.src=null,t.la=null}function J(t,e,n){for(const r in t)e.call(n,t[r],r,t)}function Z(t){const e={};for(const n in t)e[n]=t[n];return e}const tt="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function et(t,e){let n,r;for(let e=1;e<arguments.length;e++){for(n in r=arguments[e],r)t[n]=r[n];for(let e=0;e<tt.length;e++)n=tt[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function nt(t){this.src=t,this.g={},this.h=0}function rt(t,e){var n=e.type;if(n in t.g){var r,s=t.g[n],i=_(s,e);(r=0<=i)&&Array.prototype.splice.call(s,i,1),r&&(X(e),0==t.g[n].length&&(delete t.g[n],t.h--))}}function st(t,e,n,r){for(var s=0;s<t.length;++s){var i=t[s];if(!i.fa&&i.listener==e&&i.capture==!!n&&i.la==r)return s}return-1}nt.prototype.add=function(t,e,n,r,s){var i=t.toString();(t=this.g[i])||(t=this.g[i]=[],this.h++);var o=st(t,e,r,s);return-1<o?(e=t[o],n||(e.ia=!1)):((e=new Y(e,this.src,i,!!r,s)).ia=n,t.push(e)),e};var it="closure_lm_"+(1e6*Math.random()|0),ot={};function at(t,e,n,r,s){if(r&&r.once)return ct(t,e,n,r,s);if(Array.isArray(e)){for(var i=0;i<e.length;i++)at(t,e[i],n,r,s);return null}return n=pt(n),t&&t[W]?t.O(e,n,f(r)?!!r.capture:!!r,s):ut(t,e,n,!1,r,s)}function ut(t,e,n,r,s,i){if(!e)throw Error("Invalid event type");var o=f(s)?!!s.capture:!!s,a=mt(t);if(a||(t[it]=a=new nt(t)),(n=a.add(e,n,r,o,i)).proxy)return n;if(r=function(){function t(n){return e.call(t.src,t.listener,n)}const e=ft;return t}(),n.proxy=r,r.src=t,r.listener=n,t.addEventListener)x||(s=o),void 0===s&&(s=!1),t.addEventListener(e.toString(),r,s);else if(t.attachEvent)t.attachEvent(dt(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function ct(t,e,n,r,s){if(Array.isArray(e)){for(var i=0;i<e.length;i++)ct(t,e[i],n,r,s);return null}return n=pt(n),t&&t[W]?t.P(e,n,f(r)?!!r.capture:!!r,s):ut(t,e,n,!0,r,s)}function lt(t,e,n,r,s){if(Array.isArray(e))for(var i=0;i<e.length;i++)lt(t,e[i],n,r,s);else r=f(r)?!!r.capture:!!r,n=pt(n),t&&t[W]?(t=t.i,(e=String(e).toString())in t.g&&(-1<(n=st(i=t.g[e],n,r,s))&&(X(i[n]),Array.prototype.splice.call(i,n,1),0==i.length&&(delete t.g[e],t.h--)))):t&&(t=mt(t))&&(e=t.g[e.toString()],t=-1,e&&(t=st(e,n,r,s)),(n=-1<t?e[t]:null)&&ht(n))}function ht(t){if("number"!=typeof t&&t&&!t.fa){var e=t.src;if(e&&e[W])rt(e.i,t);else{var n=t.type,r=t.proxy;e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(dt(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=mt(e))?(rt(n,t),0==n.h&&(n.src=null,e[it]=null)):X(t)}}}function dt(t){return t in ot?ot[t]:ot[t]="on"+t}function ft(t,e){if(t.fa)t=!0;else{e=new $(e,this);var n=t.listener,r=t.la||t.src;t.ia&&ht(t),t=n.call(r,e)}return t}function mt(t){return(t=t[it])instanceof nt?t:null}var gt="__closure_events_fn_"+(1e9*Math.random()>>>0);function pt(t){return"function"==typeof t?t:(t[gt]||(t[gt]=function(e){return t.handleEvent(e)}),t[gt])}function yt(){I.call(this),this.i=new nt(this),this.S=this,this.J=null}function wt(t,e){var n,r=t.J;if(r)for(n=[];r;r=r.J)n.push(r);if(t=t.S,r=e.type||e,"string"==typeof e)e=new S(e,t);else if(e instanceof S)e.target=e.target||t;else{var s=e;et(e=new S(r,t),s)}if(s=!0,n)for(var i=n.length-1;0<=i;i--){var o=e.g=n[i];s=vt(o,r,!0,e)&&s}if(s=vt(o=e.g=t,r,!0,e)&&s,s=vt(o,r,!1,e)&&s,n)for(i=0;i<n.length;i++)s=vt(o=e.g=n[i],r,!1,e)&&s}function vt(t,e,n,r){if(!(e=t.i.g[String(e)]))return!0;e=e.concat();for(var s=!0,i=0;i<e.length;++i){var o=e[i];if(o&&!o.fa&&o.capture==n){var a=o.listener,u=o.la||o.src;o.ia&&rt(t.i,o),s=!1!==a.call(u,r)&&s}}return s&&!r.defaultPrevented}b(yt,I),yt.prototype[W]=!0,yt.prototype.removeEventListener=function(t,e,n,r){lt(this,t,e,n,r)},yt.prototype.N=function(){if(yt.$.N.call(this),this.i){var t,e=this.i;for(t in e.g){for(var n=e.g[t],r=0;r<n.length;r++)X(n[r]);delete e.g[t],e.h--}}this.J=null},yt.prototype.O=function(t,e,n,r){return this.i.add(String(t),e,!1,n,r)},yt.prototype.P=function(t,e,n,r){return this.i.add(String(t),e,!0,n,r)};var bt=h.JSON.stringify;function It(){var t=Dt;let e=null;return t.g&&(e=t.g,t.g=t.g.next,t.g||(t.h=null),e.next=null),e}var _t=new class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}}((()=>new Tt),(t=>t.reset()));class Tt{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}}function Et(t){var e=1;t=t.split(":");const n=[];for(;0<e&&t.length;)n.push(t.shift()),e--;return t.length&&n.push(t.join(":")),n}function St(t){h.setTimeout((()=>{throw t}),0)}let xt,Ct=!1,Dt=new class{constructor(){this.h=this.g=null}add(t,e){const n=_t.get();n.set(t,e),this.h?this.h.next=n:this.g=n,this.h=n}},At=()=>{const t=h.Promise.resolve(void 0);xt=()=>{t.then(Nt)}};var Nt=()=>{for(var t;t=It();){try{t.h.call(t.g)}catch(t){St(t)}var e=_t;e.j(t),100>e.h&&(e.h++,t.next=e.g,e.g=t)}Ct=!1};function kt(t,e){yt.call(this),this.h=t||1,this.g=e||h,this.j=w(this.qb,this),this.l=Date.now()}function Rt(t){t.ga=!1,t.T&&(t.g.clearTimeout(t.T),t.T=null)}function Mt(t,e,n){if("function"==typeof t)n&&(t=w(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=w(t.handleEvent,t)}return 2147483647<Number(e)?-1:h.setTimeout(t,e||0)}function Pt(t){t.g=Mt((()=>{t.g=null,t.i&&(t.i=!1,Pt(t))}),t.j);const e=t.h;t.h=null,t.m.apply(null,e)}b(kt,yt),(r=kt.prototype).ga=!1,r.T=null,r.qb=function(){if(this.ga){var t=Date.now()-this.l;0<t&&t<.8*this.h?this.T=this.g.setTimeout(this.j,this.h-t):(this.T&&(this.g.clearTimeout(this.T),this.T=null),wt(this,"tick"),this.ga&&(Rt(this),this.start()))}},r.start=function(){this.ga=!0,this.T||(this.T=this.g.setTimeout(this.j,this.h),this.l=Date.now())},r.N=function(){kt.$.N.call(this),Rt(this),delete this.g};class Lt extends I{constructor(t,e){super(),this.m=t,this.j=e,this.h=null,this.i=!1,this.g=null}l(t){this.h=arguments,this.g?this.i=!0:Pt(this)}N(){super.N(),this.g&&(h.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Ft(t){I.call(this),this.h=t,this.g={}}b(Ft,I);var Ot=[];function Vt(t,e,n,r){Array.isArray(n)||(n&&(Ot[0]=n.toString()),n=Ot);for(var s=0;s<n.length;s++){var i=at(e,n[s],r||t.handleEvent,!1,t.h||t);if(!i)break;t.g[i.key]=i}}function qt(t){J(t.g,(function(t,e){this.g.hasOwnProperty(e)&&ht(t)}),t),t.g={}}function Ut(){this.g=!0}function Bt(t,e,n,r){t.info((function(){return"XMLHTTP TEXT ("+e+"): "+function(t,e){if(!t.g)return e;if(!e)return null;try{var n=JSON.parse(e);if(n)for(t=0;t<n.length;t++)if(Array.isArray(n[t])){var r=n[t];if(!(2>r.length)){var s=r[1];if(Array.isArray(s)&&!(1>s.length)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<s.length;o++)s[o]=""}}}return bt(n)}catch(t){return e}}(t,n)+(r?" "+r:"")}))}Ft.prototype.N=function(){Ft.$.N.call(this),qt(this)},Ft.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},Ut.prototype.Ea=function(){this.g=!1},Ut.prototype.info=function(){};var zt={},Kt=null;function Gt(){return Kt=Kt||new yt}function jt(t){S.call(this,zt.Ta,t)}function $t(t){const e=Gt();wt(e,new jt(e))}function Qt(t,e){S.call(this,zt.STAT_EVENT,t),this.stat=e}function Wt(t){const e=Gt();wt(e,new Qt(e,t))}function Ht(t,e){S.call(this,zt.Ua,t),this.size=e}function Yt(t,e){if("function"!=typeof t)throw Error("Fn must not be null and must be a function");return h.setTimeout((function(){t()}),e)}zt.Ta="serverreachability",b(jt,S),zt.STAT_EVENT="statevent",b(Qt,S),zt.Ua="timingevent",b(Ht,S);var Xt={NO_ERROR:0,rb:1,Eb:2,Db:3,yb:4,Cb:5,Fb:6,Qa:7,TIMEOUT:8,Ib:9},Jt={wb:"complete",Sb:"success",Ra:"error",Qa:"abort",Kb:"ready",Lb:"readystatechange",TIMEOUT:"timeout",Gb:"incrementaldata",Jb:"progress",zb:"downloadprogress",$b:"uploadprogress"};function Zt(){}function te(t){return t.h||(t.h=t.i())}function ee(){}Zt.prototype.h=null;var ne,re={OPEN:"a",vb:"b",Ra:"c",Hb:"d"};function se(){S.call(this,"d")}function ie(){S.call(this,"c")}function oe(){}function ae(t,e,n,r){this.l=t,this.j=e,this.m=n,this.W=r||1,this.U=new Ft(this),this.P=ce,t=O?125:void 0,this.V=new kt(t),this.I=null,this.i=!1,this.u=this.B=this.A=this.L=this.G=this.Y=this.C=null,this.F=[],this.g=null,this.o=0,this.s=this.v=null,this.ca=-1,this.J=!1,this.O=0,this.M=null,this.ba=this.K=this.aa=this.S=!1,this.h=new ue}function ue(){this.i=null,this.g="",this.h=!1}b(se,S),b(ie,S),b(oe,Zt),oe.prototype.g=function(){return new XMLHttpRequest},oe.prototype.i=function(){return{}},ne=new oe;var ce=45e3,le={},he={};function de(t,e,n){t.L=1,t.A=ke(xe(e)),t.u=n,t.S=!0,fe(t,null)}function fe(t,e){t.G=Date.now(),ye(t),t.B=xe(t.A);var n=t.B,r=t.W;Array.isArray(r)||(r=[String(r)]),Ge(n.i,"t",r),t.o=0,n=t.l.J,t.h=new ue,t.g=jn(t.l,n?e:null,!t.u),0<t.O&&(t.M=new Lt(w(t.Pa,t,t.g),t.O)),Vt(t.U,t.g,"readystatechange",t.nb),e=t.I?Z(t.I):{},t.u?(t.v||(t.v="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.g.ha(t.B,t.v,t.u,e)):(t.v="GET",t.g.ha(t.B,t.v,null,e)),$t(),function(t,e,n,r,s,i){t.info((function(){if(t.g)if(i)for(var o="",a=i.split("&"),u=0;u<a.length;u++){var c=a[u].split("=");if(1<c.length){var l=c[0];c=c[1];var h=l.split("_");o=2<=h.length&&"type"==h[1]?o+(l+"=")+c+"&":o+(l+"=redacted&")}}else o=null;else o=i;return"XMLHTTP REQ ("+r+") [attempt "+s+"]: "+e+"\n"+n+"\n"+o}))}(t.j,t.v,t.B,t.m,t.W,t.u)}function me(t){return!!t.g&&("GET"==t.v&&2!=t.L&&t.l.Ha)}function ge(t,e,n){let r,s=!0;for(;!t.J&&t.o<n.length;){if(r=pe(t,n),r==he){4==e&&(t.s=4,Wt(14),s=!1),Bt(t.j,t.m,null,"[Incomplete Response]");break}if(r==le){t.s=4,Wt(15),Bt(t.j,t.m,n,"[Invalid Chunk]"),s=!1;break}Bt(t.j,t.m,r,null),_e(t,r)}me(t)&&0!=t.o&&(t.h.g=t.h.g.slice(t.o),t.o=0),4!=e||0!=n.length||t.h.h||(t.s=1,Wt(16),s=!1),t.i=t.i&&s,s?0<n.length&&!t.ba&&(t.ba=!0,(e=t.l).g==t&&e.ca&&!e.M&&(e.l.info("Great, no buffering proxy detected. Bytes received: "+n.length),On(e),e.M=!0,Wt(11))):(Bt(t.j,t.m,n,"[Invalid Chunked Response]"),Ie(t),be(t))}function pe(t,e){var n=t.o,r=e.indexOf("\n",n);return-1==r?he:(n=Number(e.substring(n,r)),isNaN(n)?le:(r+=1)+n>e.length?he:(e=e.slice(r,r+n),t.o=r+n,e))}function ye(t){t.Y=Date.now()+t.P,we(t,t.P)}function we(t,e){if(null!=t.C)throw Error("WatchDog timer not null");t.C=Yt(w(t.lb,t),e)}function ve(t){t.C&&(h.clearTimeout(t.C),t.C=null)}function be(t){0==t.l.H||t.J||Un(t.l,t)}function Ie(t){ve(t);var e=t.M;e&&"function"==typeof e.sa&&e.sa(),t.M=null,Rt(t.V),qt(t.U),t.g&&(e=t.g,t.g=null,e.abort(),e.sa())}function _e(t,e){try{var n=t.l;if(0!=n.H&&(n.g==t||Xe(n.i,t)))if(!t.K&&Xe(n.i,t)&&3==n.H){try{var r=n.Ja.g.parse(e)}catch(t){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){t:if(!n.u){if(n.g){if(!(n.g.G+3e3<t.G))break t;qn(n),An(n)}Fn(n),Wt(18)}}else n.Fa=s[1],0<n.Fa-n.V&&37500>s[2]&&n.G&&0==n.A&&!n.v&&(n.v=Yt(w(n.ib,n),6e3));if(1>=Ye(n.i)&&n.oa){try{n.oa()}catch(t){}n.oa=void 0}}else zn(n,11)}else if((t.K||n.g==t)&&qn(n),!C(e))for(s=n.Ja.g.parse(e),e=0;e<s.length;e++){let c=s[e];if(n.V=c[0],c=c[1],2==n.H)if("c"==c[0]){n.K=c[1],n.pa=c[2];const e=c[3];null!=e&&(n.ra=e,n.l.info("VER="+n.ra));const s=c[4];null!=s&&(n.Ga=s,n.l.info("SVER="+n.Ga));const l=c[5];null!=l&&"number"==typeof l&&0<l&&(r=1.5*l,n.L=r,n.l.info("backChannelRequestTimeoutMs_="+r)),r=n;const h=t.g;if(h){const t=h.g?h.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(t){var i=r.i;i.g||-1==t.indexOf("spdy")&&-1==t.indexOf("quic")&&-1==t.indexOf("h2")||(i.j=i.l,i.g=new Set,i.h&&(Je(i,i.h),i.h=null))}if(r.F){const t=h.g?h.g.getResponseHeader("X-HTTP-Session-Id"):null;t&&(r.Da=t,Ne(r.I,r.F,t))}}n.H=3,n.h&&n.h.Ba(),n.ca&&(n.S=Date.now()-t.G,n.l.info("Handshake RTT: "+n.S+"ms"));var o=t;if((r=n).wa=Gn(r,r.J?r.pa:null,r.Y),o.K){Ze(r.i,o);var a=o,u=r.L;u&&a.setTimeout(u),a.C&&(ve(a),ye(a)),r.g=o}else Ln(r);0<n.j.length&&kn(n)}else"stop"!=c[0]&&"close"!=c[0]||zn(n,7);else 3==n.H&&("stop"==c[0]||"close"==c[0]?"stop"==c[0]?zn(n,7):Dn(n):"noop"!=c[0]&&n.h&&n.h.Aa(c),n.A=0)}$t()}catch(t){}}function Te(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(d(t)||"string"==typeof t)Array.prototype.forEach.call(t,e,void 0);else for(var n=function(t){if(t.ta&&"function"==typeof t.ta)return t.ta();if(!t.Z||"function"!=typeof t.Z){if("undefined"!=typeof Map&&t instanceof Map)return Array.from(t.keys());if(!("undefined"!=typeof Set&&t instanceof Set)){if(d(t)||"string"==typeof t){var e=[];t=t.length;for(var n=0;n<t;n++)e.push(n);return e}e=[],n=0;for(const r in t)e[n++]=r;return e}}}(t),r=function(t){if(t.Z&&"function"==typeof t.Z)return t.Z();if("undefined"!=typeof Map&&t instanceof Map||"undefined"!=typeof Set&&t instanceof Set)return Array.from(t.values());if("string"==typeof t)return t.split("");if(d(t)){for(var e=[],n=t.length,r=0;r<n;r++)e.push(t[r]);return e}for(r in e=[],n=0,t)e[n++]=t[r];return e}(t),s=r.length,i=0;i<s;i++)e.call(void 0,r[i],n&&n[i],t)}(r=ae.prototype).setTimeout=function(t){this.P=t},r.nb=function(t){t=t.target;const e=this.M;e&&3==_n(t)?e.l():this.Pa(t)},r.Pa=function(t){try{if(t==this.g)t:{const l=_n(this.g);var e=this.g.Ia();this.g.da();if(!(3>l)&&(3!=l||O||this.g&&(this.h.h||this.g.ja()||Tn(this.g)))){this.J||4!=l||7==e||$t(),ve(this);var n=this.g.da();this.ca=n;e:if(me(this)){var r=Tn(this.g);t="";var s=r.length,i=4==_n(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){Ie(this),be(this);var o="";break e}this.h.i=new h.TextDecoder}for(e=0;e<s;e++)this.h.h=!0,t+=this.h.i.decode(r[e],{stream:i&&e==s-1});r.length=0,this.h.g+=t,this.o=0,o=this.h.g}else o=this.g.ja();if(this.i=200==n,function(t,e,n,r,s,i,o){t.info((function(){return"XMLHTTP RESP ("+r+") [ attempt "+s+"]: "+e+"\n"+n+"\n"+i+" "+o}))}(this.j,this.v,this.B,this.m,this.W,l,n),this.i){if(this.aa&&!this.K){e:{if(this.g){var a,u=this.g;if((a=u.g?u.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!C(a)){var c=a;break e}}c=null}if(!(n=c)){this.i=!1,this.s=3,Wt(12),Ie(this),be(this);break t}Bt(this.j,this.m,n,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,_e(this,n)}this.S?(ge(this,l,o),O&&this.i&&3==l&&(Vt(this.U,this.V,"tick",this.mb),this.V.start())):(Bt(this.j,this.m,o,null),_e(this,o)),4==l&&Ie(this),this.i&&!this.J&&(4==l?Un(this.l,this):(this.i=!1,ye(this)))}else(function(t){const e={};t=(t.g&&2<=_n(t)&&t.g.getAllResponseHeaders()||"").split("\r\n");for(let r=0;r<t.length;r++){if(C(t[r]))continue;var n=Et(t[r]);const s=n[0];if("string"!=typeof(n=n[1]))continue;n=n.trim();const i=e[s]||[];e[s]=i,i.push(n)}!function(t,e){for(const n in t)e.call(void 0,t[n],n,t)}(e,(function(t){return t.join(", ")}))})(this.g),400==n&&0<o.indexOf("Unknown SID")?(this.s=3,Wt(12)):(this.s=0,Wt(13)),Ie(this),be(this)}}}catch(t){}},r.mb=function(){if(this.g){var t=_n(this.g),e=this.g.ja();this.o<e.length&&(ve(this),ge(this,t,e),this.i&&4!=t&&ye(this))}},r.cancel=function(){this.J=!0,Ie(this)},r.lb=function(){this.C=null;const t=Date.now();0<=t-this.Y?(function(t,e){t.info((function(){return"TIMEOUT: "+e}))}(this.j,this.B),2!=this.L&&($t(),Wt(17)),Ie(this),this.s=2,be(this)):we(this,this.Y-t)};var Ee=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Se(t){if(this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,t instanceof Se){this.h=t.h,Ce(this,t.j),this.s=t.s,this.g=t.g,De(this,t.m),this.l=t.l;var e=t.i,n=new Ue;n.i=e.i,e.g&&(n.g=new Map(e.g),n.h=e.h),Ae(this,n),this.o=t.o}else t&&(e=String(t).match(Ee))?(this.h=!1,Ce(this,e[1]||"",!0),this.s=Re(e[2]||""),this.g=Re(e[3]||"",!0),De(this,e[4]),this.l=Re(e[5]||"",!0),Ae(this,e[6]||"",!0),this.o=Re(e[7]||"")):(this.h=!1,this.i=new Ue(null,this.h))}function xe(t){return new Se(t)}function Ce(t,e,n){t.j=n?Re(e,!0):e,t.j&&(t.j=t.j.replace(/:$/,""))}function De(t,e){if(e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);t.m=e}else t.m=null}function Ae(t,e,n){e instanceof Ue?(t.i=e,function(t,e){e&&!t.j&&(Be(t),t.i=null,t.g.forEach((function(t,e){var n=e.toLowerCase();e!=n&&(ze(this,e),Ge(this,n,t))}),t)),t.j=e}(t.i,t.h)):(n||(e=Me(e,Ve)),t.i=new Ue(e,t.h))}function Ne(t,e,n){t.i.set(e,n)}function ke(t){return Ne(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),t}function Re(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function Me(t,e,n){return"string"==typeof t?(t=encodeURI(t).replace(e,Pe),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function Pe(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}Se.prototype.toString=function(){var t=[],e=this.j;e&&t.push(Me(e,Le,!0),":");var n=this.g;return(n||"file"==e)&&(t.push("//"),(e=this.s)&&t.push(Me(e,Le,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&t.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&t.push("/"),t.push(Me(n,"/"==n.charAt(0)?Oe:Fe,!0))),(n=this.i.toString())&&t.push("?",n),(n=this.o)&&t.push("#",Me(n,qe)),t.join("")};var Le=/[#\/\?@]/g,Fe=/[#\?:]/g,Oe=/[#\?]/g,Ve=/[#\?@]/g,qe=/#/g;function Ue(t,e){this.h=this.g=null,this.i=t||null,this.j=!!e}function Be(t){t.g||(t.g=new Map,t.h=0,t.i&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r=t[n].indexOf("="),s=null;if(0<=r){var i=t[n].substring(0,r);s=t[n].substring(r+1)}else i=t[n];e(i,s?decodeURIComponent(s.replace(/\+/g," ")):"")}}}(t.i,(function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)})))}function ze(t,e){Be(t),e=je(t,e),t.g.has(e)&&(t.i=null,t.h-=t.g.get(e).length,t.g.delete(e))}function Ke(t,e){return Be(t),e=je(t,e),t.g.has(e)}function Ge(t,e,n){ze(t,e),0<n.length&&(t.i=null,t.g.set(je(t,e),T(n)),t.h+=n.length)}function je(t,e){return e=String(e),t.j&&(e=e.toLowerCase()),e}(r=Ue.prototype).add=function(t,e){Be(this),this.i=null,t=je(this,t);var n=this.g.get(t);return n||this.g.set(t,n=[]),n.push(e),this.h+=1,this},r.forEach=function(t,e){Be(this),this.g.forEach((function(n,r){n.forEach((function(n){t.call(e,n,r,this)}),this)}),this)},r.ta=function(){Be(this);const t=Array.from(this.g.values()),e=Array.from(this.g.keys()),n=[];for(let r=0;r<e.length;r++){const s=t[r];for(let t=0;t<s.length;t++)n.push(e[r])}return n},r.Z=function(t){Be(this);let e=[];if("string"==typeof t)Ke(this,t)&&(e=e.concat(this.g.get(je(this,t))));else{t=Array.from(this.g.values());for(let n=0;n<t.length;n++)e=e.concat(t[n])}return e},r.set=function(t,e){return Be(this),this.i=null,Ke(this,t=je(this,t))&&(this.h-=this.g.get(t).length),this.g.set(t,[e]),this.h+=1,this},r.get=function(t,e){return t&&0<(t=this.Z(t)).length?String(t[0]):e},r.toString=function(){if(this.i)return this.i;if(!this.g)return"";const t=[],e=Array.from(this.g.keys());for(var n=0;n<e.length;n++){var r=e[n];const i=encodeURIComponent(String(r)),o=this.Z(r);for(r=0;r<o.length;r++){var s=i;""!==o[r]&&(s+="="+encodeURIComponent(String(o[r]))),t.push(s)}}return this.i=t.join("&")};var $e=class{constructor(t,e){this.g=t,this.map=e}};function Qe(t){this.l=t||We,h.PerformanceNavigationTiming?t=0<(t=h.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):t=!!(h.g&&h.g.Ka&&h.g.Ka()&&h.g.Ka().dc),this.j=t?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var We=10;function He(t){return!!t.h||!!t.g&&t.g.size>=t.j}function Ye(t){return t.h?1:t.g?t.g.size:0}function Xe(t,e){return t.h?t.h==e:!!t.g&&t.g.has(e)}function Je(t,e){t.g?t.g.add(e):t.h=e}function Ze(t,e){t.h&&t.h==e?t.h=null:t.g&&t.g.has(e)&&t.g.delete(e)}function tn(t){if(null!=t.h)return t.i.concat(t.h.F);if(null!=t.g&&0!==t.g.size){let e=t.i;for(const n of t.g.values())e=e.concat(n.F);return e}return T(t.i)}Qe.prototype.cancel=function(){if(this.i=tn(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const t of this.g.values())t.cancel();this.g.clear()}};var en=class{stringify(t){return h.JSON.stringify(t,void 0)}parse(t){return h.JSON.parse(t,void 0)}};function nn(){this.g=new en}function rn(t,e,n){const r=n||"";try{Te(t,(function(t,n){let s=t;f(t)&&(s=bt(t)),e.push(r+n+"="+encodeURIComponent(s))}))}catch(t){throw e.push(r+"type="+encodeURIComponent("_badmap")),t}}function sn(t,e,n,r,s){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,s(r)}catch(t){}}function on(t){this.l=t.ec||null,this.j=t.ob||!1}function an(t,e){yt.call(this),this.F=t,this.u=e,this.m=void 0,this.readyState=un,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}b(on,Zt),on.prototype.g=function(){return new an(this.l,this.j)},on.prototype.i=function(t){return function(){return t}}({}),b(an,yt);var un=0;function cn(t){t.j.read().then(t.Xa.bind(t)).catch(t.ka.bind(t))}function ln(t){t.readyState=4,t.l=null,t.j=null,t.A=null,hn(t)}function hn(t){t.onreadystatechange&&t.onreadystatechange.call(t)}(r=an.prototype).open=function(t,e){if(this.readyState!=un)throw this.abort(),Error("Error reopening a connection");this.C=t,this.B=e,this.readyState=1,hn(this)},r.send=function(t){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const e={headers:this.v,method:this.C,credentials:this.m,cache:void 0};t&&(e.body=t),(this.F||h).fetch(new Request(this.B,e)).then(this.$a.bind(this),this.ka.bind(this))},r.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch((()=>{})),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,ln(this)),this.readyState=un},r.$a=function(t){if(this.g&&(this.l=t,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=t.headers,this.readyState=2,hn(this)),this.g&&(this.readyState=3,hn(this),this.g)))if("arraybuffer"===this.responseType)t.arrayBuffer().then(this.Ya.bind(this),this.ka.bind(this));else if(void 0!==h.ReadableStream&&"body"in t){if(this.j=t.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;cn(this)}else t.text().then(this.Za.bind(this),this.ka.bind(this))},r.Xa=function(t){if(this.g){if(this.u&&t.value)this.response.push(t.value);else if(!this.u){var e=t.value?t.value:new Uint8Array(0);(e=this.A.decode(e,{stream:!t.done}))&&(this.response=this.responseText+=e)}t.done?ln(this):hn(this),3==this.readyState&&cn(this)}},r.Za=function(t){this.g&&(this.response=this.responseText=t,ln(this))},r.Ya=function(t){this.g&&(this.response=t,ln(this))},r.ka=function(){this.g&&ln(this)},r.setRequestHeader=function(t,e){this.v.append(t,e)},r.getResponseHeader=function(t){return this.h&&this.h.get(t.toLowerCase())||""},r.getAllResponseHeaders=function(){if(!this.h)return"";const t=[],e=this.h.entries();for(var n=e.next();!n.done;)n=n.value,t.push(n[0]+": "+n[1]),n=e.next();return t.join("\r\n")},Object.defineProperty(an.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(t){this.m=t?"include":"same-origin"}});var dn=h.JSON.parse;function fn(t){yt.call(this),this.headers=new Map,this.u=t||null,this.h=!1,this.C=this.g=null,this.I="",this.m=0,this.j="",this.l=this.G=this.v=this.F=!1,this.B=0,this.A=null,this.K=mn,this.L=this.M=!1}b(fn,yt);var mn="",gn=/^https?$/i,pn=["POST","PUT"];function yn(t,e){t.h=!1,t.g&&(t.l=!0,t.g.abort(),t.l=!1),t.j=e,t.m=5,wn(t),bn(t)}function wn(t){t.F||(t.F=!0,wt(t,"complete"),wt(t,"error"))}function vn(t){if(t.h&&void 0!==l&&(!t.C[1]||4!=_n(t)||2!=t.da()))if(t.v&&4==_n(t))Mt(t.La,0,t);else if(wt(t,"readystatechange"),4==_n(t)){t.h=!1;try{const o=t.da();t:switch(o){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var e=!0;break t;default:e=!1}var n;if(!(n=e)){var r;if(r=0===o){var s=String(t.I).match(Ee)[1]||null;!s&&h.self&&h.self.location&&(s=h.self.location.protocol.slice(0,-1)),r=!gn.test(s?s.toLowerCase():"")}n=r}if(n)wt(t,"complete"),wt(t,"success");else{t.m=6;try{var i=2<_n(t)?t.g.statusText:""}catch(t){i=""}t.j=i+" ["+t.da()+"]",wn(t)}}finally{bn(t)}}}function bn(t,e){if(t.g){In(t);const n=t.g,r=t.C[0]?()=>{}:null;t.g=null,t.C=null,e||wt(t,"ready");try{n.onreadystatechange=r}catch(t){}}}function In(t){t.g&&t.L&&(t.g.ontimeout=null),t.A&&(h.clearTimeout(t.A),t.A=null)}function _n(t){return t.g?t.g.readyState:0}function Tn(t){try{if(!t.g)return null;if("response"in t.g)return t.g.response;switch(t.K){case mn:case"text":return t.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in t.g)return t.g.mozResponseArrayBuffer}return null}catch(t){return null}}function En(t){let e="";return J(t,(function(t,n){e+=n,e+=":",e+=t,e+="\r\n"})),e}function Sn(t,e,n){t:{for(r in n){var r=!1;break t}r=!0}r||(n=En(n),"string"==typeof t?null!=n&&encodeURIComponent(String(n)):Ne(t,e,n))}function xn(t,e,n){return n&&n.internalChannelParams&&n.internalChannelParams[t]||e}function Cn(t){this.Ga=0,this.j=[],this.l=new Ut,this.pa=this.wa=this.I=this.Y=this.g=this.Da=this.F=this.na=this.o=this.U=this.s=null,this.fb=this.W=0,this.cb=xn("failFast",!1,t),this.G=this.v=this.u=this.m=this.h=null,this.aa=!0,this.Fa=this.V=-1,this.ba=this.A=this.C=0,this.ab=xn("baseRetryDelayMs",5e3,t),this.hb=xn("retryDelaySeedMs",1e4,t),this.eb=xn("forwardChannelMaxRetries",2,t),this.xa=xn("forwardChannelRequestTimeoutMs",2e4,t),this.va=t&&t.xmlHttpFactory||void 0,this.Ha=t&&t.useFetchStreams||!1,this.L=void 0,this.J=t&&t.supportsCrossDomainXhr||!1,this.K="",this.i=new Qe(t&&t.concurrentRequestLimit),this.Ja=new nn,this.P=t&&t.fastHandshake||!1,this.O=t&&t.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.bb=t&&t.bc||!1,t&&t.Ea&&this.l.Ea(),t&&t.forceLongPolling&&(this.aa=!1),this.ca=!this.P&&this.aa&&t&&t.detectBufferingProxy||!1,this.qa=void 0,t&&t.longPollingTimeout&&0<t.longPollingTimeout&&(this.qa=t.longPollingTimeout),this.oa=void 0,this.S=0,this.M=!1,this.ma=this.B=null}function Dn(t){if(Nn(t),3==t.H){var e=t.W++,n=xe(t.I);if(Ne(n,"SID",t.K),Ne(n,"RID",e),Ne(n,"TYPE","terminate"),Mn(t,n),(e=new ae(t,t.l,e)).L=2,e.A=ke(xe(n)),n=!1,h.navigator&&h.navigator.sendBeacon)try{n=h.navigator.sendBeacon(e.A.toString(),"")}catch(t){}!n&&h.Image&&((new Image).src=e.A,n=!0),n||(e.g=jn(e.l,null),e.g.ha(e.A)),e.G=Date.now(),ye(e)}Kn(t)}function An(t){t.g&&(On(t),t.g.cancel(),t.g=null)}function Nn(t){An(t),t.u&&(h.clearTimeout(t.u),t.u=null),qn(t),t.i.cancel(),t.m&&("number"==typeof t.m&&h.clearTimeout(t.m),t.m=null)}function kn(t){if(!He(t.i)&&!t.m){t.m=!0;var e=t.Na;xt||At(),Ct||(xt(),Ct=!0),Dt.add(e,t),t.C=0}}function Rn(t,e){var n;n=e?e.m:t.W++;const r=xe(t.I);Ne(r,"SID",t.K),Ne(r,"RID",n),Ne(r,"AID",t.V),Mn(t,r),t.o&&t.s&&Sn(r,t.o,t.s),n=new ae(t,t.l,n,t.C+1),null===t.o&&(n.I=t.s),e&&(t.j=e.F.concat(t.j)),e=Pn(t,n,1e3),n.setTimeout(Math.round(.5*t.xa)+Math.round(.5*t.xa*Math.random())),Je(t.i,n),de(n,r,e)}function Mn(t,e){t.na&&J(t.na,(function(t,n){Ne(e,n,t)})),t.h&&Te({},(function(t,n){Ne(e,n,t)}))}function Pn(t,e,n){n=Math.min(t.j.length,n);var r=t.h?w(t.h.Va,t.h,t):null;t:{var s=t.j;let e=-1;for(;;){const t=["count="+n];-1==e?0<n?(e=s[0].g,t.push("ofs="+e)):e=0:t.push("ofs="+e);let i=!0;for(let o=0;o<n;o++){let n=s[o].g;const a=s[o].map;if(n-=e,0>n)e=Math.max(0,s[o].g-100),i=!1;else try{rn(a,t,"req"+n+"_")}catch(t){r&&r(a)}}if(i){r=t.join("&");break t}}}return t=t.j.splice(0,n),e.F=t,r}function Ln(t){if(!t.g&&!t.u){t.ba=1;var e=t.Ma;xt||At(),Ct||(xt(),Ct=!0),Dt.add(e,t),t.A=0}}function Fn(t){return!(t.g||t.u||3<=t.A)&&(t.ba++,t.u=Yt(w(t.Ma,t),Bn(t,t.A)),t.A++,!0)}function On(t){null!=t.B&&(h.clearTimeout(t.B),t.B=null)}function Vn(t){t.g=new ae(t,t.l,"rpc",t.ba),null===t.o&&(t.g.I=t.s),t.g.O=0;var e=xe(t.wa);Ne(e,"RID","rpc"),Ne(e,"SID",t.K),Ne(e,"AID",t.V),Ne(e,"CI",t.G?"0":"1"),!t.G&&t.qa&&Ne(e,"TO",t.qa),Ne(e,"TYPE","xmlhttp"),Mn(t,e),t.o&&t.s&&Sn(e,t.o,t.s),t.L&&t.g.setTimeout(t.L);var n=t.g;t=t.pa,n.L=1,n.A=ke(xe(e)),n.u=null,n.S=!0,fe(n,t)}function qn(t){null!=t.v&&(h.clearTimeout(t.v),t.v=null)}function Un(t,e){var n=null;if(t.g==e){qn(t),On(t),t.g=null;var r=2}else{if(!Xe(t.i,e))return;n=e.F,Ze(t.i,e),r=1}if(0!=t.H)if(e.i)if(1==r){n=e.u?e.u.length:0,e=Date.now()-e.G;var s=t.C;wt(r=Gt(),new Ht(r,n)),kn(t)}else Ln(t);else if(3==(s=e.s)||0==s&&0<e.ca||!(1==r&&function(t,e){return!(Ye(t.i)>=t.i.j-(t.m?1:0)||(t.m?(t.j=e.F.concat(t.j),0):1==t.H||2==t.H||t.C>=(t.cb?0:t.eb)||(t.m=Yt(w(t.Na,t,e),Bn(t,t.C)),t.C++,0)))}(t,e)||2==r&&Fn(t)))switch(n&&0<n.length&&(e=t.i,e.i=e.i.concat(n)),s){case 1:zn(t,5);break;case 4:zn(t,10);break;case 3:zn(t,6);break;default:zn(t,2)}}function Bn(t,e){let n=t.ab+Math.floor(Math.random()*t.hb);return t.isActive()||(n*=2),n*e}function zn(t,e){if(t.l.info("Error code "+e),2==e){var n=null;t.h&&(n=null);var r=w(t.pb,t);n||(n=new Se("//www.google.com/images/cleardot.gif"),h.location&&"http"==h.location.protocol||Ce(n,"https"),ke(n)),function(t,e){const n=new Ut;if(h.Image){const r=new Image;r.onload=v(sn,n,r,"TestLoadImage: loaded",!0,e),r.onerror=v(sn,n,r,"TestLoadImage: error",!1,e),r.onabort=v(sn,n,r,"TestLoadImage: abort",!1,e),r.ontimeout=v(sn,n,r,"TestLoadImage: timeout",!1,e),h.setTimeout((function(){r.ontimeout&&r.ontimeout()}),1e4),r.src=t}else e(!1)}(n.toString(),r)}else Wt(2);t.H=0,t.h&&t.h.za(e),Kn(t),Nn(t)}function Kn(t){if(t.H=0,t.ma=[],t.h){const e=tn(t.i);0==e.length&&0==t.j.length||(E(t.ma,e),E(t.ma,t.j),t.i.i.length=0,T(t.j),t.j.length=0),t.h.ya()}}function Gn(t,e,n){var r=n instanceof Se?xe(n):new Se(n);if(""!=r.g)e&&(r.g=e+"."+r.g),De(r,r.m);else{var s=h.location;r=s.protocol,e=e?e+"."+s.hostname:s.hostname,s=+s.port;var i=new Se(null);r&&Ce(i,r),e&&(i.g=e),s&&De(i,s),n&&(i.l=n),r=i}return n=t.F,e=t.Da,n&&e&&Ne(r,n,e),Ne(r,"VER",t.ra),Mn(t,r),r}function jn(t,e,n){if(e&&!t.J)throw Error("Can't create secondary domain capable XhrIo object.");return(e=t.Ha&&!t.va?new fn(new on({ob:n})):new fn(t.va)).Oa(t.J),e}function $n(){}function Qn(){if(L&&!(10<=Number(j)))throw Error("Environmental error: no available transport.")}function Wn(t,e){yt.call(this),this.g=new Cn(e),this.l=t,this.h=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.g.s=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.Ca&&(t?t["X-WebChannel-Client-Profile"]=e.Ca:t={"X-WebChannel-Client-Profile":e.Ca}),this.g.U=t,(t=e&&e.cc)&&!C(t)&&(this.g.o=t),this.A=e&&e.supportsCrossDomainXhr||!1,this.v=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!C(e)&&(this.g.F=e,null!==(t=this.h)&&e in t&&(e in(t=this.h)&&delete t[e])),this.j=new Xn(this)}function Hn(t){se.call(this),t.__headers__&&(this.headers=t.__headers__,this.statusCode=t.__status__,delete t.__headers__,delete t.__status__);var e=t.__sm__;if(e){t:{for(const n in e){t=n;break t}t=void 0}(this.i=t)&&(t=this.i,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function Yn(){ie.call(this),this.status=1}function Xn(t){this.g=t}function Jn(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.m=Array(this.blockSize),this.i=this.h=0,this.reset()}function Zn(t,e,n){n||(n=0);var r=Array(16);if("string"==typeof e)for(var s=0;16>s;++s)r[s]=e.charCodeAt(n++)|e.charCodeAt(n++)<<8|e.charCodeAt(n++)<<16|e.charCodeAt(n++)<<24;else for(s=0;16>s;++s)r[s]=e[n++]|e[n++]<<8|e[n++]<<16|e[n++]<<24;e=t.g[0],n=t.g[1],s=t.g[2];var i=t.g[3],o=e+(i^n&(s^i))+r[0]+3614090360&4294967295;o=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=n+(o<<7&4294967295|o>>>25))+((o=i+(s^e&(n^s))+r[1]+3905402710&4294967295)<<12&4294967295|o>>>20))+((o=s+(n^i&(e^n))+r[2]+606105819&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^s&(i^e))+r[3]+3250441966&4294967295)<<22&4294967295|o>>>10))+((o=e+(i^n&(s^i))+r[4]+4118548399&4294967295)<<7&4294967295|o>>>25))+((o=i+(s^e&(n^s))+r[5]+1200080426&4294967295)<<12&4294967295|o>>>20))+((o=s+(n^i&(e^n))+r[6]+2821735955&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^s&(i^e))+r[7]+4249261313&4294967295)<<22&4294967295|o>>>10))+((o=e+(i^n&(s^i))+r[8]+1770035416&4294967295)<<7&4294967295|o>>>25))+((o=i+(s^e&(n^s))+r[9]+2336552879&4294967295)<<12&4294967295|o>>>20))+((o=s+(n^i&(e^n))+r[10]+4294925233&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^s&(i^e))+r[11]+2304563134&4294967295)<<22&4294967295|o>>>10))+((o=e+(i^n&(s^i))+r[12]+1804603682&4294967295)<<7&4294967295|o>>>25))+((o=i+(s^e&(n^s))+r[13]+4254626195&4294967295)<<12&4294967295|o>>>20))+((o=s+(n^i&(e^n))+r[14]+2792965006&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^s&(i^e))+r[15]+1236535329&4294967295)<<22&4294967295|o>>>10))+((o=e+(s^i&(n^s))+r[1]+4129170786&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^s&(e^n))+r[6]+3225465664&4294967295)<<9&4294967295|o>>>23))+((o=s+(e^n&(i^e))+r[11]+643717713&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(s^i))+r[0]+3921069994&4294967295)<<20&4294967295|o>>>12))+((o=e+(s^i&(n^s))+r[5]+3593408605&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^s&(e^n))+r[10]+38016083&4294967295)<<9&4294967295|o>>>23))+((o=s+(e^n&(i^e))+r[15]+3634488961&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(s^i))+r[4]+3889429448&4294967295)<<20&4294967295|o>>>12))+((o=e+(s^i&(n^s))+r[9]+568446438&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^s&(e^n))+r[14]+3275163606&4294967295)<<9&4294967295|o>>>23))+((o=s+(e^n&(i^e))+r[3]+4107603335&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(s^i))+r[8]+1163531501&4294967295)<<20&4294967295|o>>>12))+((o=e+(s^i&(n^s))+r[13]+2850285829&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^s&(e^n))+r[2]+4243563512&4294967295)<<9&4294967295|o>>>23))+((o=s+(e^n&(i^e))+r[7]+1735328473&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(s^i))+r[12]+2368359562&4294967295)<<20&4294967295|o>>>12))+((o=e+(n^s^i)+r[5]+4294588738&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^s)+r[8]+2272392833&4294967295)<<11&4294967295|o>>>21))+((o=s+(i^e^n)+r[11]+1839030562&4294967295)<<16&4294967295|o>>>16))+((o=n+(s^i^e)+r[14]+4259657740&4294967295)<<23&4294967295|o>>>9))+((o=e+(n^s^i)+r[1]+2763975236&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^s)+r[4]+1272893353&4294967295)<<11&4294967295|o>>>21))+((o=s+(i^e^n)+r[7]+4139469664&4294967295)<<16&4294967295|o>>>16))+((o=n+(s^i^e)+r[10]+3200236656&4294967295)<<23&4294967295|o>>>9))+((o=e+(n^s^i)+r[13]+681279174&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^s)+r[0]+3936430074&4294967295)<<11&4294967295|o>>>21))+((o=s+(i^e^n)+r[3]+3572445317&4294967295)<<16&4294967295|o>>>16))+((o=n+(s^i^e)+r[6]+76029189&4294967295)<<23&4294967295|o>>>9))+((o=e+(n^s^i)+r[9]+3654602809&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^s)+r[12]+3873151461&4294967295)<<11&4294967295|o>>>21))+((o=s+(i^e^n)+r[15]+530742520&4294967295)<<16&4294967295|o>>>16))+((o=n+(s^i^e)+r[2]+3299628645&4294967295)<<23&4294967295|o>>>9))+((o=e+(s^(n|~i))+r[0]+4096336452&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~s))+r[7]+1126891415&4294967295)<<10&4294967295|o>>>22))+((o=s+(e^(i|~n))+r[14]+2878612391&4294967295)<<15&4294967295|o>>>17))+((o=n+(i^(s|~e))+r[5]+4237533241&4294967295)<<21&4294967295|o>>>11))+((o=e+(s^(n|~i))+r[12]+1700485571&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~s))+r[3]+2399980690&4294967295)<<10&4294967295|o>>>22))+((o=s+(e^(i|~n))+r[10]+4293915773&4294967295)<<15&4294967295|o>>>17))+((o=n+(i^(s|~e))+r[1]+2240044497&4294967295)<<21&4294967295|o>>>11))+((o=e+(s^(n|~i))+r[8]+1873313359&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~s))+r[15]+4264355552&4294967295)<<10&4294967295|o>>>22))+((o=s+(e^(i|~n))+r[6]+2734768916&4294967295)<<15&4294967295|o>>>17))+((o=n+(i^(s|~e))+r[13]+1309151649&4294967295)<<21&4294967295|o>>>11))+((i=(e=n+((o=e+(s^(n|~i))+r[4]+4149444226&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~s))+r[11]+3174756917&4294967295)<<10&4294967295|o>>>22))^((s=i+((o=s+(e^(i|~n))+r[2]+718787259&4294967295)<<15&4294967295|o>>>17))|~e))+r[9]+3951481745&4294967295,t.g[0]=t.g[0]+e&4294967295,t.g[1]=t.g[1]+(s+(o<<21&4294967295|o>>>11))&4294967295,t.g[2]=t.g[2]+s&4294967295,t.g[3]=t.g[3]+i&4294967295}function tr(t,e){this.h=e;for(var n=[],r=!0,s=t.length-1;0<=s;s--){var i=0|t[s];r&&i==e||(n[s]=i,r=!1)}this.g=n}(r=fn.prototype).Oa=function(t){this.M=t},r.ha=function(t,e,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.I+"; newUri="+t);e=e?e.toUpperCase():"GET",this.I=t,this.j="",this.m=0,this.F=!1,this.h=!0,this.g=this.u?this.u.g():ne.g(),this.C=this.u?te(this.u):te(ne),this.g.onreadystatechange=w(this.La,this);try{this.G=!0,this.g.open(e,String(t),!0),this.G=!1}catch(t){return void yn(this,t)}if(t=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var s in r)n.set(s,r[s]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const t of r.keys())n.set(t,r.get(t))}r=Array.from(n.keys()).find((t=>"content-type"==t.toLowerCase())),s=h.FormData&&t instanceof h.FormData,!(0<=_(pn,e))||r||s||n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[t,e]of n)this.g.setRequestHeader(t,e);this.K&&(this.g.responseType=this.K),"withCredentials"in this.g&&this.g.withCredentials!==this.M&&(this.g.withCredentials=this.M);try{In(this),0<this.B&&((this.L=function(t){return L&&"number"==typeof t.timeout&&void 0!==t.ontimeout}(this.g))?(this.g.timeout=this.B,this.g.ontimeout=w(this.ua,this)):this.A=Mt(this.ua,this.B,this)),this.v=!0,this.g.send(t),this.v=!1}catch(t){yn(this,t)}},r.ua=function(){void 0!==l&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,wt(this,"timeout"),this.abort(8))},r.abort=function(t){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=t||7,wt(this,"complete"),wt(this,"abort"),bn(this))},r.N=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),bn(this,!0)),fn.$.N.call(this)},r.La=function(){this.s||(this.G||this.v||this.l?vn(this):this.kb())},r.kb=function(){vn(this)},r.isActive=function(){return!!this.g},r.da=function(){try{return 2<_n(this)?this.g.status:-1}catch(t){return-1}},r.ja=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},r.Wa=function(t){if(this.g){var e=this.g.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),dn(e)}},r.Ia=function(){return this.m},r.Sa=function(){return"string"==typeof this.j?this.j:String(this.j)},(r=Cn.prototype).ra=8,r.H=1,r.Na=function(t){if(this.m)if(this.m=null,1==this.H){if(!t){this.W=Math.floor(1e5*Math.random()),t=this.W++;const s=new ae(this,this.l,t);let i=this.s;if(this.U&&(i?(i=Z(i),et(i,this.U)):i=this.U),null!==this.o||this.O||(s.I=i,i=null),this.P)t:{for(var e=0,n=0;n<this.j.length;n++){var r=this.j[n];if(void 0===(r="__data__"in r.map&&"string"==typeof(r=r.map.__data__)?r.length:void 0))break;if(4096<(e+=r)){e=n;break t}if(4096===e||n===this.j.length-1){e=n+1;break t}}e=1e3}else e=1e3;e=Pn(this,s,e),Ne(n=xe(this.I),"RID",t),Ne(n,"CVER",22),this.F&&Ne(n,"X-HTTP-Session-Id",this.F),Mn(this,n),i&&(this.O?e="headers="+encodeURIComponent(String(En(i)))+"&"+e:this.o&&Sn(n,this.o,i)),Je(this.i,s),this.bb&&Ne(n,"TYPE","init"),this.P?(Ne(n,"$req",e),Ne(n,"SID","null"),s.aa=!0,de(s,n,null)):de(s,n,e),this.H=2}}else 3==this.H&&(t?Rn(this,t):0==this.j.length||He(this.i)||Rn(this))},r.Ma=function(){if(this.u=null,Vn(this),this.ca&&!(this.M||null==this.g||0>=this.S)){var t=2*this.S;this.l.info("BP detection timer enabled: "+t),this.B=Yt(w(this.jb,this),t)}},r.jb=function(){this.B&&(this.B=null,this.l.info("BP detection timeout reached."),this.l.info("Buffering proxy detected and switch to long-polling!"),this.G=!1,this.M=!0,Wt(10),An(this),Vn(this))},r.ib=function(){null!=this.v&&(this.v=null,An(this),Fn(this),Wt(19))},r.pb=function(t){t?(this.l.info("Successfully pinged google.com"),Wt(2)):(this.l.info("Failed to ping google.com"),Wt(1))},r.isActive=function(){return!!this.h&&this.h.isActive(this)},(r=$n.prototype).Ba=function(){},r.Aa=function(){},r.za=function(){},r.ya=function(){},r.isActive=function(){return!0},r.Va=function(){},Qn.prototype.g=function(t,e){return new Wn(t,e)},b(Wn,yt),Wn.prototype.m=function(){this.g.h=this.j,this.A&&(this.g.J=!0);var t=this.g,e=this.l,n=this.h||void 0;Wt(0),t.Y=e,t.na=n||{},t.G=t.aa,t.I=Gn(t,null,t.Y),kn(t)},Wn.prototype.close=function(){Dn(this.g)},Wn.prototype.u=function(t){var e=this.g;if("string"==typeof t){var n={};n.__data__=t,t=n}else this.v&&((n={}).__data__=bt(t),t=n);e.j.push(new $e(e.fb++,t)),3==e.H&&kn(e)},Wn.prototype.N=function(){this.g.h=null,delete this.j,Dn(this.g),delete this.g,Wn.$.N.call(this)},b(Hn,se),b(Yn,ie),b(Xn,$n),Xn.prototype.Ba=function(){wt(this.g,"a")},Xn.prototype.Aa=function(t){wt(this.g,new Hn(t))},Xn.prototype.za=function(t){wt(this.g,new Yn)},Xn.prototype.ya=function(){wt(this.g,"b")},b(Jn,(function(){this.blockSize=-1})),Jn.prototype.reset=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.i=this.h=0},Jn.prototype.j=function(t,e){void 0===e&&(e=t.length);for(var n=e-this.blockSize,r=this.m,s=this.h,i=0;i<e;){if(0==s)for(;i<=n;)Zn(this,t,i),i+=this.blockSize;if("string"==typeof t){for(;i<e;)if(r[s++]=t.charCodeAt(i++),s==this.blockSize){Zn(this,r),s=0;break}}else for(;i<e;)if(r[s++]=t[i++],s==this.blockSize){Zn(this,r),s=0;break}}this.h=s,this.i+=e},Jn.prototype.l=function(){var t=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);t[0]=128;for(var e=1;e<t.length-8;++e)t[e]=0;var n=8*this.i;for(e=t.length-8;e<t.length;++e)t[e]=255&n,n/=256;for(this.j(t),t=Array(16),e=n=0;4>e;++e)for(var r=0;32>r;r+=8)t[n++]=this.g[e]>>>r&255;return t};var er={};function nr(t){return-128<=t&&128>t?function(t,e){var n=er;return Object.prototype.hasOwnProperty.call(n,t)?n[t]:n[t]=e(t)}(t,(function(t){return new tr([0|t],0>t?-1:0)})):new tr([0|t],0>t?-1:0)}function rr(t){if(isNaN(t)||!isFinite(t))return ir;if(0>t)return lr(rr(-t));for(var e=[],n=1,r=0;t>=n;r++)e[r]=t/n|0,n*=sr;return new tr(e,0)}var sr=4294967296,ir=nr(0),or=nr(1),ar=nr(16777216);function ur(t){if(0!=t.h)return!1;for(var e=0;e<t.g.length;e++)if(0!=t.g[e])return!1;return!0}function cr(t){return-1==t.h}function lr(t){for(var e=t.g.length,n=[],r=0;r<e;r++)n[r]=~t.g[r];return new tr(n,~t.h).add(or)}function hr(t,e){return t.add(lr(e))}function dr(t,e){for(;(65535&t[e])!=t[e];)t[e+1]+=t[e]>>>16,t[e]&=65535,e++}function fr(t,e){this.g=t,this.h=e}function mr(t,e){if(ur(e))throw Error("division by zero");if(ur(t))return new fr(ir,ir);if(cr(t))return e=mr(lr(t),e),new fr(lr(e.g),lr(e.h));if(cr(e))return e=mr(t,lr(e)),new fr(lr(e.g),e.h);if(30<t.g.length){if(cr(t)||cr(e))throw Error("slowDivide_ only works with positive integers.");for(var n=or,r=e;0>=r.X(t);)n=gr(n),r=gr(r);var s=pr(n,1),i=pr(r,1);for(r=pr(r,2),n=pr(n,2);!ur(r);){var o=i.add(r);0>=o.X(t)&&(s=s.add(n),i=o),r=pr(r,1),n=pr(n,1)}return e=hr(t,s.R(e)),new fr(s,e)}for(s=ir;0<=t.X(e);){for(n=Math.max(1,Math.floor(t.ea()/e.ea())),r=48>=(r=Math.ceil(Math.log(n)/Math.LN2))?1:Math.pow(2,r-48),o=(i=rr(n)).R(e);cr(o)||0<o.X(t);)o=(i=rr(n-=r)).R(e);ur(i)&&(i=or),s=s.add(i),t=hr(t,o)}return new fr(s,t)}function gr(t){for(var e=t.g.length+1,n=[],r=0;r<e;r++)n[r]=t.D(r)<<1|t.D(r-1)>>>31;return new tr(n,t.h)}function pr(t,e){var n=e>>5;e%=32;for(var r=t.g.length-n,s=[],i=0;i<r;i++)s[i]=0<e?t.D(i+n)>>>e|t.D(i+n+1)<<32-e:t.D(i+n);return new tr(s,t.h)}(r=tr.prototype).ea=function(){if(cr(this))return-lr(this).ea();for(var t=0,e=1,n=0;n<this.g.length;n++){var r=this.D(n);t+=(0<=r?r:sr+r)*e,e*=sr}return t},r.toString=function(t){if(2>(t=t||10)||36<t)throw Error("radix out of range: "+t);if(ur(this))return"0";if(cr(this))return"-"+lr(this).toString(t);for(var e=rr(Math.pow(t,6)),n=this,r="";;){var s=mr(n,e).g,i=((0<(n=hr(n,s.R(e))).g.length?n.g[0]:n.h)>>>0).toString(t);if(ur(n=s))return i+r;for(;6>i.length;)i="0"+i;r=i+r}},r.D=function(t){return 0>t?0:t<this.g.length?this.g[t]:this.h},r.X=function(t){return cr(t=hr(this,t))?-1:ur(t)?0:1},r.abs=function(){return cr(this)?lr(this):this},r.add=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],r=0,s=0;s<=e;s++){var i=r+(65535&this.D(s))+(65535&t.D(s)),o=(i>>>16)+(this.D(s)>>>16)+(t.D(s)>>>16);r=o>>>16,i&=65535,o&=65535,n[s]=o<<16|i}return new tr(n,-2147483648&n[n.length-1]?-1:0)},r.R=function(t){if(ur(this)||ur(t))return ir;if(cr(this))return cr(t)?lr(this).R(lr(t)):lr(lr(this).R(t));if(cr(t))return lr(this.R(lr(t)));if(0>this.X(ar)&&0>t.X(ar))return rr(this.ea()*t.ea());for(var e=this.g.length+t.g.length,n=[],r=0;r<2*e;r++)n[r]=0;for(r=0;r<this.g.length;r++)for(var s=0;s<t.g.length;s++){var i=this.D(r)>>>16,o=65535&this.D(r),a=t.D(s)>>>16,u=65535&t.D(s);n[2*r+2*s]+=o*u,dr(n,2*r+2*s),n[2*r+2*s+1]+=i*u,dr(n,2*r+2*s+1),n[2*r+2*s+1]+=o*a,dr(n,2*r+2*s+1),n[2*r+2*s+2]+=i*a,dr(n,2*r+2*s+2)}for(r=0;r<e;r++)n[r]=n[2*r+1]<<16|n[2*r];for(r=e;r<2*e;r++)n[r]=0;return new tr(n,0)},r.gb=function(t){return mr(this,t).h},r.and=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],r=0;r<e;r++)n[r]=this.D(r)&t.D(r);return new tr(n,this.h&t.h)},r.or=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],r=0;r<e;r++)n[r]=this.D(r)|t.D(r);return new tr(n,this.h|t.h)},r.xor=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],r=0;r<e;r++)n[r]=this.D(r)^t.D(r);return new tr(n,this.h^t.h)},Qn.prototype.createWebChannel=Qn.prototype.g,Wn.prototype.send=Wn.prototype.u,Wn.prototype.open=Wn.prototype.m,Wn.prototype.close=Wn.prototype.close,Xt.NO_ERROR=0,Xt.TIMEOUT=8,Xt.HTTP_ERROR=6,Jt.COMPLETE="complete",ee.EventType=re,re.OPEN="a",re.CLOSE="b",re.ERROR="c",re.MESSAGE="d",yt.prototype.listen=yt.prototype.O,fn.prototype.listenOnce=fn.prototype.P,fn.prototype.getLastError=fn.prototype.Sa,fn.prototype.getLastErrorCode=fn.prototype.Ia,fn.prototype.getStatus=fn.prototype.da,fn.prototype.getResponseJson=fn.prototype.Wa,fn.prototype.getResponseText=fn.prototype.ja,fn.prototype.send=fn.prototype.ha,fn.prototype.setWithCredentials=fn.prototype.Oa,Jn.prototype.digest=Jn.prototype.l,Jn.prototype.reset=Jn.prototype.reset,Jn.prototype.update=Jn.prototype.j,tr.prototype.add=tr.prototype.add,tr.prototype.multiply=tr.prototype.R,tr.prototype.modulo=tr.prototype.gb,tr.prototype.compare=tr.prototype.X,tr.prototype.toNumber=tr.prototype.ea,tr.prototype.toString=tr.prototype.toString,tr.prototype.getBits=tr.prototype.D,tr.fromNumber=rr,tr.fromString=function t(e,n){if(0==e.length)throw Error("number format error: empty string");if(2>(n=n||10)||36<n)throw Error("radix out of range: "+n);if("-"==e.charAt(0))return lr(t(e.substring(1),n));if(0<=e.indexOf("-"))throw Error('number format error: interior "-" character');for(var r=rr(Math.pow(n,8)),s=ir,i=0;i<e.length;i+=8){var o=Math.min(8,e.length-i),a=parseInt(e.substring(i,i+o),n);8>o?(o=rr(Math.pow(n,o)),s=s.R(o).add(rr(a))):s=(s=s.R(r)).add(rr(a))}return s};var yr=c.createWebChannelTransport=function(){return new Qn},wr=c.getStatEventTarget=function(){return Gt()},vr=c.ErrorCode=Xt,br=c.EventType=Jt,Ir=c.Event=zt,_r=c.Stat={xb:0,Ab:1,Bb:2,Ub:3,Zb:4,Wb:5,Xb:6,Vb:7,Tb:8,Yb:9,PROXY:10,NOPROXY:11,Rb:12,Nb:13,Ob:14,Mb:15,Pb:16,Qb:17,tb:18,sb:19,ub:20},Tr=(c.FetchXmlHttpFactory=on,c.WebChannel=ee),Er=c.XhrIo=fn,Sr=c.Md5=Jn,xr=c.Integer=tr;const Cr="@firebase/firestore";class Dr{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}Dr.UNAUTHENTICATED=new Dr(null),Dr.GOOGLE_CREDENTIALS=new Dr("google-credentials-uid"),Dr.FIRST_PARTY=new Dr("first-party-uid"),Dr.MOCK_USER=new Dr("mock-user");let Ar="10.7.2";const Nr=new o.Vy("@firebase/firestore");function kr(){return Nr.logLevel}function Rr(t){Nr.setLogLevel(t)}function Mr(t,...e){if(Nr.logLevel<=o.$b.DEBUG){const n=e.map(Fr);Nr.debug(`Firestore (${Ar}): ${t}`,...n)}}function Pr(t,...e){if(Nr.logLevel<=o.$b.ERROR){const n=e.map(Fr);Nr.error(`Firestore (${Ar}): ${t}`,...n)}}function Lr(t,...e){if(Nr.logLevel<=o.$b.WARN){const n=e.map(Fr);Nr.warn(`Firestore (${Ar}): ${t}`,...n)}}function Fr(t){if("string"==typeof t)return t;try{return function(t){return JSON.stringify(t)}(t)}catch(e){return t}}function Or(t="Unexpected state"){const e=`FIRESTORE (${Ar}) INTERNAL ASSERTION FAILED: `+t;throw Pr(e),new Error(e)}function Vr(t,e){t||Or()}function qr(t,e){t||Or()}function Ur(t,e){return t}const Br={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class zr extends a.g{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Kr{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}}class Gr{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class jr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable((()=>e(Dr.UNAUTHENTICATED)))}shutdown(){}}class $r{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable((()=>e(this.token.user)))}shutdown(){this.changeListener=null}}class Qr{constructor(t){this.t=t,this.currentUser=Dr.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i;const r=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let s=new Kr;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new Kr,t.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const e=s;t.enqueueRetryable((async()=>{await e.promise,await r(this.currentUser)}))},o=t=>{Mr("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((t=>o(t))),setTimeout((()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?o(t):(Mr("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new Kr)}}),0),i()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then((e=>this.i!==t?(Mr("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(Vr("string"==typeof e.accessToken),new Gr(e.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const t=this.auth&&this.auth.getUid();return Vr(null===t||"string"==typeof t),new Dr(t)}}class Wr{constructor(t,e,n){this.l=t,this.h=e,this.P=n,this.type="FirstParty",this.user=Dr.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);const t=this.T();return t&&this.I.set("Authorization",t),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class Hr{constructor(t,e,n){this.l=t,this.h=e,this.P=n}getToken(){return Promise.resolve(new Wr(this.l,this.h,this.P))}start(t,e){t.enqueueRetryable((()=>e(Dr.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class Yr{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class Xr{constructor(t){this.A=t,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(t,e){const n=t=>{null!=t.error&&Mr("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${t.error.message}`);const n=t.token!==this.R;return this.R=t.token,Mr("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?e(t.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable((()=>n(e)))};const r=t=>{Mr("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=t,this.appCheck.addTokenListener(this.o)};this.A.onInit((t=>r(t))),setTimeout((()=>{if(!this.appCheck){const t=this.A.getImmediate({optional:!0});t?r(t):Mr("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then((t=>t?(Vr("string"==typeof t.token),this.R=t.token,new Yr(t.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Jr{getToken(){return Promise.resolve(new Yr(""))}invalidateToken(){}start(t,e){}shutdown(){}}function Zr(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let e=0;e<t;e++)n[e]=Math.floor(256*Math.random());return n}class ts{static newId(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=62*Math.floor(256/62);let n="";for(;n.length<20;){const r=Zr(40);for(let s=0;s<r.length;++s)n.length<20&&r[s]<e&&(n+=t.charAt(r[s]%62))}return n}}function es(t,e){return t<e?-1:t>e?1:0}function ns(t,e,n){return t.length===e.length&&t.every(((t,r)=>n(t,e[r])))}function rs(t){return t+"\0"}class ss{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new zr(Br.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new zr(Br.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new zr(Br.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new zr(Br.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return ss.fromMillis(Date.now())}static fromDate(t){return ss.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new ss(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?es(this.nanoseconds,t.nanoseconds):es(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class is{constructor(t){this.timestamp=t}static fromTimestamp(t){return new is(t)}static min(){return new is(new ss(0,0))}static max(){return new is(new ss(253402300799,999999999))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class os{constructor(t,e,n){void 0===e?e=0:e>t.length&&Or(),void 0===n?n=t.length-e:n>t.length-e&&Or(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===os.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof os?t.forEach((t=>{e.push(t)})):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let r=0;r<n;r++){const n=t.get(r),s=e.get(r);if(n<s)return-1;if(n>s)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class as extends os{construct(t,e,n){return new as(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...t){const e=[];for(const n of t){if(n.indexOf("//")>=0)throw new zr(Br.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter((t=>t.length>0)))}return new as(e)}static emptyPath(){return new as([])}}const us=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class cs extends os{construct(t,e,n){return new cs(t,e,n)}static isValidIdentifier(t){return us.test(t)}canonicalString(){return this.toArray().map((t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),cs.isValidIdentifier(t)||(t="`"+t+"`"),t))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new cs(["__name__"])}static fromServerFormat(t){const e=[];let n="",r=0;const s=()=>{if(0===n.length)throw new zr(Br.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;r<t.length;){const e=t[r];if("\\"===e){if(r+1===t.length)throw new zr(Br.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[r+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new zr(Br.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,r+=2}else"`"===e?(i=!i,r++):"."!==e||i?(n+=e,r++):(s(),r++)}if(s(),i)throw new zr(Br.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new cs(e)}static emptyPath(){return new cs([])}}class ls{constructor(t){this.path=t}static fromPath(t){return new ls(as.fromString(t))}static fromName(t){return new ls(as.fromString(t).popFirst(5))}static empty(){return new ls(as.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return null!==t&&0===as.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return as.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new ls(new as(t.slice()))}}class hs{constructor(t,e,n,r){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=r}}function ds(t){return t.fields.find((t=>2===t.kind))}function fs(t){return t.fields.filter((t=>2!==t.kind))}function ms(t,e){let n=es(t.collectionGroup,e.collectionGroup);if(0!==n)return n;for(let r=0;r<Math.min(t.fields.length,e.fields.length);++r)if(n=ps(t.fields[r],e.fields[r]),0!==n)return n;return es(t.fields.length,e.fields.length)}hs.UNKNOWN_ID=-1;class gs{constructor(t,e){this.fieldPath=t,this.kind=e}}function ps(t,e){const n=cs.comparator(t.fieldPath,e.fieldPath);return 0!==n?n:es(t.kind,e.kind)}class ys{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new ys(0,bs.min())}}function ws(t,e){const n=t.toTimestamp().seconds,r=t.toTimestamp().nanoseconds+1,s=is.fromTimestamp(1e9===r?new ss(n+1,0):new ss(n,r));return new bs(s,ls.empty(),e)}function vs(t){return new bs(t.readTime,t.key,-1)}class bs{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new bs(is.min(),ls.empty(),-1)}static max(){return new bs(is.max(),ls.empty(),-1)}}function Is(t,e){let n=t.readTime.compareTo(e.readTime);return 0!==n?n:(n=ls.comparator(t.documentKey,e.documentKey),0!==n?n:es(t.largestBatchId,e.largestBatchId))}const _s="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Ts{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((t=>t()))}}async function Es(t){if(t.code!==Br.FAILED_PRECONDITION||t.message!==_s)throw t;Mr("LocalStore","Unexpectedly lost primary lease")}class Ss{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&Or(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new Ss(((n,r)=>{this.nextCallback=e=>{this.wrapSuccess(t,e).next(n,r)},this.catchCallback=t=>{this.wrapFailure(e,t).next(n,r)}}))}toPromise(){return new Promise(((t,e)=>{this.next(t,e)}))}wrapUserFunction(t){try{const e=t();return e instanceof Ss?e:Ss.resolve(e)}catch(t){return Ss.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction((()=>t(e))):Ss.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction((()=>t(e))):Ss.reject(e)}static resolve(t){return new Ss(((e,n)=>{e(t)}))}static reject(t){return new Ss(((e,n)=>{n(t)}))}static waitFor(t){return new Ss(((e,n)=>{let r=0,s=0,i=!1;t.forEach((t=>{++r,t.next((()=>{++s,i&&s===r&&e()}),(t=>n(t)))})),i=!0,s===r&&e()}))}static or(t){let e=Ss.resolve(!1);for(const n of t)e=e.next((t=>t?Ss.resolve(t):n()));return e}static forEach(t,e){const n=[];return t.forEach(((t,r)=>{n.push(e.call(this,t,r))})),this.waitFor(n)}static mapArray(t,e){return new Ss(((n,r)=>{const s=t.length,i=new Array(s);let o=0;for(let a=0;a<s;a++){const u=a;e(t[u]).next((t=>{i[u]=t,++o,o===s&&n(i)}),(t=>r(t)))}}))}static doWhile(t,e){return new Ss(((n,r)=>{const s=()=>{!0===t()?e().next((()=>{s()}),r):n()};s()}))}}class xs{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.V=new Kr,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{e.error?this.V.reject(new As(t,e.error)):this.V.resolve()},this.transaction.onerror=e=>{const n=Ps(e.target.error);this.V.reject(new As(t,n))}}static open(t,e,n,r){try{return new xs(e,t.transaction(r,n))}catch(t){throw new As(e,t)}}get m(){return this.V.promise}abort(t){t&&this.V.reject(t),this.aborted||(Mr("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){const t=this.transaction;this.aborted||"function"!=typeof t.commit||t.commit()}store(t){const e=this.transaction.objectStore(t);return new ks(e)}}class Cs{constructor(t,e,n){this.name=t,this.version=e,this.p=n,12.2===Cs.S((0,a.ZQ)())&&Pr("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return Mr("SimpleDb","Removing database:",t),Rs(window.indexedDB.deleteDatabase(t)).toPromise()}static D(){if(!(0,a.zW)())return!1;if(Cs.C())return!0;const t=(0,a.ZQ)(),e=Cs.S(t),n=0<e&&e<10,r=Cs.v(t),s=0<r&&r<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||s)}static C(){var t;return"undefined"!=typeof process&&"YES"===(null===(t=process.__PRIVATE_env)||void 0===t?void 0:t.F)}static M(t,e){return t.store(e)}static S(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static v(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async O(t){return this.db||(Mr("SimpleDb","Opening database:",this.name),this.db=await new Promise(((e,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=t=>{const n=t.target.result;e(n)},r.onblocked=()=>{n(new As(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=e=>{const r=e.target.error;"VersionError"===r.name?n(new zr(Br.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new zr(Br.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new As(t,r))},r.onupgradeneeded=t=>{Mr("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.p.N(e,r.transaction,t.oldVersion,this.version).next((()=>{Mr("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.B&&(this.db.onversionchange=t=>this.B(t)),this.db}L(t){this.B=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(t,e,n,r){const s="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.O(t);const e=xs.open(this.db,t,s?"readonly":"readwrite",n),i=r(e).next((t=>(e.g(),t))).catch((t=>(e.abort(t),Ss.reject(t)))).toPromise();return i.catch((()=>{})),await e.m,i}catch(t){const e=t,n="FirebaseError"!==e.name&&i<3;if(Mr("SimpleDb","Transaction failed with error:",e.message,"Retrying:",n),this.close(),!n)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Ds{constructor(t){this.k=t,this.q=!1,this.K=null}get isDone(){return this.q}get $(){return this.K}set cursor(t){this.k=t}done(){this.q=!0}U(t){this.K=t}delete(){return Rs(this.k.delete())}}class As extends zr{constructor(t,e){super(Br.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function Ns(t){return"IndexedDbTransactionError"===t.name}class ks{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(Mr("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(Mr("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),Rs(n)}add(t){return Mr("SimpleDb","ADD",this.store.name,t,t),Rs(this.store.add(t))}get(t){return Rs(this.store.get(t)).next((e=>(void 0===e&&(e=null),Mr("SimpleDb","GET",this.store.name,t,e),e)))}delete(t){return Mr("SimpleDb","DELETE",this.store.name,t),Rs(this.store.delete(t))}count(){return Mr("SimpleDb","COUNT",this.store.name),Rs(this.store.count())}W(t,e){const n=this.options(t,e),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){const t=r.getAll(n.range);return new Ss(((e,n)=>{t.onerror=t=>{n(t.target.error)},t.onsuccess=t=>{e(t.target.result)}}))}{const t=this.cursor(n),e=[];return this.G(t,((t,n)=>{e.push(n)})).next((()=>e))}}j(t,e){const n=this.store.getAll(t,null===e?void 0:e);return new Ss(((t,e)=>{n.onerror=t=>{e(t.target.error)},n.onsuccess=e=>{t(e.target.result)}}))}H(t,e){Mr("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.J=!1;const r=this.cursor(n);return this.G(r,((t,e,n)=>n.delete()))}Y(t,e){let n;e?n=t:(n={},e=t);const r=this.cursor(n);return this.G(r,e)}Z(t){const e=this.cursor({});return new Ss(((n,r)=>{e.onerror=t=>{const e=Ps(t.target.error);r(e)},e.onsuccess=e=>{const r=e.target.result;r?t(r.primaryKey,r.value).next((t=>{t?r.continue():n()})):n()}}))}G(t,e){const n=[];return new Ss(((r,s)=>{t.onerror=t=>{s(t.target.error)},t.onsuccess=t=>{const s=t.target.result;if(!s)return void r();const i=new Ds(s),o=e(s.primaryKey,s.value,i);if(o instanceof Ss){const t=o.catch((t=>(i.done(),Ss.reject(t))));n.push(t)}i.isDone?r():null===i.$?s.continue():s.continue(i.$)}})).next((()=>Ss.waitFor(n)))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.J?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function Rs(t){return new Ss(((e,n)=>{t.onsuccess=t=>{const n=t.target.result;e(n)},t.onerror=t=>{const e=Ps(t.target.error);n(e)}}))}let Ms=!1;function Ps(t){const e=Cs.S((0,a.ZQ)());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new zr("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Ms||(Ms=!0,setTimeout((()=>{throw t}),0)),t}}return t}class Ls{constructor(t,e){this.asyncQueue=t,this.X=e,this.task=null}start(){this.ee(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}ee(t){Mr("IndexBackfiller",`Scheduled in ${t}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",t,(async()=>{this.task=null;try{Mr("IndexBackfiller",`Documents written: ${await this.X.te()}`)}catch(t){Ns(t)?Mr("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",t):await Es(t)}await this.ee(6e4)}))}}class Fs{constructor(t,e){this.localStore=t,this.persistence=e}async te(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(e=>this.ne(e,t)))}ne(t,e){const n=new Set;let r=e,s=!0;return Ss.doWhile((()=>!0===s&&r>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(t).next((e=>{if(null!==e&&!n.has(e))return Mr("IndexBackfiller",`Processing collection: ${e}`),this.re(t,e,r).next((t=>{r-=t,n.add(e)}));s=!1})))).next((()=>e-r))}re(t,e,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(t,e).next((r=>this.localStore.localDocuments.getNextDocuments(t,e,r,n).next((n=>{const s=n.changes;return this.localStore.indexManager.updateIndexEntries(t,s).next((()=>this.ie(r,n))).next((n=>(Mr("IndexBackfiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(t,e,n)))).next((()=>s.size))}))))}ie(t,e){let n=t;return e.changes.forEach(((t,e)=>{const r=vs(e);Is(r,n)>0&&(n=r)})),new bs(n.readTime,n.documentKey,Math.max(e.batchId,t.largestBatchId))}}class Os{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.se(t),this.oe=t=>e.writeSequenceNumber(t))}se(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.oe&&this.oe(t),t}}function Vs(t){return null==t}function qs(t){return 0===t&&1/t==-1/0}function Us(t){return"number"==typeof t&&Number.isInteger(t)&&!qs(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}function Bs(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=Ks(e)),e=zs(t.get(n),e);return Ks(e)}function zs(t,e){let n=e;const r=t.length;for(let e=0;e<r;e++){const r=t.charAt(e);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}function Ks(t){return t+""}function Gs(t){const e=t.length;if(Vr(e>=2),2===e)return Vr(""===t.charAt(0)&&""===t.charAt(1)),as.emptyPath();const n=e-2,r=[];let s="";for(let i=0;i<e;){const e=t.indexOf("",i);switch((e<0||e>n)&&Or(),t.charAt(e+1)){case"":const n=t.substring(i,e);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"":s+=t.substring(i,e),s+="\0";break;case"":s+=t.substring(i,e+1);break;default:Or()}i=e+2}return new as(r)}Os._e=-1;const js=["userId","batchId"];function $s(t,e){return[t,Bs(e)]}function Qs(t,e,n){return[t,Bs(e),n]}const Ws={},Hs=["prefixPath","collectionGroup","readTime","documentId"],Ys=["prefixPath","collectionGroup","documentId"],Xs=["collectionGroup","readTime","prefixPath","documentId"],Js=["canonicalId","targetId"],Zs=["targetId","path"],ti=["path","targetId"],ei=["collectionId","parent"],ni=["indexId","uid"],ri=["uid","sequenceNumber"],si=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],ii=["indexId","uid","orderedDocumentKey"],oi=["userId","collectionPath","documentId"],ai=["userId","collectionPath","largestBatchId"],ui=["userId","collectionGroup","largestBatchId"],ci=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],li=[...ci,"documentOverlays"],hi=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],di=hi,fi=[...di,"indexConfiguration","indexState","indexEntries"];class mi extends Ts{constructor(t,e){super(),this.ae=t,this.currentSequenceNumber=e}}function gi(t,e){const n=Ur(t);return Cs.M(n.ae,e)}function pi(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function yi(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function wi(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}class vi{constructor(t,e){this.comparator=t,this.root=e||Ii.EMPTY}insert(t,e){return new vi(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Ii.BLACK,null,null))}remove(t){return new vi(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Ii.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(t,n.key);if(0===r)return e+n.left.size;r<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal(((e,n)=>(t(e,n),!1)))}toString(){const t=[];return this.inorderTraversal(((e,n)=>(t.push(`${e}:${n}`),!1))),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new bi(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new bi(this.root,t,this.comparator,!1)}getReverseIterator(){return new bi(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new bi(this.root,t,this.comparator,!0)}}class bi{constructor(t,e,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!t.isEmpty();)if(s=e?n(t.key,e):1,e&&r&&(s*=-1),s<0)t=this.isReverse?t.left:t.right;else{if(0===s){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class Ii{constructor(t,e,n,r,s){this.key=t,this.value=e,this.color=null!=n?n:Ii.RED,this.left=null!=r?r:Ii.EMPTY,this.right=null!=s?s:Ii.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,r,s){return new Ii(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let r=this;const s=n(t,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===s?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return Ii.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,r=this;if(e(t,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(t,e),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===e(t,r.key)){if(r.right.isEmpty())return Ii.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,Ii.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,Ii.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Or();if(this.right.isRed())throw Or();const t=this.left.check();if(t!==this.right.check())throw Or();return t+(this.isRed()?0:1)}}Ii.EMPTY=null,Ii.RED=!0,Ii.BLACK=!1,Ii.EMPTY=new class{constructor(){this.size=0}get key(){throw Or()}get value(){throw Or()}get color(){throw Or()}get left(){throw Or()}get right(){throw Or()}copy(t,e,n,r,s){return this}insert(t,e,n){return new Ii(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class _i{constructor(t){this.comparator=t,this.data=new vi(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal(((e,n)=>(t(e),!1)))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,t[1])>=0)return;e(r.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new Ti(this.data.getIterator())}getIteratorFrom(t){return new Ti(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach((t=>{e=e.add(t)})),e}isEqual(t){if(!(t instanceof _i))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(0!==this.comparator(t,r))return!1}return!0}toArray(){const t=[];return this.forEach((e=>{t.push(e)})),t}toString(){const t=[];return this.forEach((e=>t.push(e))),"SortedSet("+t.toString()+")"}copy(t){const e=new _i(this.comparator);return e.data=t,e}}class Ti{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Ei(t){return t.hasNext()?t.getNext():void 0}class Si{constructor(t){this.fields=t,t.sort(cs.comparator)}static empty(){return new Si([])}unionWith(t){let e=new _i(cs.comparator);for(const t of this.fields)e=e.add(t);for(const n of t)e=e.add(n);return new Si(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return ns(this.fields,t.fields,((t,e)=>t.isEqual(e)))}}class xi extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}function Ci(){return"undefined"!=typeof atob}class Di{constructor(t){this.binaryString=t}static fromBase64String(t){const e=function(t){try{return atob(t)}catch(t){throw"undefined"!=typeof DOMException&&t instanceof DOMException?new xi("Invalid base64 string: "+t):t}}(t);return new Di(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new Di(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return es(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}Di.EMPTY_BYTE_STRING=new Di("");const Ai=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Ni(t){if(Vr(!!t),"string"==typeof t){let e=0;const n=Ai.exec(t);if(Vr(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}return{seconds:ki(t.seconds),nanos:ki(t.nanos)}}function ki(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function Ri(t){return"string"==typeof t?Di.fromBase64String(t):Di.fromUint8Array(t)}function Mi(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function Pi(t){const e=t.mapValue.fields.__previous_value__;return Mi(e)?Pi(e):e}function Li(t){const e=Ni(t.mapValue.fields.__local_write_time__.timestampValue);return new ss(e.seconds,e.nanos)}class Fi{constructor(t,e,n,r,s,i,o,a,u){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.longPollingOptions=a,this.useFetchStreams=u}}class Oi{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new Oi("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof Oi&&t.projectId===this.projectId&&t.database===this.database}}const Vi={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},qi={nullValue:"NULL_VALUE"};function Ui(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?Mi(t)?4:eo(t)?9007199254740991:10:Or()}function Bi(t,e){if(t===e)return!0;const n=Ui(t);if(n!==Ui(e))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return Li(t).isEqual(Li(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=Ni(t.timestampValue),r=Ni(e.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return Ri(t.bytesValue).isEqual(Ri(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return ki(t.geoPointValue.latitude)===ki(e.geoPointValue.latitude)&&ki(t.geoPointValue.longitude)===ki(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return ki(t.integerValue)===ki(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=ki(t.doubleValue),r=ki(e.doubleValue);return n===r?qs(n)===qs(r):isNaN(n)&&isNaN(r)}return!1}(t,e);case 9:return ns(t.arrayValue.values||[],e.arrayValue.values||[],Bi);case 10:return function(t,e){const n=t.mapValue.fields||{},r=e.mapValue.fields||{};if(pi(n)!==pi(r))return!1;for(const t in n)if(n.hasOwnProperty(t)&&(void 0===r[t]||!Bi(n[t],r[t])))return!1;return!0}(t,e);default:return Or()}}function zi(t,e){return void 0!==(t.values||[]).find((t=>Bi(t,e)))}function Ki(t,e){if(t===e)return 0;const n=Ui(t),r=Ui(e);if(n!==r)return es(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return es(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=ki(t.integerValue||t.doubleValue),r=ki(e.integerValue||e.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(t,e);case 3:return Gi(t.timestampValue,e.timestampValue);case 4:return Gi(Li(t),Li(e));case 5:return es(t.stringValue,e.stringValue);case 6:return function(t,e){const n=Ri(t),r=Ri(e);return n.compareTo(r)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),r=e.split("/");for(let t=0;t<n.length&&t<r.length;t++){const e=es(n[t],r[t]);if(0!==e)return e}return es(n.length,r.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=es(ki(t.latitude),ki(e.latitude));return 0!==n?n:es(ki(t.longitude),ki(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){const n=t.values||[],r=e.values||[];for(let t=0;t<n.length&&t<r.length;++t){const e=Ki(n[t],r[t]);if(e)return e}return es(n.length,r.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){if(t===Vi.mapValue&&e===Vi.mapValue)return 0;if(t===Vi.mapValue)return 1;if(e===Vi.mapValue)return-1;const n=t.fields||{},r=Object.keys(n),s=e.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let t=0;t<r.length&&t<i.length;++t){const e=es(r[t],i[t]);if(0!==e)return e;const o=Ki(n[r[t]],s[i[t]]);if(0!==o)return o}return es(r.length,i.length)}(t.mapValue,e.mapValue);default:throw Or()}}function Gi(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return es(t,e);const n=Ni(t),r=Ni(e),s=es(n.seconds,r.seconds);return 0!==s?s:es(n.nanos,r.nanos)}function ji(t){return $i(t)}function $i(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=Ni(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?function(t){return Ri(t).toBase64()}(t.bytesValue):"referenceValue"in t?function(t){return ls.fromName(t).toString()}(t.referenceValue):"geoPointValue"in t?function(t){return`geo(${t.latitude},${t.longitude})`}(t.geoPointValue):"arrayValue"in t?function(t){let e="[",n=!0;for(const r of t.values||[])n?n=!1:e+=",",e+=$i(r);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",r=!0;for(const s of e)r?r=!1:n+=",",n+=`${s}:${$i(t.fields[s])}`;return n+"}"}(t.mapValue):Or()}function Qi(t){switch(Ui(t)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const e=Pi(t);return e?16+Qi(e):16;case 5:return 2*t.stringValue.length;case 6:return Ri(t.bytesValue).approximateByteSize();case 7:return t.referenceValue.length;case 9:return function(t){return(t.values||[]).reduce(((t,e)=>t+Qi(e)),0)}(t.arrayValue);case 10:return function(t){let e=0;return yi(t.fields,((t,n)=>{e+=t.length+Qi(n)})),e}(t.mapValue);default:throw Or()}}function Wi(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function Hi(t){return!!t&&"integerValue"in t}function Yi(t){return!!t&&"arrayValue"in t}function Xi(t){return!!t&&"nullValue"in t}function Ji(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function Zi(t){return!!t&&"mapValue"in t}function to(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return yi(t.mapValue.fields,((t,n)=>e.mapValue.fields[t]=to(n))),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=to(t.arrayValue.values[n]);return e}return Object.assign({},t)}function eo(t){return"__max__"===(((t.mapValue||{}).fields||{}).__type__||{}).stringValue}function no(t){return"nullValue"in t?qi:"booleanValue"in t?{booleanValue:!1}:"integerValue"in t||"doubleValue"in t?{doubleValue:NaN}:"timestampValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in t?{stringValue:""}:"bytesValue"in t?{bytesValue:""}:"referenceValue"in t?Wi(Oi.empty(),ls.empty()):"geoPointValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in t?{arrayValue:{}}:"mapValue"in t?{mapValue:{}}:Or()}function ro(t){return"nullValue"in t?{booleanValue:!1}:"booleanValue"in t?{doubleValue:NaN}:"integerValue"in t||"doubleValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in t?{stringValue:""}:"stringValue"in t?{bytesValue:""}:"bytesValue"in t?Wi(Oi.empty(),ls.empty()):"referenceValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in t?{arrayValue:{}}:"arrayValue"in t?{mapValue:{}}:"mapValue"in t?Vi:Or()}function so(t,e){const n=Ki(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?-1:!t.inclusive&&e.inclusive?1:0}function io(t,e){const n=Ki(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?1:!t.inclusive&&e.inclusive?-1:0}class oo{constructor(t){this.value=t}static empty(){return new oo({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!Zi(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=to(e)}setAll(t){let e=cs.emptyPath(),n={},r=[];t.forEach(((t,s)=>{if(!e.isImmediateParentOf(s)){const t=this.getFieldsMap(e);this.applyChanges(t,n,r),n={},r=[],e=s.popLast()}t?n[s.lastSegment()]=to(t):r.push(s.lastSegment())}));const s=this.getFieldsMap(e);this.applyChanges(s,n,r)}delete(t){const e=this.field(t.popLast());Zi(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return Bi(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let r=e.mapValue.fields[t.get(n)];Zi(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=r),e=r}return e.mapValue.fields}applyChanges(t,e,n){yi(e,((e,n)=>t[e]=n));for(const e of n)delete t[e]}clone(){return new oo(to(this.value))}}function ao(t){const e=[];return yi(t.fields,((t,n)=>{const r=new cs([t]);if(Zi(n)){const t=ao(n.mapValue).fields;if(0===t.length)e.push(r);else for(const n of t)e.push(r.child(n))}else e.push(r)})),new Si(e)}class uo{constructor(t,e,n,r,s,i,o){this.key=t,this.documentType=e,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=o}static newInvalidDocument(t){return new uo(t,0,is.min(),is.min(),is.min(),oo.empty(),0)}static newFoundDocument(t,e,n,r){return new uo(t,1,e,is.min(),n,r,0)}static newNoDocument(t,e){return new uo(t,2,e,is.min(),is.min(),oo.empty(),0)}static newUnknownDocument(t,e){return new uo(t,3,e,is.min(),is.min(),oo.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(is.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=oo.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=oo.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=is.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof uo&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new uo(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class co{constructor(t,e){this.position=t,this.inclusive=e}}function lo(t,e,n){let r=0;for(let s=0;s<t.position.length;s++){const i=e[s],o=t.position[s];if(r=i.field.isKeyField()?ls.comparator(ls.fromName(o.referenceValue),n.key):Ki(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function ho(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.inclusive!==e.inclusive||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!Bi(t.position[n],e.position[n]))return!1;return!0}class fo{constructor(t,e="asc"){this.field=t,this.dir=e}}function mo(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}class go{}class po extends go{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.createKeyFieldInFilter(t,e,n):new xo(t,e,n):"array-contains"===e?new No(t,n):"in"===e?new ko(t,n):"not-in"===e?new Ro(t,n):"array-contains-any"===e?new Mo(t,n):new po(t,e,n)}static createKeyFieldInFilter(t,e,n){return"in"===e?new Co(t,n):new Do(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.matchesComparison(Ki(e,this.value)):null!==e&&Ui(this.value)===Ui(e)&&this.matchesComparison(Ki(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return Or()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class yo extends go{constructor(t,e){super(),this.filters=t,this.op=e,this.ue=null}static create(t,e){return new yo(t,e)}matches(t){return wo(this)?void 0===this.filters.find((e=>!e.matches(t))):void 0!==this.filters.find((e=>e.matches(t)))}getFlattenedFilters(){return null!==this.ue||(this.ue=this.filters.reduce(((t,e)=>t.concat(e.getFlattenedFilters())),[])),this.ue}getFilters(){return Object.assign([],this.filters)}}function wo(t){return"and"===t.op}function vo(t){return"or"===t.op}function bo(t){return Io(t)&&wo(t)}function Io(t){for(const e of t.filters)if(e instanceof yo)return!1;return!0}function _o(t){if(t instanceof po)return t.field.canonicalString()+t.op.toString()+ji(t.value);if(bo(t))return t.filters.map((t=>_o(t))).join(",");{const e=t.filters.map((t=>_o(t))).join(",");return`${t.op}(${e})`}}function To(t,e){return t instanceof po?function(t,e){return e instanceof po&&t.op===e.op&&t.field.isEqual(e.field)&&Bi(t.value,e.value)}(t,e):t instanceof yo?function(t,e){return e instanceof yo&&t.op===e.op&&t.filters.length===e.filters.length&&t.filters.reduce(((t,n,r)=>t&&To(n,e.filters[r])),!0)}(t,e):void Or()}function Eo(t,e){const n=t.filters.concat(e);return yo.create(n,t.op)}function So(t){return t instanceof po?function(t){return`${t.field.canonicalString()} ${t.op} ${ji(t.value)}`}(t):t instanceof yo?function(t){return t.op.toString()+" {"+t.getFilters().map(So).join(" ,")+"}"}(t):"Filter"}class xo extends po{constructor(t,e,n){super(t,e,n),this.key=ls.fromName(n.referenceValue)}matches(t){const e=ls.comparator(t.key,this.key);return this.matchesComparison(e)}}class Co extends po{constructor(t,e){super(t,"in",e),this.keys=Ao("in",e)}matches(t){return this.keys.some((e=>e.isEqual(t.key)))}}class Do extends po{constructor(t,e){super(t,"not-in",e),this.keys=Ao("not-in",e)}matches(t){return!this.keys.some((e=>e.isEqual(t.key)))}}function Ao(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((t=>ls.fromName(t.referenceValue)))}class No extends po{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return Yi(e)&&zi(e.arrayValue,this.value)}}class ko extends po{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&zi(this.value.arrayValue,e)}}class Ro extends po{constructor(t,e){super(t,"not-in",e)}matches(t){if(zi(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!zi(this.value.arrayValue,e)}}class Mo extends po{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!Yi(e)||!e.arrayValue.values)&&e.arrayValue.values.some((t=>zi(this.value.arrayValue,t)))}}class Po{constructor(t,e=null,n=[],r=[],s=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.ce=null}}function Lo(t,e=null,n=[],r=[],s=null,i=null,o=null){return new Po(t,e,n,r,s,i,o)}function Fo(t){const e=Ur(t);if(null===e.ce){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((t=>_o(t))).join(","),t+="|ob:",t+=e.orderBy.map((t=>function(t){return t.field.canonicalString()+t.dir}(t))).join(","),Vs(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((t=>ji(t))).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((t=>ji(t))).join(",")),e.ce=t}return e.ce}function Oo(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let n=0;n<t.orderBy.length;n++)if(!mo(t.orderBy[n],e.orderBy[n]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let n=0;n<t.filters.length;n++)if(!To(t.filters[n],e.filters[n]))return!1;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!ho(t.startAt,e.startAt)&&ho(t.endAt,e.endAt)}function Vo(t){return ls.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}function qo(t,e){return t.filters.filter((t=>t instanceof po&&t.field.isEqual(e)))}function Uo(t,e,n){let r=qi,s=!0;for(const n of qo(t,e)){let t=qi,e=!0;switch(n.op){case"<":case"<=":t=no(n.value);break;case"==":case"in":case">=":t=n.value;break;case">":t=n.value,e=!1;break;case"!=":case"not-in":t=qi}so({value:r,inclusive:s},{value:t,inclusive:e})<0&&(r=t,s=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];so({value:r,inclusive:s},{value:t,inclusive:n.inclusive})<0&&(r=t,s=n.inclusive);break}return{value:r,inclusive:s}}function Bo(t,e,n){let r=Vi,s=!0;for(const n of qo(t,e)){let t=Vi,e=!0;switch(n.op){case">=":case">":t=ro(n.value),e=!1;break;case"==":case"in":case"<=":t=n.value;break;case"<":t=n.value,e=!1;break;case"!=":case"not-in":t=Vi}io({value:r,inclusive:s},{value:t,inclusive:e})>0&&(r=t,s=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];io({value:r,inclusive:s},{value:t,inclusive:n.inclusive})>0&&(r=t,s=n.inclusive);break}return{value:r,inclusive:s}}class zo{constructor(t,e=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.le=null,this.he=null,this.Pe=null,this.startAt,this.endAt}}function Ko(t,e,n,r,s,i,o,a){return new zo(t,e,n,r,s,i,o,a)}function Go(t){return new zo(t)}function jo(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}function $o(t){return null!==t.collectionGroup}function Qo(t){const e=Ur(t);if(null===e.le){e.le=[];const t=new Set;for(const n of e.explicitOrderBy)e.le.push(n),t.add(n.field.canonicalString());const n=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc",r=function(t){let e=new _i(cs.comparator);return t.filters.forEach((t=>{t.getFlattenedFilters().forEach((t=>{t.isInequality()&&(e=e.add(t.field))}))})),e}(e);r.forEach((r=>{t.has(r.canonicalString())||r.isKeyField()||e.le.push(new fo(r,n))})),t.has(cs.keyField().canonicalString())||e.le.push(new fo(cs.keyField(),n))}return e.le}function Wo(t){const e=Ur(t);return e.he||(e.he=Ho(e,Qo(t))),e.he}function Ho(t,e){if("F"===t.limitType)return Lo(t.path,t.collectionGroup,e,t.filters,t.limit,t.startAt,t.endAt);{e=e.map((t=>{const e="desc"===t.dir?"asc":"desc";return new fo(t.field,e)}));const n=t.endAt?new co(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new co(t.startAt.position,t.startAt.inclusive):null;return Lo(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}}function Yo(t,e){const n=t.filters.concat([e]);return new zo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}function Xo(t,e,n){return new zo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function Jo(t,e){return Oo(Wo(t),Wo(e))&&t.limitType===e.limitType}function Zo(t){return`${Fo(Wo(t))}|lt:${t.limitType}`}function ta(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map((t=>So(t))).join(", ")}]`),Vs(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map((t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t))).join(", ")}]`),t.startAt&&(e+=", startAt: ",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((t=>ji(t))).join(",")),t.endAt&&(e+=", endAt: ",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((t=>ji(t))).join(",")),`Target(${e})`}(Wo(t))}; limitType=${t.limitType})`}function ea(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):ls.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of Qo(t))if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!function(t,e,n){const r=lo(t,e,n);return t.inclusive?r<=0:r<0}(t.startAt,Qo(t),e))&&!(t.endAt&&!function(t,e,n){const r=lo(t,e,n);return t.inclusive?r>=0:r>0}(t.endAt,Qo(t),e))}(t,e)}function na(t){return t.collectionGroup||(t.path.length%2==1?t.path.lastSegment():t.path.get(t.path.length-2))}function ra(t){return(e,n)=>{let r=!1;for(const s of Qo(t)){const t=sa(s,e,n);if(0!==t)return t;r=r||s.field.isKeyField()}return 0}}function sa(t,e,n){const r=t.field.isKeyField()?ls.comparator(e.key,n.key):function(t,e,n){const r=e.data.field(t),s=n.data.field(t);return null!==r&&null!==s?Ki(r,s):Or()}(t.field,e,n);switch(t.dir){case"asc":return r;case"desc":return-1*r;default:return Or()}}class ia{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,r]of n)if(this.equalsFn(e,t))return r}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),r=this.inner[n];if(void 0===r)return this.inner[n]=[[t,e]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],t))return void(r[n]=[t,e]);r.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return 1===n.length?delete this.inner[e]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(t){yi(this.inner,((e,n)=>{for(const[e,r]of n)t(e,r)}))}isEmpty(){return wi(this.inner)}size(){return this.innerSize}}const oa=new vi(ls.comparator);function aa(){return oa}const ua=new vi(ls.comparator);function ca(...t){let e=ua;for(const n of t)e=e.insert(n.key,n);return e}function la(t){let e=ua;return t.forEach(((t,n)=>e=e.insert(t,n.overlayedDocument))),e}function ha(){return fa()}function da(){return fa()}function fa(){return new ia((t=>t.toString()),((t,e)=>t.isEqual(e)))}const ma=new vi(ls.comparator),ga=new _i(ls.comparator);function pa(...t){let e=ga;for(const n of t)e=e.add(n);return e}const ya=new _i(es);function wa(){return ya}function va(t,e){if(t.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:qs(e)?"-0":e}}function ba(t){return{integerValue:""+t}}function Ia(t,e){return Us(e)?ba(e):va(t,e)}class _a{constructor(){this._=void 0}}function Ta(t,e,n){return t instanceof xa?function(t,e){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&Mi(e)&&(e=Pi(e)),e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof Ca?Da(t,e):t instanceof Aa?Na(t,e):function(t,e){const n=Sa(t,e),r=Ra(n)+Ra(t.Ie);return Hi(n)&&Hi(t.Ie)?ba(r):va(t.serializer,r)}(t,e)}function Ea(t,e,n){return t instanceof Ca?Da(t,e):t instanceof Aa?Na(t,e):n}function Sa(t,e){return t instanceof ka?function(t){return Hi(t)||function(t){return!!t&&"doubleValue"in t}(t)}(e)?e:{integerValue:0}:null}class xa extends _a{}class Ca extends _a{constructor(t){super(),this.elements=t}}function Da(t,e){const n=Ma(e);for(const e of t.elements)n.some((t=>Bi(t,e)))||n.push(e);return{arrayValue:{values:n}}}class Aa extends _a{constructor(t){super(),this.elements=t}}function Na(t,e){let n=Ma(e);for(const e of t.elements)n=n.filter((t=>!Bi(t,e)));return{arrayValue:{values:n}}}class ka extends _a{constructor(t,e){super(),this.serializer=t,this.Ie=e}}function Ra(t){return ki(t.integerValue||t.doubleValue)}function Ma(t){return Yi(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class Pa{constructor(t,e){this.field=t,this.transform=e}}class La{constructor(t,e){this.version=t,this.transformResults=e}}class Fa{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new Fa}static exists(t){return new Fa(void 0,t)}static updateTime(t){return new Fa(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Oa(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class Va{}function qa(t,e){if(!t.hasLocalMutations||e&&0===e.fields.length)return null;if(null===e)return t.isNoDocument()?new Ha(t.key,Fa.none()):new Ga(t.key,t.data,Fa.none());{const n=t.data,r=oo.empty();let s=new _i(cs.comparator);for(let t of e.fields)if(!s.has(t)){let e=n.field(t);null===e&&t.length>1&&(t=t.popLast(),e=n.field(t)),null===e?r.delete(t):r.set(t,e),s=s.add(t)}return new ja(t.key,r,new Si(s.toArray()),Fa.none())}}function Ua(t,e,n){t instanceof Ga?function(t,e,n){const r=t.value.clone(),s=Qa(t.fieldTransforms,e,n.transformResults);r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):t instanceof ja?function(t,e,n){if(!Oa(t.precondition,e))return void e.convertToUnknownDocument(n.version);const r=Qa(t.fieldTransforms,e,n.transformResults),s=e.data;s.setAll($a(t)),s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function Ba(t,e,n,r){return t instanceof Ga?function(t,e,n,r){if(!Oa(t.precondition,e))return n;const s=t.value.clone(),i=Wa(t.fieldTransforms,r,e);return s.setAll(i),e.convertToFoundDocument(e.version,s).setHasLocalMutations(),null}(t,e,n,r):t instanceof ja?function(t,e,n,r){if(!Oa(t.precondition,e))return n;const s=Wa(t.fieldTransforms,r,e),i=e.data;return i.setAll($a(t)),i.setAll(s),e.convertToFoundDocument(e.version,i).setHasLocalMutations(),null===n?null:n.unionWith(t.fieldMask.fields).unionWith(t.fieldTransforms.map((t=>t.field)))}(t,e,n,r):function(t,e,n){return Oa(t.precondition,e)?(e.convertToNoDocument(e.version).setHasLocalMutations(),null):n}(t,e,n)}function za(t,e){let n=null;for(const r of t.fieldTransforms){const t=e.data.field(r.field),s=Sa(r.transform,t||null);null!=s&&(null===n&&(n=oo.empty()),n.set(r.field,s))}return n||null}function Ka(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&ns(t,e,((t,e)=>function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof Ca&&e instanceof Ca||t instanceof Aa&&e instanceof Aa?ns(t.elements,e.elements,Bi):t instanceof ka&&e instanceof ka?Bi(t.Ie,e.Ie):t instanceof xa&&e instanceof xa}(t.transform,e.transform)}(t,e)))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}class Ga extends Va{constructor(t,e,n,r=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class ja extends Va{constructor(t,e,n,r,s=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function $a(t){const e=new Map;return t.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=t.data.field(n);e.set(n,r)}})),e}function Qa(t,e,n){const r=new Map;Vr(t.length===n.length);for(let s=0;s<n.length;s++){const i=t[s],o=i.transform,a=e.data.field(i.field);r.set(i.field,Ea(o,a,n[s]))}return r}function Wa(t,e,n){const r=new Map;for(const s of t){const t=s.transform,i=n.data.field(s.field);r.set(s.field,Ta(t,i,e))}return r}class Ha extends Va{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Ya extends Va{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Xa{constructor(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const r=this.mutations[e];r.key.isEqual(t.key)&&Ua(r,t,n[e])}}applyToLocalView(t,e){for(const n of this.baseMutations)n.key.isEqual(t.key)&&(e=Ba(n,t,e,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(t.key)&&(e=Ba(n,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const n=da();return this.mutations.forEach((r=>{const s=t.get(r.key),i=s.overlayedDocument;let o=this.applyToLocalView(i,s.mutatedFields);o=e.has(r.key)?null:o;const a=qa(i,o);null!==a&&n.set(r.key,a),i.isValidDocument()||i.convertToNoDocument(is.min())})),n}keys(){return this.mutations.reduce(((t,e)=>t.add(e.key)),pa())}isEqual(t){return this.batchId===t.batchId&&ns(this.mutations,t.mutations,((t,e)=>Ka(t,e)))&&ns(this.baseMutations,t.baseMutations,((t,e)=>Ka(t,e)))}}class Ja{constructor(t,e,n,r){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=r}static from(t,e,n){Vr(t.mutations.length===n.length);let r=ma;const s=t.mutations;for(let t=0;t<s.length;t++)r=r.insert(s[t].key,n[t].version);return new Ja(t,e,n,r)}}class Za{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return null!==t&&this.mutation===t.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class tu{constructor(t,e,n){this.alias=t,this.aggregateType=e,this.fieldPath=n}}class eu{constructor(t,e){this.count=t,this.unchangedNames=e}}var nu,ru;function su(t){switch(t){default:return Or();case Br.CANCELLED:case Br.UNKNOWN:case Br.DEADLINE_EXCEEDED:case Br.RESOURCE_EXHAUSTED:case Br.INTERNAL:case Br.UNAVAILABLE:case Br.UNAUTHENTICATED:return!1;case Br.INVALID_ARGUMENT:case Br.NOT_FOUND:case Br.ALREADY_EXISTS:case Br.PERMISSION_DENIED:case Br.FAILED_PRECONDITION:case Br.ABORTED:case Br.OUT_OF_RANGE:case Br.UNIMPLEMENTED:case Br.DATA_LOSS:return!0}}function iu(t){if(void 0===t)return Pr("GRPC error has no .code"),Br.UNKNOWN;switch(t){case nu.OK:return Br.OK;case nu.CANCELLED:return Br.CANCELLED;case nu.UNKNOWN:return Br.UNKNOWN;case nu.DEADLINE_EXCEEDED:return Br.DEADLINE_EXCEEDED;case nu.RESOURCE_EXHAUSTED:return Br.RESOURCE_EXHAUSTED;case nu.INTERNAL:return Br.INTERNAL;case nu.UNAVAILABLE:return Br.UNAVAILABLE;case nu.UNAUTHENTICATED:return Br.UNAUTHENTICATED;case nu.INVALID_ARGUMENT:return Br.INVALID_ARGUMENT;case nu.NOT_FOUND:return Br.NOT_FOUND;case nu.ALREADY_EXISTS:return Br.ALREADY_EXISTS;case nu.PERMISSION_DENIED:return Br.PERMISSION_DENIED;case nu.FAILED_PRECONDITION:return Br.FAILED_PRECONDITION;case nu.ABORTED:return Br.ABORTED;case nu.OUT_OF_RANGE:return Br.OUT_OF_RANGE;case nu.UNIMPLEMENTED:return Br.UNIMPLEMENTED;case nu.DATA_LOSS:return Br.DATA_LOSS;default:return Or()}}(ru=nu||(nu={}))[ru.OK=0]="OK",ru[ru.CANCELLED=1]="CANCELLED",ru[ru.UNKNOWN=2]="UNKNOWN",ru[ru.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",ru[ru.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",ru[ru.NOT_FOUND=5]="NOT_FOUND",ru[ru.ALREADY_EXISTS=6]="ALREADY_EXISTS",ru[ru.PERMISSION_DENIED=7]="PERMISSION_DENIED",ru[ru.UNAUTHENTICATED=16]="UNAUTHENTICATED",ru[ru.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",ru[ru.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",ru[ru.ABORTED=10]="ABORTED",ru[ru.OUT_OF_RANGE=11]="OUT_OF_RANGE",ru[ru.UNIMPLEMENTED=12]="UNIMPLEMENTED",ru[ru.INTERNAL=13]="INTERNAL",ru[ru.UNAVAILABLE=14]="UNAVAILABLE",ru[ru.DATA_LOSS=15]="DATA_LOSS";let ou=null;function au(){return new TextEncoder}const uu=new xr([4294967295,4294967295],0);function cu(t){const e=au().encode(t),n=new Sr;return n.update(e),new Uint8Array(n.digest())}function lu(t){const e=new DataView(t.buffer),n=e.getUint32(0,!0),r=e.getUint32(4,!0),s=e.getUint32(8,!0),i=e.getUint32(12,!0);return[new xr([n,r],0),new xr([s,i],0)]}class hu{constructor(t,e,n){if(this.bitmap=t,this.padding=e,this.hashCount=n,e<0||e>=8)throw new du(`Invalid padding: ${e}`);if(n<0)throw new du(`Invalid hash count: ${n}`);if(t.length>0&&0===this.hashCount)throw new du(`Invalid hash count: ${n}`);if(0===t.length&&0!==e)throw new du(`Invalid padding when bitmap length is 0: ${e}`);this.Te=8*t.length-e,this.Ee=xr.fromNumber(this.Te)}de(t,e,n){let r=t.add(e.multiply(xr.fromNumber(n)));return 1===r.compare(uu)&&(r=new xr([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Ee).toNumber()}Ae(t){return!!(this.bitmap[Math.floor(t/8)]&1<<t%8)}mightContain(t){if(0===this.Te)return!1;const e=cu(t),[n,r]=lu(e);for(let t=0;t<this.hashCount;t++){const e=this.de(n,r,t);if(!this.Ae(e))return!1}return!0}static create(t,e,n){const r=t%8==0?0:8-t%8,s=new Uint8Array(Math.ceil(t/8)),i=new hu(s,r,e);return n.forEach((t=>i.insert(t))),i}insert(t){if(0===this.Te)return;const e=cu(t),[n,r]=lu(e);for(let t=0;t<this.hashCount;t++){const e=this.de(n,r,t);this.Re(e)}}Re(t){const e=Math.floor(t/8),n=t%8;this.bitmap[e]|=1<<n}}class du extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class fu{constructor(t,e,n,r,s){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(t,e,n){const r=new Map;return r.set(t,mu.createSynthesizedTargetChangeForCurrentChange(t,e,n)),new fu(is.min(),r,new vi(es),aa(),pa())}}class mu{constructor(t,e,n,r,s){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(t,e,n){return new mu(n,e,pa(),pa(),pa())}}class gu{constructor(t,e,n,r){this.Ve=t,this.removedTargetIds=e,this.key=n,this.me=r}}class pu{constructor(t,e){this.targetId=t,this.fe=e}}class yu{constructor(t,e,n=Di.EMPTY_BYTE_STRING,r=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}}class wu{constructor(){this.ge=0,this.pe=Iu(),this.ye=Di.EMPTY_BYTE_STRING,this.we=!1,this.Se=!0}get current(){return this.we}get resumeToken(){return this.ye}get be(){return 0!==this.ge}get De(){return this.Se}Ce(t){t.approximateByteSize()>0&&(this.Se=!0,this.ye=t)}ve(){let t=pa(),e=pa(),n=pa();return this.pe.forEach(((r,s)=>{switch(s){case 0:t=t.add(r);break;case 2:e=e.add(r);break;case 1:n=n.add(r);break;default:Or()}})),new mu(this.ye,this.we,t,e,n)}Fe(){this.Se=!1,this.pe=Iu()}Me(t,e){this.Se=!0,this.pe=this.pe.insert(t,e)}xe(t){this.Se=!0,this.pe=this.pe.remove(t)}Oe(){this.ge+=1}Ne(){this.ge-=1,Vr(this.ge>=0)}Be(){this.Se=!0,this.we=!0}}class vu{constructor(t){this.Le=t,this.ke=new Map,this.qe=aa(),this.Qe=bu(),this.Ke=new vi(es)}$e(t){for(const e of t.Ve)t.me&&t.me.isFoundDocument()?this.Ue(e,t.me):this.We(e,t.key,t.me);for(const e of t.removedTargetIds)this.We(e,t.key,t.me)}Ge(t){this.forEachTarget(t,(e=>{const n=this.ze(e);switch(t.state){case 0:this.je(e)&&n.Ce(t.resumeToken);break;case 1:n.Ne(),n.be||n.Fe(),n.Ce(t.resumeToken);break;case 2:n.Ne(),n.be||this.removeTarget(e);break;case 3:this.je(e)&&(n.Be(),n.Ce(t.resumeToken));break;case 4:this.je(e)&&(this.He(e),n.Ce(t.resumeToken));break;default:Or()}}))}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.ke.forEach(((t,n)=>{this.je(n)&&e(n)}))}Je(t){const e=t.targetId,n=t.fe.count,r=this.Ye(e);if(r){const s=r.target;if(Vo(s))if(0===n){const t=new ls(s.path);this.We(e,t,uo.newNoDocument(t,is.min()))}else Vr(1===n);else{const r=this.Ze(e);if(r!==n){const n=this.Xe(t),s=n?this.et(n,t,r):1;if(0!==s){this.He(e);const t=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Ke=this.Ke.insert(e,t)}null==ou||ou.tt(function(t,e,n,r,s){var i,o,a,u,c,l;const h={localCacheCount:t,existenceFilterCount:e.count,databaseId:n.database,projectId:n.projectId},d=e.unchangedNames;return d&&(h.bloomFilter={applied:0===s,hashCount:null!==(i=null==d?void 0:d.hashCount)&&void 0!==i?i:0,bitmapLength:null!==(u=null===(a=null===(o=null==d?void 0:d.bits)||void 0===o?void 0:o.bitmap)||void 0===a?void 0:a.length)&&void 0!==u?u:0,padding:null!==(l=null===(c=null==d?void 0:d.bits)||void 0===c?void 0:c.padding)&&void 0!==l?l:0,mightContain:t=>{var e;return null!==(e=null==r?void 0:r.mightContain(t))&&void 0!==e&&e}}),h}(r,t.fe,this.Le.nt(),n,s))}}}}Xe(t){const e=t.fe.unchangedNames;if(!e||!e.bits)return null;const{bits:{bitmap:n="",padding:r=0},hashCount:s=0}=e;let i,o;try{i=Ri(n).toUint8Array()}catch(t){if(t instanceof xi)return Lr("Decoding the base64 bloom filter in existence filter failed ("+t.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw t}try{o=new hu(i,r,s)}catch(t){return Lr(t instanceof du?"BloomFilter error: ":"Applying bloom filter failed: ",t),null}return 0===o.Te?null:o}et(t,e,n){return e.fe.count===n-this.rt(t,e.targetId)?0:2}rt(t,e){const n=this.Le.getRemoteKeysForTarget(e);let r=0;return n.forEach((n=>{const s=this.Le.nt(),i=`projects/${s.projectId}/databases/${s.database}/documents/${n.path.canonicalString()}`;t.mightContain(i)||(this.We(e,n,null),r++)})),r}it(t){const e=new Map;this.ke.forEach(((n,r)=>{const s=this.Ye(r);if(s){if(n.current&&Vo(s.target)){const e=new ls(s.target.path);null!==this.qe.get(e)||this.st(r,e)||this.We(r,e,uo.newNoDocument(e,t))}n.De&&(e.set(r,n.ve()),n.Fe())}}));let n=pa();this.Qe.forEach(((t,e)=>{let r=!0;e.forEachWhile((t=>{const e=this.Ye(t);return!e||"TargetPurposeLimboResolution"===e.purpose||(r=!1,!1)})),r&&(n=n.add(t))})),this.qe.forEach(((e,n)=>n.setReadTime(t)));const r=new fu(t,e,this.Ke,this.qe,n);return this.qe=aa(),this.Qe=bu(),this.Ke=new vi(es),r}Ue(t,e){if(!this.je(t))return;const n=this.st(t,e.key)?2:0;this.ze(t).Me(e.key,n),this.qe=this.qe.insert(e.key,e),this.Qe=this.Qe.insert(e.key,this.ot(e.key).add(t))}We(t,e,n){if(!this.je(t))return;const r=this.ze(t);this.st(t,e)?r.Me(e,1):r.xe(e),this.Qe=this.Qe.insert(e,this.ot(e).delete(t)),n&&(this.qe=this.qe.insert(e,n))}removeTarget(t){this.ke.delete(t)}Ze(t){const e=this.ze(t).ve();return this.Le.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Oe(t){this.ze(t).Oe()}ze(t){let e=this.ke.get(t);return e||(e=new wu,this.ke.set(t,e)),e}ot(t){let e=this.Qe.get(t);return e||(e=new _i(es),this.Qe=this.Qe.insert(t,e)),e}je(t){const e=null!==this.Ye(t);return e||Mr("WatchChangeAggregator","Detected inactive target",t),e}Ye(t){const e=this.ke.get(t);return e&&e.be?null:this.Le._t(t)}He(t){this.ke.set(t,new wu),this.Le.getRemoteKeysForTarget(t).forEach((e=>{this.We(t,e,null)}))}st(t,e){return this.Le.getRemoteKeysForTarget(t).has(e)}}function bu(){return new vi(ls.comparator)}function Iu(){return new vi(ls.comparator)}const _u={asc:"ASCENDING",desc:"DESCENDING"},Tu={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Eu={and:"AND",or:"OR"};class Su{constructor(t,e){this.databaseId=t,this.useProto3Json=e}}function xu(t,e){return t.useProto3Json||Vs(e)?e:{value:e}}function Cu(t,e){return t.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function Du(t,e){return t.useProto3Json?e.toBase64():e.toUint8Array()}function Au(t,e){return Cu(t,e.toTimestamp())}function Nu(t){return Vr(!!t),is.fromTimestamp(function(t){const e=Ni(t);return new ss(e.seconds,e.nanos)}(t))}function ku(t,e){return Ru(t,e).canonicalString()}function Ru(t,e){const n=function(t){return new as(["projects",t.projectId,"databases",t.database])}(t).child("documents");return void 0===e?n:n.child(e)}function Mu(t){const e=as.fromString(t);return Vr(ec(e)),e}function Pu(t,e){return ku(t.databaseId,e.path)}function Lu(t,e){const n=Mu(e);if(n.get(1)!==t.databaseId.projectId)throw new zr(Br.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new zr(Br.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new ls(qu(n))}function Fu(t,e){return ku(t.databaseId,e)}function Ou(t){const e=Mu(t);return 4===e.length?as.emptyPath():qu(e)}function Vu(t){return new as(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function qu(t){return Vr(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function Uu(t,e,n){return{name:Pu(t,e),fields:n.value.mapValue.fields}}function Bu(t,e,n){const r=Lu(t,e.name),s=Nu(e.updateTime),i=e.createTime?Nu(e.createTime):is.min(),o=new oo({mapValue:{fields:e.fields}}),a=uo.newFoundDocument(r,s,i,o);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function zu(t,e){let n;if(e instanceof Ga)n={update:Uu(t,e.key,e.value)};else if(e instanceof Ha)n={delete:Pu(t,e.key)};else if(e instanceof ja)n={update:Uu(t,e.key,e.data),updateMask:tc(e.fieldMask)};else{if(!(e instanceof Ya))return Or();n={verify:Pu(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((t=>function(t,e){const n=e.transform;if(n instanceof xa)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof Ca)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof Aa)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof ka)return{fieldPath:e.field.canonicalString(),increment:n.Ie};throw Or()}(0,t)))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:Au(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:Or()}(t,e.precondition)),n}function Ku(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?Fa.updateTime(Nu(t.updateTime)):void 0!==t.exists?Fa.exists(t.exists):Fa.none()}(e.currentDocument):Fa.none(),r=e.updateTransforms?e.updateTransforms.map((e=>function(t,e){let n=null;if("setToServerValue"in e)Vr("REQUEST_TIME"===e.setToServerValue),n=new xa;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new Ca(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new Aa(t)}else"increment"in e?n=new ka(t,e.increment):Or();const r=cs.fromServerFormat(e.fieldPath);return new Pa(r,n)}(t,e))):[];if(e.update){e.update.name;const s=Lu(t,e.update.name),i=new oo({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new Si(e.map((t=>cs.fromServerFormat(t))))}(e.updateMask);return new ja(s,i,t,n,r)}return new Ga(s,i,n,r)}if(e.delete){const r=Lu(t,e.delete);return new Ha(r,n)}if(e.verify){const r=Lu(t,e.verify);return new Ya(r,n)}return Or()}function Gu(t,e){return{documents:[Fu(t,e.path)]}}function ju(t,e){const n={structuredQuery:{}},r=e.path;let s;null!==e.collectionGroup?(s=r,n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(s=r.popLast(),n.structuredQuery.from=[{collectionId:r.lastSegment()}]),n.parent=Fu(t,s);const i=function(t){if(0!==t.length)return Zu(yo.create(t,"and"))}(e.filters);i&&(n.structuredQuery.where=i);const o=function(t){if(0!==t.length)return t.map((t=>function(t){return{field:Xu(t.field),direction:Wu(t.dir)}}(t)))}(e.orderBy);o&&(n.structuredQuery.orderBy=o);const a=xu(t,e.limit);return null!==a&&(n.structuredQuery.limit=a),e.startAt&&(n.structuredQuery.startAt=function(t){return{before:t.inclusive,values:t.position}}(e.startAt)),e.endAt&&(n.structuredQuery.endAt=function(t){return{before:!t.inclusive,values:t.position}}(e.endAt)),{ut:n,parent:s}}function $u(t){let e=Ou(t.parent);const n=t.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){Vr(1===r);const t=n.from[0];t.allDescendants?s=t.collectionId:e=e.child(t.collectionId)}let i=[];n.where&&(i=function(t){const e=Qu(t);return e instanceof yo&&bo(e)?e.getFilters():[e]}(n.where));let o=[];n.orderBy&&(o=function(t){return t.map((t=>function(t){return new fo(Ju(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t)))}(n.orderBy));let a=null;n.limit&&(a=function(t){let e;return e="object"==typeof t?t.value:t,Vs(e)?null:e}(n.limit));let u=null;n.startAt&&(u=function(t){const e=!!t.before,n=t.values||[];return new co(n,e)}(n.startAt));let c=null;return n.endAt&&(c=function(t){const e=!t.before,n=t.values||[];return new co(n,e)}(n.endAt)),Ko(e,s,o,i,a,"F",u,c)}function Qu(t){return void 0!==t.unaryFilter?function(t){switch(t.unaryFilter.op){case"IS_NAN":const e=Ju(t.unaryFilter.field);return po.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=Ju(t.unaryFilter.field);return po.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Ju(t.unaryFilter.field);return po.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=Ju(t.unaryFilter.field);return po.create(s,"!=",{nullValue:"NULL_VALUE"});default:return Or()}}(t):void 0!==t.fieldFilter?function(t){return po.create(Ju(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Or()}}(t.fieldFilter.op),t.fieldFilter.value)}(t):void 0!==t.compositeFilter?function(t){return yo.create(t.compositeFilter.filters.map((t=>Qu(t))),function(t){switch(t){case"AND":return"and";case"OR":return"or";default:return Or()}}(t.compositeFilter.op))}(t):Or()}function Wu(t){return _u[t]}function Hu(t){return Tu[t]}function Yu(t){return Eu[t]}function Xu(t){return{fieldPath:t.canonicalString()}}function Ju(t){return cs.fromServerFormat(t.fieldPath)}function Zu(t){return t instanceof po?function(t){if("=="===t.op){if(Ji(t.value))return{unaryFilter:{field:Xu(t.field),op:"IS_NAN"}};if(Xi(t.value))return{unaryFilter:{field:Xu(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(Ji(t.value))return{unaryFilter:{field:Xu(t.field),op:"IS_NOT_NAN"}};if(Xi(t.value))return{unaryFilter:{field:Xu(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Xu(t.field),op:Hu(t.op),value:t.value}}}(t):t instanceof yo?function(t){const e=t.getFilters().map((t=>Zu(t)));return 1===e.length?e[0]:{compositeFilter:{op:Yu(t.op),filters:e}}}(t):Or()}function tc(t){const e=[];return t.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function ec(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}class nc{constructor(t,e,n,r,s=is.min(),i=is.min(),o=Di.EMPTY_BYTE_STRING,a=null){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o,this.expectedCount=a}withSequenceNumber(t){return new nc(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(t,e){return new nc(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t,null)}withExpectedCount(t){return new nc(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}withLastLimboFreeSnapshotVersion(t){return new nc(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}}class rc{constructor(t){this.ct=t}}function sc(t,e){const n=e.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:ic(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())r.document=function(t,e){return{name:Pu(t,e.key),fields:e.data.value.mapValue.fields,updateTime:Cu(t,e.version.toTimestamp()),createTime:Cu(t,e.createTime.toTimestamp())}}(t.ct,e);else if(e.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:oc(e.version)};else{if(!e.isUnknownDocument())return Or();r.unknownDocument={path:n.path.toArray(),version:oc(e.version)}}return r}function ic(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function oc(t){const e=t.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function ac(t){const e=new ss(t.seconds,t.nanoseconds);return is.fromTimestamp(e)}function uc(t,e){const n=(e.baseMutations||[]).map((e=>Ku(t.ct,e)));for(let t=0;t<e.mutations.length-1;++t){const n=e.mutations[t];if(t+1<e.mutations.length&&void 0!==e.mutations[t+1].transform){const r=e.mutations[t+1];n.updateTransforms=r.transform.fieldTransforms,e.mutations.splice(t+1,1),++t}}const r=e.mutations.map((e=>Ku(t.ct,e))),s=ss.fromMillis(e.localWriteTimeMs);return new Xa(e.batchId,s,n,r)}function cc(t){const e=ac(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?ac(t.lastLimboFreeSnapshotVersion):is.min();let r;return r=function(t){return void 0!==t.documents}(t.query)?function(t){return Vr(1===t.documents.length),Wo(Go(Ou(t.documents[0])))}(t.query):function(t){return Wo($u(t))}(t.query),new nc(r,t.targetId,"TargetPurposeListen",t.lastListenSequenceNumber,e,n,Di.fromBase64String(t.resumeToken))}function lc(t,e){const n=oc(e.snapshotVersion),r=oc(e.lastLimboFreeSnapshotVersion);let s;s=Vo(e.target)?Gu(t.ct,e.target):ju(t.ct,e.target).ut;const i=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:Fo(e.target),readTime:n,resumeToken:i,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function hc(t){const e=$u({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?Xo(e,e.limit,"L"):e}function dc(t,e){return new Za(e.largestBatchId,Ku(t.ct,e.overlayMutation))}function fc(t,e){const n=e.path.lastSegment();return[t,Bs(e.path.popLast()),n]}function mc(t,e,n,r){return{indexId:t,uid:e,sequenceNumber:n,readTime:oc(r.readTime),documentKey:Bs(r.documentKey.path),largestBatchId:r.largestBatchId}}class gc{getBundleMetadata(t,e){return pc(t).get(e).next((t=>{if(t)return function(t){return{id:t.bundleId,createTime:ac(t.createTime),version:t.version}}(t)}))}saveBundleMetadata(t,e){return pc(t).put(function(t){return{bundleId:t.id,createTime:oc(Nu(t.createTime)),version:t.version}}(e))}getNamedQuery(t,e){return yc(t).get(e).next((t=>{if(t)return function(t){return{name:t.name,query:hc(t.bundledQuery),readTime:ac(t.readTime)}}(t)}))}saveNamedQuery(t,e){return yc(t).put(function(t){return{name:t.name,readTime:oc(Nu(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function pc(t){return gi(t,"bundles")}function yc(t){return gi(t,"namedQueries")}class wc{constructor(t,e){this.serializer=t,this.userId=e}static lt(t,e){const n=e.uid||"";return new wc(t,n)}getOverlay(t,e){return vc(t).get(fc(this.userId,e)).next((t=>t?dc(this.serializer,t):null))}getOverlays(t,e){const n=ha();return Ss.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){const r=[];return n.forEach(((n,s)=>{const i=new Za(e,s);r.push(this.ht(t,i))})),Ss.waitFor(r)}removeOverlaysForBatchId(t,e,n){const r=new Set;e.forEach((t=>r.add(Bs(t.getCollectionPath()))));const s=[];return r.forEach((e=>{const r=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);s.push(vc(t).H("collectionPathOverlayIndex",r))})),Ss.waitFor(s)}getOverlaysForCollection(t,e,n){const r=ha(),s=Bs(e),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return vc(t).W("collectionPathOverlayIndex",i).next((t=>{for(const e of t){const t=dc(this.serializer,e);r.set(t.getKey(),t)}return r}))}getOverlaysForCollectionGroup(t,e,n,r){const s=ha();let i;const o=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,Number.POSITIVE_INFINITY],!0);return vc(t).Y({index:"collectionGroupOverlayIndex",range:o},((t,e,n)=>{const o=dc(this.serializer,e);s.size()<r||o.largestBatchId===i?(s.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>s))}ht(t,e){return vc(t).put(function(t,e,n){const[r,s,i]=fc(e,n.mutation.key);return{userId:e,collectionPath:s,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:zu(t.ct,n.mutation)}}(this.serializer,this.userId,e))}}function vc(t){return gi(t,"documentOverlays")}class bc{constructor(){}Pt(t,e){this.It(t,e),e.Tt()}It(t,e){if("nullValue"in t)this.Et(e,5);else if("booleanValue"in t)this.Et(e,10),e.dt(t.booleanValue?1:0);else if("integerValue"in t)this.Et(e,15),e.dt(ki(t.integerValue));else if("doubleValue"in t){const n=ki(t.doubleValue);isNaN(n)?this.Et(e,13):(this.Et(e,15),qs(n)?e.dt(0):e.dt(n))}else if("timestampValue"in t){const n=t.timestampValue;this.Et(e,20),"string"==typeof n?e.At(n):(e.At(`${n.seconds||""}`),e.dt(n.nanos||0))}else if("stringValue"in t)this.Rt(t.stringValue,e),this.Vt(e);else if("bytesValue"in t)this.Et(e,30),e.ft(Ri(t.bytesValue)),this.Vt(e);else if("referenceValue"in t)this.gt(t.referenceValue,e);else if("geoPointValue"in t){const n=t.geoPointValue;this.Et(e,45),e.dt(n.latitude||0),e.dt(n.longitude||0)}else"mapValue"in t?eo(t)?this.Et(e,Number.MAX_SAFE_INTEGER):(this.yt(t.mapValue,e),this.Vt(e)):"arrayValue"in t?(this.wt(t.arrayValue,e),this.Vt(e)):Or()}Rt(t,e){this.Et(e,25),this.St(t,e)}St(t,e){e.At(t)}yt(t,e){const n=t.fields||{};this.Et(e,55);for(const t of Object.keys(n))this.Rt(t,e),this.It(n[t],e)}wt(t,e){const n=t.values||[];this.Et(e,50);for(const t of n)this.It(t,e)}gt(t,e){this.Et(e,37),ls.fromName(t).path.forEach((t=>{this.Et(e,60),this.St(t,e)}))}Et(t,e){t.dt(e)}Vt(t){t.dt(2)}}function Ic(t){if(0===t)return 8;let e=0;return!(t>>4)&&(e+=4,t<<=4),!(t>>6)&&(e+=2,t<<=2),!(t>>7)&&(e+=1),e}function _c(t){const e=64-function(t){let e=0;for(let n=0;n<8;++n){const r=Ic(255&t[n]);if(e+=r,8!==r)break}return e}(t);return Math.ceil(e/8)}bc.bt=new bc;class Tc{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Dt(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Ct(n.value),n=e.next();this.vt()}Ft(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Mt(n.value),n=e.next();this.xt()}Ot(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Ct(t);else if(t<2048)this.Ct(960|t>>>6),this.Ct(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Ct(480|t>>>12),this.Ct(128|63&t>>>6),this.Ct(128|63&t);else{const t=e.codePointAt(0);this.Ct(240|t>>>18),this.Ct(128|63&t>>>12),this.Ct(128|63&t>>>6),this.Ct(128|63&t)}}this.vt()}Nt(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Mt(t);else if(t<2048)this.Mt(960|t>>>6),this.Mt(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Mt(480|t>>>12),this.Mt(128|63&t>>>6),this.Mt(128|63&t);else{const t=e.codePointAt(0);this.Mt(240|t>>>18),this.Mt(128|63&t>>>12),this.Mt(128|63&t>>>6),this.Mt(128|63&t)}}this.xt()}Bt(t){const e=this.Lt(t),n=_c(e);this.kt(1+n),this.buffer[this.position++]=255&n;for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=255&e[t]}qt(t){const e=this.Lt(t),n=_c(e);this.kt(1+n),this.buffer[this.position++]=~(255&n);for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=~(255&e[t])}Qt(){this.Kt(255),this.Kt(255)}$t(){this.Ut(255),this.Ut(255)}reset(){this.position=0}seed(t){this.kt(t.length),this.buffer.set(t,this.position),this.position+=t.length}Wt(){return this.buffer.slice(0,this.position)}Lt(t){const e=function(t){const e=new DataView(new ArrayBuffer(8));return e.setFloat64(0,t,!1),new Uint8Array(e.buffer)}(t),n=!!(128&e[0]);e[0]^=n?255:128;for(let t=1;t<e.length;++t)e[t]^=n?255:0;return e}Ct(t){const e=255&t;0===e?(this.Kt(0),this.Kt(255)):255===e?(this.Kt(255),this.Kt(0)):this.Kt(e)}Mt(t){const e=255&t;0===e?(this.Ut(0),this.Ut(255)):255===e?(this.Ut(255),this.Ut(0)):this.Ut(t)}vt(){this.Kt(0),this.Kt(1)}xt(){this.Ut(0),this.Ut(1)}Kt(t){this.kt(1),this.buffer[this.position++]=t}Ut(t){this.kt(1),this.buffer[this.position++]=~t}kt(t){const e=t+this.position;if(e<=this.buffer.length)return;let n=2*this.buffer.length;n<e&&(n=e);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class Ec{constructor(t){this.Gt=t}ft(t){this.Gt.Dt(t)}At(t){this.Gt.Ot(t)}dt(t){this.Gt.Bt(t)}Tt(){this.Gt.Qt()}}class Sc{constructor(t){this.Gt=t}ft(t){this.Gt.Ft(t)}At(t){this.Gt.Nt(t)}dt(t){this.Gt.qt(t)}Tt(){this.Gt.$t()}}class xc{constructor(){this.Gt=new Tc,this.zt=new Ec(this.Gt),this.jt=new Sc(this.Gt)}seed(t){this.Gt.seed(t)}Ht(t){return 0===t?this.zt:this.jt}Wt(){return this.Gt.Wt()}reset(){this.Gt.reset()}}class Cc{constructor(t,e,n,r){this.indexId=t,this.documentKey=e,this.arrayValue=n,this.directionalValue=r}Jt(){const t=this.directionalValue.length,e=0===t||255===this.directionalValue[t-1]?t+1:t,n=new Uint8Array(e);return n.set(this.directionalValue,0),e!==t?n.set([0],this.directionalValue.length):++n[n.length-1],new Cc(this.indexId,this.documentKey,this.arrayValue,n)}}function Dc(t,e){let n=t.indexId-e.indexId;return 0!==n?n:(n=Ac(t.arrayValue,e.arrayValue),0!==n?n:(n=Ac(t.directionalValue,e.directionalValue),0!==n?n:ls.comparator(t.documentKey,e.documentKey)))}function Ac(t,e){for(let n=0;n<t.length&&n<e.length;++n){const r=t[n]-e[n];if(0!==r)return r}return t.length-e.length}class Nc{constructor(t){this.Yt=new _i(((t,e)=>cs.comparator(t.field,e.field))),this.collectionId=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment(),this.Zt=t.orderBy,this.Xt=[];for(const e of t.filters){const t=e;t.isInequality()?this.Yt=this.Yt.add(t):this.Xt.push(t)}}get en(){return this.Yt.size>1}tn(t){if(Vr(t.collectionGroup===this.collectionId),this.en)return!1;const e=ds(t);if(void 0!==e&&!this.nn(e))return!1;const n=fs(t);let r=new Set,s=0,i=0;for(;s<n.length&&this.nn(n[s]);++s)r=r.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(this.Yt.size>0){const t=this.Yt.getIterator().getNext();if(!r.has(t.field.canonicalString())){const e=n[s];if(!this.rn(t,e)||!this.sn(this.Zt[i++],e))return!1}++s}for(;s<n.length;++s){const t=n[s];if(i>=this.Zt.length||!this.sn(this.Zt[i++],t))return!1}return!0}on(){if(this.en)return null;let t=new _i(cs.comparator);const e=[];for(const n of this.Xt)if(!n.field.isKeyField())if("array-contains"===n.op||"array-contains-any"===n.op)e.push(new gs(n.field,2));else{if(t.has(n.field))continue;t=t.add(n.field),e.push(new gs(n.field,0))}for(const n of this.Zt)n.field.isKeyField()||t.has(n.field)||(t=t.add(n.field),e.push(new gs(n.field,"asc"===n.dir?0:1)));return new hs(hs.UNKNOWN_ID,this.collectionId,e,ys.empty())}nn(t){for(const e of this.Xt)if(this.rn(e,t))return!0;return!1}rn(t,e){if(void 0===t||!t.field.isEqual(e.fieldPath))return!1;const n="array-contains"===t.op||"array-contains-any"===t.op;return 2===e.kind===n}sn(t,e){return!!t.field.isEqual(e.fieldPath)&&(0===e.kind&&"asc"===t.dir||1===e.kind&&"desc"===t.dir)}}function kc(t){var e,n;if(Vr(t instanceof po||t instanceof yo),t instanceof po){if(t instanceof ko){const r=(null===(n=null===(e=t.value.arrayValue)||void 0===e?void 0:e.values)||void 0===n?void 0:n.map((e=>po.create(t.field,"==",e))))||[];return yo.create(r,"or")}return t}const r=t.filters.map((t=>kc(t)));return yo.create(r,t.op)}function Rc(t){if(0===t.getFilters().length)return[];const e=Fc(kc(t));return Vr(Lc(e)),Mc(e)||Pc(e)?[e]:e.getFilters()}function Mc(t){return t instanceof po}function Pc(t){return t instanceof yo&&bo(t)}function Lc(t){return Mc(t)||Pc(t)||function(t){if(t instanceof yo&&vo(t)){for(const e of t.getFilters())if(!Mc(e)&&!Pc(e))return!1;return!0}return!1}(t)}function Fc(t){if(Vr(t instanceof po||t instanceof yo),t instanceof po)return t;if(1===t.filters.length)return Fc(t.filters[0]);const e=t.filters.map((t=>Fc(t)));let n=yo.create(e,t.op);return n=qc(n),Lc(n)?n:(Vr(n instanceof yo),Vr(wo(n)),Vr(n.filters.length>1),n.filters.reduce(((t,e)=>Oc(t,e))))}function Oc(t,e){let n;return Vr(t instanceof po||t instanceof yo),Vr(e instanceof po||e instanceof yo),n=t instanceof po?e instanceof po?function(t,e){return yo.create([t,e],"and")}(t,e):Vc(t,e):e instanceof po?Vc(e,t):function(t,e){if(Vr(t.filters.length>0&&e.filters.length>0),wo(t)&&wo(e))return Eo(t,e.getFilters());const n=vo(t)?t:e,r=vo(t)?e:t,s=n.filters.map((t=>Oc(t,r)));return yo.create(s,"or")}(t,e),qc(n)}function Vc(t,e){if(wo(e))return Eo(e,t.getFilters());{const n=e.filters.map((e=>Oc(t,e)));return yo.create(n,"or")}}function qc(t){if(Vr(t instanceof po||t instanceof yo),t instanceof po)return t;const e=t.getFilters();if(1===e.length)return qc(e[0]);if(Io(t))return t;const n=e.map((t=>qc(t))),r=[];return n.forEach((e=>{e instanceof po?r.push(e):e instanceof yo&&(e.op===t.op?r.push(...e.filters):r.push(e))})),1===r.length?r[0]:yo.create(r,t.op)}class Uc{constructor(){this._n=new Bc}addToCollectionParentIndex(t,e){return this._n.add(e),Ss.resolve()}getCollectionParents(t,e){return Ss.resolve(this._n.getEntries(e))}addFieldIndex(t,e){return Ss.resolve()}deleteFieldIndex(t,e){return Ss.resolve()}deleteAllFieldIndexes(t){return Ss.resolve()}createTargetIndexes(t,e){return Ss.resolve()}getDocumentsMatchingTarget(t,e){return Ss.resolve(null)}getIndexType(t,e){return Ss.resolve(0)}getFieldIndexes(t,e){return Ss.resolve([])}getNextCollectionGroupToUpdate(t){return Ss.resolve(null)}getMinOffset(t,e){return Ss.resolve(bs.min())}getMinOffsetFromCollectionGroup(t,e){return Ss.resolve(bs.min())}updateCollectionGroup(t,e,n){return Ss.resolve()}updateIndexEntries(t,e){return Ss.resolve()}}class Bc{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new _i(as.comparator),s=!r.has(n);return this.index[e]=r.add(n),s}has(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e];return r&&r.has(n)}getEntries(t){return(this.index[t]||new _i(as.comparator)).toArray()}}const zc=new Uint8Array(0);class Kc{constructor(t,e){this.databaseId=e,this.an=new Bc,this.un=new ia((t=>Fo(t)),((t,e)=>Oo(t,e))),this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this.an.has(e)){const n=e.lastSegment(),r=e.popLast();t.addOnCommittedListener((()=>{this.an.add(e)}));const s={collectionId:n,parent:Bs(r)};return Gc(t).put(s)}return Ss.resolve()}getCollectionParents(t,e){const n=[],r=IDBKeyRange.bound([e,""],[rs(e),""],!1,!0);return Gc(t).W(r).next((t=>{for(const r of t){if(r.collectionId!==e)break;n.push(Gs(r.parent))}return n}))}addFieldIndex(t,e){const n=$c(t),r=function(t){return{indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map((t=>[t.fieldPath.canonicalString(),t.kind]))}}(e);delete r.indexId;const s=n.add(r);if(e.indexState){const n=Qc(t);return s.next((t=>{n.put(mc(t,this.uid,e.indexState.sequenceNumber,e.indexState.offset))}))}return s.next()}deleteFieldIndex(t,e){const n=$c(t),r=Qc(t),s=jc(t);return n.delete(e.indexId).next((()=>r.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))).next((()=>s.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))))}deleteAllFieldIndexes(t){const e=$c(t),n=jc(t),r=Qc(t);return e.H().next((()=>n.H())).next((()=>r.H()))}createTargetIndexes(t,e){return Ss.forEach(this.cn(e),(e=>this.getIndexType(t,e).next((n=>{if(0===n||1===n){const n=new Nc(e).on();if(null!=n)return this.addFieldIndex(t,n)}}))))}getDocumentsMatchingTarget(t,e){const n=jc(t);let r=!0;const s=new Map;return Ss.forEach(this.cn(e),(e=>this.ln(t,e).next((t=>{r&&(r=!!t),s.set(e,t)})))).next((()=>{if(r){let t=pa();const r=[];return Ss.forEach(s,((s,i)=>{Mr("IndexedDbIndexManager",`Using index ${function(t){return`id=${t.indexId}|cg=${t.collectionGroup}|f=${t.fields.map((t=>`${t.fieldPath}:${t.kind}`)).join(",")}`}(s)} to execute ${Fo(e)}`);const o=function(t,e){const n=ds(e);if(void 0===n)return null;for(const e of qo(t,n.fieldPath))switch(e.op){case"array-contains-any":return e.value.arrayValue.values||[];case"array-contains":return[e.value]}return null}(i,s),a=function(t,e){const n=new Map;for(const r of fs(e))for(const e of qo(t,r.fieldPath))switch(e.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),e.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),e.value),Array.from(n.values())}return null}(i,s),u=function(t,e){const n=[];let r=!0;for(const s of fs(e)){const e=0===s.kind?Uo(t,s.fieldPath,t.startAt):Bo(t,s.fieldPath,t.startAt);n.push(e.value),r&&(r=e.inclusive)}return new co(n,r)}(i,s),c=function(t,e){const n=[];let r=!0;for(const s of fs(e)){const e=0===s.kind?Bo(t,s.fieldPath,t.endAt):Uo(t,s.fieldPath,t.endAt);n.push(e.value),r&&(r=e.inclusive)}return new co(n,r)}(i,s),l=this.hn(s,i,u),h=this.hn(s,i,c),d=this.Pn(s,i,a),f=this.In(s.indexId,o,l,u.inclusive,h,c.inclusive,d);return Ss.forEach(f,(s=>n.j(s,e.limit).next((e=>{e.forEach((e=>{const n=ls.fromSegments(e.documentKey);t.has(n)||(t=t.add(n),r.push(n))}))}))))})).next((()=>r))}return Ss.resolve(null)}))}cn(t){let e=this.un.get(t);return e||(e=0===t.filters.length?[t]:Rc(yo.create(t.filters,"and")).map((e=>Lo(t.path,t.collectionGroup,t.orderBy,e.getFilters(),t.limit,t.startAt,t.endAt))),this.un.set(t,e),e)}In(t,e,n,r,s,i,o){const a=(null!=e?e.length:1)*Math.max(n.length,s.length),u=a/(null!=e?e.length:1),c=[];for(let l=0;l<a;++l){const a=e?this.Tn(e[l/u]):zc,h=this.En(t,a,n[l%u],r),d=this.dn(t,a,s[l%u],i),f=o.map((e=>this.En(t,a,e,!0)));c.push(...this.createRange(h,d,f))}return c}En(t,e,n,r){const s=new Cc(t,ls.empty(),e,n);return r?s:s.Jt()}dn(t,e,n,r){const s=new Cc(t,ls.empty(),e,n);return r?s.Jt():s}ln(t,e){const n=new Nc(e),r=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment();return this.getFieldIndexes(t,r).next((t=>{let e=null;for(const r of t)n.tn(r)&&(!e||r.fields.length>e.fields.length)&&(e=r);return e}))}getIndexType(t,e){let n=2;const r=this.cn(e);return Ss.forEach(r,(e=>this.ln(t,e).next((t=>{t?0!==n&&t.fields.length<function(t){let e=new _i(cs.comparator),n=!1;for(const r of t.filters)for(const t of r.getFlattenedFilters())t.field.isKeyField()||("array-contains"===t.op||"array-contains-any"===t.op?n=!0:e=e.add(t.field));for(const n of t.orderBy)n.field.isKeyField()||(e=e.add(n.field));return e.size+(n?1:0)}(e)&&(n=1):n=0})))).next((()=>function(t){return null!==t.limit}(e)&&r.length>1&&2===n?1:n))}An(t,e){const n=new xc;for(const r of fs(t)){const t=e.data.field(r.fieldPath);if(null==t)return null;const s=n.Ht(r.kind);bc.bt.Pt(t,s)}return n.Wt()}Tn(t){const e=new xc;return bc.bt.Pt(t,e.Ht(0)),e.Wt()}Rn(t,e){const n=new xc;return bc.bt.Pt(Wi(this.databaseId,e),n.Ht(function(t){const e=fs(t);return 0===e.length?0:e[e.length-1].kind}(t))),n.Wt()}Pn(t,e,n){if(null===n)return[];let r=[];r.push(new xc);let s=0;for(const i of fs(t)){const t=n[s++];for(const n of r)if(this.Vn(e,i.fieldPath)&&Yi(t))r=this.mn(r,i,t);else{const e=n.Ht(i.kind);bc.bt.Pt(t,e)}}return this.fn(r)}hn(t,e,n){return this.Pn(t,e,n.position)}fn(t){const e=[];for(let n=0;n<t.length;++n)e[n]=t[n].Wt();return e}mn(t,e,n){const r=[...t],s=[];for(const t of n.arrayValue.values||[])for(const n of r){const r=new xc;r.seed(n.Wt()),bc.bt.Pt(t,r.Ht(e.kind)),s.push(r)}return s}Vn(t,e){return!!t.filters.find((t=>t instanceof po&&t.field.isEqual(e)&&("in"===t.op||"not-in"===t.op)))}getFieldIndexes(t,e){const n=$c(t),r=Qc(t);return(e?n.W("collectionGroupIndex",IDBKeyRange.bound(e,e)):n.W()).next((t=>{const e=[];return Ss.forEach(t,(t=>r.get([t.indexId,this.uid]).next((n=>{e.push(function(t,e){const n=e?new ys(e.sequenceNumber,new bs(ac(e.readTime),new ls(Gs(e.documentKey)),e.largestBatchId)):ys.empty(),r=t.fields.map((([t,e])=>new gs(cs.fromServerFormat(t),e)));return new hs(t.indexId,t.collectionGroup,r,n)}(t,n))})))).next((()=>e))}))}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next((t=>0===t.length?null:(t.sort(((t,e)=>{const n=t.indexState.sequenceNumber-e.indexState.sequenceNumber;return 0!==n?n:es(t.collectionGroup,e.collectionGroup)})),t[0].collectionGroup)))}updateCollectionGroup(t,e,n){const r=$c(t),s=Qc(t);return this.gn(t).next((t=>r.W("collectionGroupIndex",IDBKeyRange.bound(e,e)).next((e=>Ss.forEach(e,(e=>s.put(mc(e.indexId,this.uid,t,n))))))))}updateIndexEntries(t,e){const n=new Map;return Ss.forEach(e,((e,r)=>{const s=n.get(e.collectionGroup);return(s?Ss.resolve(s):this.getFieldIndexes(t,e.collectionGroup)).next((s=>(n.set(e.collectionGroup,s),Ss.forEach(s,(n=>this.pn(t,e,n).next((e=>{const s=this.yn(r,n);return e.isEqual(s)?Ss.resolve():this.wn(t,r,n,e,s)})))))))}))}Sn(t,e,n,r){return jc(t).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.Rn(n,e.key),documentKey:e.key.path.toArray()})}bn(t,e,n,r){return jc(t).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.Rn(n,e.key),e.key.path.toArray()])}pn(t,e,n){const r=jc(t);let s=new _i(Dc);return r.Y({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.Rn(n,e)])},((t,r)=>{s=s.add(new Cc(n.indexId,e,r.arrayValue,r.directionalValue))})).next((()=>s))}yn(t,e){let n=new _i(Dc);const r=this.An(e,t);if(null==r)return n;const s=ds(e);if(null!=s){const i=t.data.field(s.fieldPath);if(Yi(i))for(const s of i.arrayValue.values||[])n=n.add(new Cc(e.indexId,t.key,this.Tn(s),r))}else n=n.add(new Cc(e.indexId,t.key,zc,r));return n}wn(t,e,n,r,s){Mr("IndexedDbIndexManager","Updating index entries for document '%s'",e.key);const i=[];return function(t,e,n,r,s){const i=t.getIterator(),o=e.getIterator();let a=Ei(i),u=Ei(o);for(;a||u;){let t=!1,e=!1;if(a&&u){const r=n(a,u);r<0?e=!0:r>0&&(t=!0)}else null!=a?e=!0:t=!0;t?(r(u),u=Ei(o)):e?(s(a),a=Ei(i)):(a=Ei(i),u=Ei(o))}}(r,s,Dc,(r=>{i.push(this.Sn(t,e,n,r))}),(r=>{i.push(this.bn(t,e,n,r))})),Ss.waitFor(i)}gn(t){let e=1;return Qc(t).Y({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((t,n,r)=>{r.done(),e=n.sequenceNumber+1})).next((()=>e))}createRange(t,e,n){n=n.sort(((t,e)=>Dc(t,e))).filter(((t,e,n)=>!e||0!==Dc(t,n[e-1])));const r=[];r.push(t);for(const s of n){const n=Dc(s,t),i=Dc(s,e);if(0===n)r[0]=t.Jt();else if(n>0&&i<0)r.push(s),r.push(s.Jt());else if(i>0)break}r.push(e);const s=[];for(let t=0;t<r.length;t+=2){if(this.Dn(r[t],r[t+1]))return[];const e=[r[t].indexId,this.uid,r[t].arrayValue,r[t].directionalValue,zc,[]],n=[r[t+1].indexId,this.uid,r[t+1].arrayValue,r[t+1].directionalValue,zc,[]];s.push(IDBKeyRange.bound(e,n))}return s}Dn(t,e){return Dc(t,e)>0}getMinOffsetFromCollectionGroup(t,e){return this.getFieldIndexes(t,e).next(Wc)}getMinOffset(t,e){return Ss.mapArray(this.cn(e),(e=>this.ln(t,e).next((t=>t||Or())))).next(Wc)}}function Gc(t){return gi(t,"collectionParents")}function jc(t){return gi(t,"indexEntries")}function $c(t){return gi(t,"indexConfiguration")}function Qc(t){return gi(t,"indexState")}function Wc(t){Vr(0!==t.length);let e=t[0].indexState.offset,n=e.largestBatchId;for(let r=1;r<t.length;r++){const s=t[r].indexState.offset;Is(s,e)<0&&(e=s),n<s.largestBatchId&&(n=s.largestBatchId)}return new bs(e.readTime,e.documentKey,n)}const Hc={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Yc{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new Yc(t,Yc.DEFAULT_COLLECTION_PERCENTILE,Yc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Xc(t,e,n){const r=t.store("mutations"),s=t.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=r.Y({range:o},((t,e,n)=>(a++,n.delete())));i.push(u.next((()=>{Vr(1===a)})));const c=[];for(const t of n.mutations){const r=Qs(e,t.key.path,n.batchId);i.push(s.delete(r)),c.push(t.key)}return Ss.waitFor(i).next((()=>c))}function Jc(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Or();e=t.noDocument}return JSON.stringify(e).length}Yc.DEFAULT_COLLECTION_PERCENTILE=10,Yc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Yc.DEFAULT=new Yc(41943040,Yc.DEFAULT_COLLECTION_PERCENTILE,Yc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Yc.DISABLED=new Yc(-1,0,0);class Zc{constructor(t,e,n,r){this.userId=t,this.serializer=e,this.indexManager=n,this.referenceDelegate=r,this.Cn={}}static lt(t,e,n,r){Vr(""!==t.uid);const s=t.isAuthenticated()?t.uid:"";return new Zc(s,e,n,r)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return el(t).Y({index:"userMutationsIndex",range:n},((t,n,r)=>{e=!1,r.done()})).next((()=>e))}addMutationBatch(t,e,n,r){const s=nl(t),i=el(t);return i.add({}).next((o=>{Vr("number"==typeof o);const a=new Xa(o,e,n,r),u=function(t,e,n){const r=n.baseMutations.map((e=>zu(t.ct,e))),s=n.mutations.map((e=>zu(t.ct,e)));return{userId:e,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:s}}(this.serializer,this.userId,a),c=[];let l=new _i(((t,e)=>es(t.canonicalString(),e.canonicalString())));for(const t of r){const e=Qs(this.userId,t.key.path,o);l=l.add(t.key.path.popLast()),c.push(i.put(u)),c.push(s.put(e,Ws))}return l.forEach((e=>{c.push(this.indexManager.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((()=>{this.Cn[o]=a.keys()})),Ss.waitFor(c).next((()=>a))}))}lookupMutationBatch(t,e){return el(t).get(e).next((t=>t?(Vr(t.userId===this.userId),uc(this.serializer,t)):null))}vn(t,e){return this.Cn[e]?Ss.resolve(this.Cn[e]):this.lookupMutationBatch(t,e).next((t=>{if(t){const n=t.keys();return this.Cn[e]=n,n}return null}))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return el(t).Y({index:"userMutationsIndex",range:r},((t,e,r)=>{e.userId===this.userId&&(Vr(e.batchId>=n),s=uc(this.serializer,e)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return el(t).Y({index:"userMutationsIndex",range:e,reverse:!0},((t,e,r)=>{n=e.batchId,r.done()})).next((()=>n))}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return el(t).W("userMutationsIndex",e).next((t=>t.map((t=>uc(this.serializer,t)))))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=$s(this.userId,e.path),r=IDBKeyRange.lowerBound(n),s=[];return nl(t).Y({range:r},((n,r,i)=>{const[o,a,u]=n,c=Gs(a);if(o===this.userId&&e.path.isEqual(c))return el(t).get(u).next((t=>{if(!t)throw Or();Vr(t.userId===this.userId),s.push(uc(this.serializer,t))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new _i(es);const r=[];return e.forEach((e=>{const s=$s(this.userId,e.path),i=IDBKeyRange.lowerBound(s),o=nl(t).Y({range:i},((t,r,s)=>{const[i,o,a]=t,u=Gs(o);i===this.userId&&e.path.isEqual(u)?n=n.add(a):s.done()}));r.push(o)})),Ss.waitFor(r).next((()=>this.Fn(t,n)))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1,s=$s(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new _i(es);return nl(t).Y({range:i},((t,e,s)=>{const[i,a,u]=t,c=Gs(a);i===this.userId&&n.isPrefixOf(c)?c.length===r&&(o=o.add(u)):s.done()})).next((()=>this.Fn(t,o)))}Fn(t,e){const n=[],r=[];return e.forEach((e=>{r.push(el(t).get(e).next((t=>{if(null===t)throw Or();Vr(t.userId===this.userId),n.push(uc(this.serializer,t))})))})),Ss.waitFor(r).next((()=>n))}removeMutationBatch(t,e){return Xc(t.ae,this.userId,e).next((n=>(t.addOnCommittedListener((()=>{this.Mn(e.batchId)})),Ss.forEach(n,(e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))))}Mn(t){delete this.Cn[t]}performConsistencyCheck(t){return this.checkEmpty(t).next((e=>{if(!e)return Ss.resolve();const n=IDBKeyRange.lowerBound(function(t){return[t]}(this.userId)),r=[];return nl(t).Y({range:n},((t,e,n)=>{if(t[0]===this.userId){const e=Gs(t[1]);r.push(e)}else n.done()})).next((()=>{Vr(0===r.length)}))}))}containsKey(t,e){return tl(t,this.userId,e)}xn(t){return rl(t).get(this.userId).next((t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function tl(t,e,n){const r=$s(e,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return nl(t).Y({range:i,J:!0},((t,n,r)=>{const[i,a,u]=t;i===e&&a===s&&(o=!0),r.done()})).next((()=>o))}function el(t){return gi(t,"mutations")}function nl(t){return gi(t,"documentMutations")}function rl(t){return gi(t,"mutationQueues")}class sl{constructor(t){this.On=t}next(){return this.On+=2,this.On}static Nn(){return new sl(0)}static Bn(){return new sl(-1)}}class il{constructor(t,e){this.referenceDelegate=t,this.serializer=e}allocateTargetId(t){return this.Ln(t).next((e=>{const n=new sl(e.highestTargetId);return e.highestTargetId=n.next(),this.kn(t,e).next((()=>e.highestTargetId))}))}getLastRemoteSnapshotVersion(t){return this.Ln(t).next((t=>is.fromTimestamp(new ss(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(t){return this.Ln(t).next((t=>t.highestListenSequenceNumber))}setTargetsMetadata(t,e,n){return this.Ln(t).next((r=>(r.highestListenSequenceNumber=e,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),e>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=e),this.kn(t,r))))}addTargetData(t,e){return this.qn(t,e).next((()=>this.Ln(t).next((n=>(n.targetCount+=1,this.Qn(e,n),this.kn(t,n))))))}updateTargetData(t,e){return this.qn(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next((()=>ol(t).delete(e.targetId))).next((()=>this.Ln(t))).next((e=>(Vr(e.targetCount>0),e.targetCount-=1,this.kn(t,e))))}removeTargets(t,e,n){let r=0;const s=[];return ol(t).Y(((i,o)=>{const a=cc(o);a.sequenceNumber<=e&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(t,a)))})).next((()=>Ss.waitFor(s))).next((()=>r))}forEachTarget(t,e){return ol(t).Y(((t,n)=>{const r=cc(n);e(r)}))}Ln(t){return al(t).get("targetGlobalKey").next((t=>(Vr(null!==t),t)))}kn(t,e){return al(t).put("targetGlobalKey",e)}qn(t,e){return ol(t).put(lc(this.serializer,e))}Qn(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.Ln(t).next((t=>t.targetCount))}getTargetData(t,e){const n=Fo(e),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return ol(t).Y({range:r,index:"queryTargetsIndex"},((t,n,r)=>{const i=cc(n);Oo(e,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(t,e,n){const r=[],s=ul(t);return e.forEach((e=>{const i=Bs(e.path);r.push(s.put({targetId:n,path:i})),r.push(this.referenceDelegate.addReference(t,n,e))})),Ss.waitFor(r)}removeMatchingKeys(t,e,n){const r=ul(t);return Ss.forEach(e,(e=>{const s=Bs(e.path);return Ss.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(t,n,e)])}))}removeMatchingKeysForTargetId(t,e){const n=ul(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),r=ul(t);let s=pa();return r.Y({range:n,J:!0},((t,e,n)=>{const r=Gs(t[1]),i=new ls(r);s=s.add(i)})).next((()=>s))}containsKey(t,e){const n=Bs(e.path),r=IDBKeyRange.bound([n],[rs(n)],!1,!0);let s=0;return ul(t).Y({index:"documentTargetsIndex",J:!0,range:r},(([t,e],n,r)=>{0!==t&&(s++,r.done())})).next((()=>s>0))}_t(t,e){return ol(t).get(e).next((t=>t?cc(t):null))}}function ol(t){return gi(t,"targets")}function al(t){return gi(t,"targetGlobal")}function ul(t){return gi(t,"targetDocuments")}function cl([t,e],[n,r]){const s=es(t,n);return 0===s?es(e,r):s}class ll{constructor(t){this.Kn=t,this.buffer=new _i(cl),this.$n=0}Un(){return++this.$n}Wn(t){const e=[t,this.Un()];if(this.buffer.size<this.Kn)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();cl(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class hl{constructor(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.Gn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.zn(6e4)}stop(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}get started(){return null!==this.Gn}zn(t){Mr("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.Gn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,(async()=>{this.Gn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(t){Ns(t)?Mr("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await Es(t)}await this.zn(3e5)}))}}class dl{constructor(t,e){this.jn=t,this.params=e}calculateTargetCount(t,e){return this.jn.Hn(t).next((t=>Math.floor(e/100*t)))}nthSequenceNumber(t,e){if(0===e)return Ss.resolve(Os._e);const n=new ll(e);return this.jn.forEachTarget(t,(t=>n.Wn(t.sequenceNumber))).next((()=>this.jn.Jn(t,(t=>n.Wn(t))))).next((()=>n.maxValue))}removeTargets(t,e,n){return this.jn.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.jn.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(Mr("LruGarbageCollector","Garbage collection skipped; disabled"),Ss.resolve(Hc)):this.getCacheSize(t).next((n=>n<this.params.cacheSizeCollectionThreshold?(Mr("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Hc):this.Yn(t,e)))}getCacheSize(t){return this.jn.getCacheSize(t)}Yn(t,e){let n,r,s,i,a,u,c;const l=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((e=>(e>this.params.maximumSequenceNumbersToCollect?(Mr("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),r=this.params.maximumSequenceNumbersToCollect):r=e,i=Date.now(),this.nthSequenceNumber(t,r)))).next((r=>(n=r,a=Date.now(),this.removeTargets(t,n,e)))).next((e=>(s=e,u=Date.now(),this.removeOrphanedDocuments(t,n)))).next((t=>(c=Date.now(),kr()<=o.$b.DEBUG&&Mr("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${i-l}ms\n\tDetermined least recently used ${r} in `+(a-i)+"ms\n"+`\tRemoved ${s} targets in `+(u-a)+"ms\n"+`\tRemoved ${t} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-l}ms`),Ss.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:t}))))}}function fl(t,e){return new dl(t,e)}class ml{constructor(t,e){this.db=t,this.garbageCollector=fl(this,e)}Hn(t){const e=this.Zn(t);return this.db.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}Zn(t){let e=0;return this.Jn(t,(t=>{e++})).next((()=>e))}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}Jn(t,e){return this.Xn(t,((t,n)=>e(n)))}addReference(t,e,n){return gl(t,n)}removeReference(t,e,n){return gl(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return gl(t,e)}er(t,e){return function(t,e){let n=!1;return rl(t).Z((r=>tl(t,r,e).next((t=>(t&&(n=!0),Ss.resolve(!t)))))).next((()=>n))}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Xn(t,((i,o)=>{if(o<=e){const e=this.er(t,i).next((e=>{if(!e)return s++,n.getEntry(t,i).next((()=>(n.removeEntry(i,is.min()),ul(t).delete(function(t){return[0,Bs(t.path)]}(i)))))}));r.push(e)}})).next((()=>Ss.waitFor(r))).next((()=>n.apply(t))).next((()=>s))}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return gl(t,e)}Xn(t,e){const n=ul(t);let r,s=Os._e;return n.Y({index:"documentTargetsIndex"},(([t,n],{path:i,sequenceNumber:o})=>{0===t?(s!==Os._e&&e(new ls(Gs(r)),s),s=o,r=i):s=Os._e})).next((()=>{s!==Os._e&&e(new ls(Gs(r)),s)}))}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function gl(t,e){return ul(t).put(function(t,e){return{targetId:0,path:Bs(t.path),sequenceNumber:e}}(e,t.currentSequenceNumber))}class pl{constructor(){this.changes=new ia((t=>t.toString()),((t,e)=>t.isEqual(e))),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,uo.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?Ss.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class yl{constructor(t){this.serializer=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,n){return Il(t).put(n)}removeEntry(t,e,n){return Il(t).delete(function(t,e){const n=t.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],ic(e),n[n.length-1]]}(e,n))}updateMetadata(t,e){return this.getMetadata(t).next((n=>(n.byteSize+=e,this.tr(t,n))))}getEntry(t,e){let n=uo.newInvalidDocument(e);return Il(t).Y({index:"documentKeyIndex",range:IDBKeyRange.only(_l(e))},((t,r)=>{n=this.nr(e,r)})).next((()=>n))}rr(t,e){let n={size:0,document:uo.newInvalidDocument(e)};return Il(t).Y({index:"documentKeyIndex",range:IDBKeyRange.only(_l(e))},((t,r)=>{n={document:this.nr(e,r),size:Jc(r)}})).next((()=>n))}getEntries(t,e){let n=aa();return this.ir(t,e,((t,e)=>{const r=this.nr(t,e);n=n.insert(t,r)})).next((()=>n))}sr(t,e){let n=aa(),r=new vi(ls.comparator);return this.ir(t,e,((t,e)=>{const s=this.nr(t,e);n=n.insert(t,s),r=r.insert(t,Jc(e))})).next((()=>({documents:n,_r:r})))}ir(t,e,n){if(e.isEmpty())return Ss.resolve();let r=new _i(El);e.forEach((t=>r=r.add(t)));const s=IDBKeyRange.bound(_l(r.first()),_l(r.last())),i=r.getIterator();let o=i.getNext();return Il(t).Y({index:"documentKeyIndex",range:s},((t,e,r)=>{const s=ls.fromSegments([...e.prefixPath,e.collectionGroup,e.documentId]);for(;o&&El(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,e),o=i.hasNext()?i.getNext():null),o?r.U(_l(o)):r.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getDocumentsMatchingQuery(t,e,n,r,s){const i=e.path,o=[i.popLast().toArray(),i.lastSegment(),ic(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],a=[i.popLast().toArray(),i.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Il(t).W(IDBKeyRange.bound(o,a,!0)).next((t=>{null==s||s.incrementDocumentReadCount(t.length);let n=aa();for(const s of t){const t=this.nr(ls.fromSegments(s.prefixPath.concat(s.collectionGroup,s.documentId)),s);t.isFoundDocument()&&(ea(e,t)||r.has(t.key))&&(n=n.insert(t.key,t))}return n}))}getAllFromCollectionGroup(t,e,n,r){let s=aa();const i=Tl(e,n),o=Tl(e,bs.max());return Il(t).Y({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((t,e,n)=>{const i=this.nr(ls.fromSegments(e.prefixPath.concat(e.collectionGroup,e.documentId)),e);s=s.insert(i.key,i),s.size===r&&n.done()})).next((()=>s))}newChangeBuffer(t){return new vl(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next((t=>t.byteSize))}getMetadata(t){return bl(t).get("remoteDocumentGlobalKey").next((t=>(Vr(!!t),t)))}tr(t,e){return bl(t).put("remoteDocumentGlobalKey",e)}nr(t,e){if(e){const t=function(t,e){let n;if(e.document)n=Bu(t.ct,e.document,!!e.hasCommittedMutations);else if(e.noDocument){const t=ls.fromSegments(e.noDocument.path),r=ac(e.noDocument.readTime);n=uo.newNoDocument(t,r),e.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!e.unknownDocument)return Or();{const t=ls.fromSegments(e.unknownDocument.path),r=ac(e.unknownDocument.version);n=uo.newUnknownDocument(t,r)}}return e.readTime&&n.setReadTime(function(t){const e=new ss(t[0],t[1]);return is.fromTimestamp(e)}(e.readTime)),n}(this.serializer,e);if(!t.isNoDocument()||!t.version.isEqual(is.min()))return t}return uo.newInvalidDocument(t)}}function wl(t){return new yl(t)}class vl extends pl{constructor(t,e){super(),this.ar=t,this.trackRemovals=e,this.ur=new ia((t=>t.toString()),((t,e)=>t.isEqual(e)))}applyChanges(t){const e=[];let n=0,r=new _i(((t,e)=>es(t.canonicalString(),e.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.ur.get(s);if(e.push(this.ar.removeEntry(t,s,o.readTime)),i.isValidDocument()){const a=sc(this.ar.serializer,i);r=r.add(s.path.popLast());const u=Jc(a);n+=u-o.size,e.push(this.ar.addEntry(t,s,a))}else if(n-=o.size,this.trackRemovals){const n=sc(this.ar.serializer,i.convertToNoDocument(is.min()));e.push(this.ar.addEntry(t,s,n))}})),r.forEach((n=>{e.push(this.ar.indexManager.addToCollectionParentIndex(t,n))})),e.push(this.ar.updateMetadata(t,n)),Ss.waitFor(e)}getFromCache(t,e){return this.ar.rr(t,e).next((t=>(this.ur.set(e,{size:t.size,readTime:t.document.readTime}),t.document)))}getAllFromCache(t,e){return this.ar.sr(t,e).next((({documents:t,_r:e})=>(e.forEach(((e,n)=>{this.ur.set(e,{size:n,readTime:t.get(e).readTime})})),t)))}}function bl(t){return gi(t,"remoteDocumentGlobal")}function Il(t){return gi(t,"remoteDocumentsV14")}function _l(t){const e=t.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function Tl(t,e){const n=e.documentKey.path.toArray();return[t,ic(e.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function El(t,e){const n=t.path.toArray(),r=e.path.toArray();let s=0;for(let t=0;t<n.length-2&&t<r.length-2;++t)if(s=es(n[t],r[t]),s)return s;return s=es(n.length,r.length),s||(s=es(n[n.length-2],r[r.length-2]),s||es(n[n.length-1],r[r.length-1]))}class Sl{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}class xl{constructor(t,e,n,r){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,e){let n=null;return this.documentOverlayCache.getOverlay(t,e).next((r=>(n=r,this.remoteDocumentCache.getEntry(t,e)))).next((t=>(null!==n&&Ba(n.mutation,t,Si.empty(),ss.now()),t)))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.getLocalViewOfDocuments(t,e,pa()).next((()=>e))))}getLocalViewOfDocuments(t,e,n=pa()){const r=ha();return this.populateOverlays(t,r,e).next((()=>this.computeViews(t,e,r,n).next((t=>{let e=ca();return t.forEach(((t,n)=>{e=e.insert(t,n.overlayedDocument)})),e}))))}getOverlayedDocuments(t,e){const n=ha();return this.populateOverlays(t,n,e).next((()=>this.computeViews(t,e,n,pa())))}populateOverlays(t,e,n){const r=[];return n.forEach((t=>{e.has(t)||r.push(t)})),this.documentOverlayCache.getOverlays(t,r).next((t=>{t.forEach(((t,n)=>{e.set(t,n)}))}))}computeViews(t,e,n,r){let s=aa();const i=fa(),o=fa();return e.forEach(((t,e)=>{const o=n.get(e.key);r.has(e.key)&&(void 0===o||o.mutation instanceof ja)?s=s.insert(e.key,e):void 0!==o?(i.set(e.key,o.mutation.getFieldMask()),Ba(o.mutation,e,o.mutation.getFieldMask(),ss.now())):i.set(e.key,Si.empty())})),this.recalculateAndSaveOverlays(t,s).next((t=>(t.forEach(((t,e)=>i.set(t,e))),e.forEach(((t,e)=>{var n;return o.set(t,new Sl(e,null!==(n=i.get(t))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(t,e){const n=fa();let r=new vi(((t,e)=>t-e)),s=pa();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next((t=>{for(const s of t)s.keys().forEach((t=>{const i=e.get(t);if(null===i)return;let o=n.get(t)||Si.empty();o=s.applyToLocalView(i,o),n.set(t,o);const a=(r.get(s.batchId)||pa()).add(t);r=r.insert(s.batchId,a)}))})).next((()=>{const i=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,u=r.value,c=da();u.forEach((t=>{if(!s.has(t)){const r=qa(e.get(t),n.get(t));null!==r&&c.set(t,r),s=s.add(t)}})),i.push(this.documentOverlayCache.saveOverlays(t,a,c))}return Ss.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.recalculateAndSaveOverlays(t,e)))}getDocumentsMatchingQuery(t,e,n,r){return function(t){return ls.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):$o(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,n,r):this.getDocumentsMatchingCollectionQuery(t,e,n,r)}getNextDocuments(t,e,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,n,r).next((s=>{const i=r-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,n.largestBatchId,r-s.size):Ss.resolve(ha());let o=-1,a=s;return i.next((e=>Ss.forEach(e,((e,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),s.get(e)?Ss.resolve():this.remoteDocumentCache.getEntry(t,e).next((t=>{a=a.insert(e,t)}))))).next((()=>this.populateOverlays(t,e,s))).next((()=>this.computeViews(t,a,e,pa()))).next((t=>({batchId:o,changes:la(t)})))))}))}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new ls(e)).next((t=>{let e=ca();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))}getDocumentsMatchingCollectionGroupQuery(t,e,n,r){const s=e.collectionGroup;let i=ca();return this.indexManager.getCollectionParents(t,s).next((o=>Ss.forEach(o,(o=>{const a=function(t,e){return new zo(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,o.child(s));return this.getDocumentsMatchingCollectionQuery(t,a,n,r).next((t=>{t.forEach(((t,e)=>{i=i.insert(t,e)}))}))})).next((()=>i))))}getDocumentsMatchingCollectionQuery(t,e,n,r){let s;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,n.largestBatchId).next((i=>(s=i,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,n,s,r)))).next((t=>{s.forEach(((e,n)=>{const r=n.getKey();null===t.get(r)&&(t=t.insert(r,uo.newInvalidDocument(r)))}));let n=ca();return t.forEach(((t,r)=>{const i=s.get(t);void 0!==i&&Ba(i.mutation,r,Si.empty(),ss.now()),ea(e,r)&&(n=n.insert(t,r))})),n}))}}class Cl{constructor(t){this.serializer=t,this.cr=new Map,this.lr=new Map}getBundleMetadata(t,e){return Ss.resolve(this.cr.get(e))}saveBundleMetadata(t,e){return this.cr.set(e.id,function(t){return{id:t.id,version:t.version,createTime:Nu(t.createTime)}}(e)),Ss.resolve()}getNamedQuery(t,e){return Ss.resolve(this.lr.get(e))}saveNamedQuery(t,e){return this.lr.set(e.name,function(t){return{name:t.name,query:hc(t.bundledQuery),readTime:Nu(t.readTime)}}(e)),Ss.resolve()}}class Dl{constructor(){this.overlays=new vi(ls.comparator),this.hr=new Map}getOverlay(t,e){return Ss.resolve(this.overlays.get(e))}getOverlays(t,e){const n=ha();return Ss.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){return n.forEach(((n,r)=>{this.ht(t,e,r)})),Ss.resolve()}removeOverlaysForBatchId(t,e,n){const r=this.hr.get(n);return void 0!==r&&(r.forEach((t=>this.overlays=this.overlays.remove(t))),this.hr.delete(n)),Ss.resolve()}getOverlaysForCollection(t,e,n){const r=ha(),s=e.length+1,i=new ls(e.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const t=o.getNext().value,i=t.getKey();if(!e.isPrefixOf(i.path))break;i.path.length===s&&t.largestBatchId>n&&r.set(t.getKey(),t)}return Ss.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let s=new vi(((t,e)=>t-e));const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=s.get(t.largestBatchId);null===e&&(e=ha(),s=s.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const o=ha(),a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((t,e)=>o.set(t,e))),!(o.size()>=r)););return Ss.resolve(o)}ht(t,e,n){const r=this.overlays.get(n.key);if(null!==r){const t=this.hr.get(r.largestBatchId).delete(n.key);this.hr.set(r.largestBatchId,t)}this.overlays=this.overlays.insert(n.key,new Za(e,n));let s=this.hr.get(e);void 0===s&&(s=pa(),this.hr.set(e,s)),this.hr.set(e,s.add(n.key))}}class Al{constructor(){this.Pr=new _i(Nl.Ir),this.Tr=new _i(Nl.Er)}isEmpty(){return this.Pr.isEmpty()}addReference(t,e){const n=new Nl(t,e);this.Pr=this.Pr.add(n),this.Tr=this.Tr.add(n)}dr(t,e){t.forEach((t=>this.addReference(t,e)))}removeReference(t,e){this.Ar(new Nl(t,e))}Rr(t,e){t.forEach((t=>this.removeReference(t,e)))}Vr(t){const e=new ls(new as([])),n=new Nl(e,t),r=new Nl(e,t+1),s=[];return this.Tr.forEachInRange([n,r],(t=>{this.Ar(t),s.push(t.key)})),s}mr(){this.Pr.forEach((t=>this.Ar(t)))}Ar(t){this.Pr=this.Pr.delete(t),this.Tr=this.Tr.delete(t)}gr(t){const e=new ls(new as([])),n=new Nl(e,t),r=new Nl(e,t+1);let s=pa();return this.Tr.forEachInRange([n,r],(t=>{s=s.add(t.key)})),s}containsKey(t){const e=new Nl(t,0),n=this.Pr.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class Nl{constructor(t,e){this.key=t,this.pr=e}static Ir(t,e){return ls.comparator(t.key,e.key)||es(t.pr,e.pr)}static Er(t,e){return es(t.pr,e.pr)||ls.comparator(t.key,e.key)}}class kl{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.yr=1,this.wr=new _i(Nl.Ir)}checkEmpty(t){return Ss.resolve(0===this.mutationQueue.length)}addMutationBatch(t,e,n,r){const s=this.yr;this.yr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new Xa(s,e,n,r);this.mutationQueue.push(i);for(const e of r)this.wr=this.wr.add(new Nl(e.key,s)),this.indexManager.addToCollectionParentIndex(t,e.key.path.popLast());return Ss.resolve(i)}lookupMutationBatch(t,e){return Ss.resolve(this.Sr(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=this.br(n),s=r<0?0:r;return Ss.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return Ss.resolve(0===this.mutationQueue.length?-1:this.yr-1)}getAllMutationBatches(t){return Ss.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new Nl(e,0),r=new Nl(e,Number.POSITIVE_INFINITY),s=[];return this.wr.forEachInRange([n,r],(t=>{const e=this.Sr(t.pr);s.push(e)})),Ss.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new _i(es);return e.forEach((t=>{const e=new Nl(t,0),r=new Nl(t,Number.POSITIVE_INFINITY);this.wr.forEachInRange([e,r],(t=>{n=n.add(t.pr)}))})),Ss.resolve(this.Dr(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1;let s=n;ls.isDocumentKey(s)||(s=s.child(""));const i=new Nl(new ls(s),0);let o=new _i(es);return this.wr.forEachWhile((t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(o=o.add(t.pr)),!0)}),i),Ss.resolve(this.Dr(o))}Dr(t){const e=[];return t.forEach((t=>{const n=this.Sr(t);null!==n&&e.push(n)})),e}removeMutationBatch(t,e){Vr(0===this.Cr(e.batchId,"removed")),this.mutationQueue.shift();let n=this.wr;return Ss.forEach(e.mutations,(r=>{const s=new Nl(r.key,e.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(t,r.key)})).next((()=>{this.wr=n}))}Mn(t){}containsKey(t,e){const n=new Nl(e,0),r=this.wr.firstAfterOrEqual(n);return Ss.resolve(e.isEqual(r&&r.key))}performConsistencyCheck(t){return this.mutationQueue.length,Ss.resolve()}Cr(t,e){return this.br(t)}br(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId}Sr(t){const e=this.br(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}class Rl{constructor(t){this.vr=t,this.docs=new vi(ls.comparator),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const n=e.key,r=this.docs.get(n),s=r?r.size:0,i=this.vr(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return Ss.resolve(n?n.document.mutableCopy():uo.newInvalidDocument(e))}getEntries(t,e){let n=aa();return e.forEach((t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.mutableCopy():uo.newInvalidDocument(t))})),Ss.resolve(n)}getDocumentsMatchingQuery(t,e,n,r){let s=aa();const i=e.path,o=new ls(i.child("")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:t,value:{document:o}}=a.getNext();if(!i.isPrefixOf(t.path))break;t.path.length>i.length+1||Is(vs(o),n)<=0||(r.has(o.key)||ea(e,o))&&(s=s.insert(o.key,o.mutableCopy()))}return Ss.resolve(s)}getAllFromCollectionGroup(t,e,n,r){Or()}Fr(t,e){return Ss.forEach(this.docs,(t=>e(t)))}newChangeBuffer(t){return new Ml(this)}getSize(t){return Ss.resolve(this.size)}}class Ml extends pl{constructor(t){super(),this.ar=t}applyChanges(t){const e=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?e.push(this.ar.addEntry(t,r)):this.ar.removeEntry(n)})),Ss.waitFor(e)}getFromCache(t,e){return this.ar.getEntry(t,e)}getAllFromCache(t,e){return this.ar.getEntries(t,e)}}class Pl{constructor(t){this.persistence=t,this.Mr=new ia((t=>Fo(t)),Oo),this.lastRemoteSnapshotVersion=is.min(),this.highestTargetId=0,this.Or=0,this.Nr=new Al,this.targetCount=0,this.Br=sl.Nn()}forEachTarget(t,e){return this.Mr.forEach(((t,n)=>e(n))),Ss.resolve()}getLastRemoteSnapshotVersion(t){return Ss.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return Ss.resolve(this.Or)}allocateTargetId(t){return this.highestTargetId=this.Br.next(),Ss.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Or&&(this.Or=e),Ss.resolve()}qn(t){this.Mr.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.Br=new sl(e),this.highestTargetId=e),t.sequenceNumber>this.Or&&(this.Or=t.sequenceNumber)}addTargetData(t,e){return this.qn(e),this.targetCount+=1,Ss.resolve()}updateTargetData(t,e){return this.qn(e),Ss.resolve()}removeTargetData(t,e){return this.Mr.delete(e.target),this.Nr.Vr(e.targetId),this.targetCount-=1,Ss.resolve()}removeTargets(t,e,n){let r=0;const s=[];return this.Mr.forEach(((i,o)=>{o.sequenceNumber<=e&&null===n.get(o.targetId)&&(this.Mr.delete(i),s.push(this.removeMatchingKeysForTargetId(t,o.targetId)),r++)})),Ss.waitFor(s).next((()=>r))}getTargetCount(t){return Ss.resolve(this.targetCount)}getTargetData(t,e){const n=this.Mr.get(e)||null;return Ss.resolve(n)}addMatchingKeys(t,e,n){return this.Nr.dr(e,n),Ss.resolve()}removeMatchingKeys(t,e,n){this.Nr.Rr(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach((e=>{s.push(r.markPotentiallyOrphaned(t,e))})),Ss.waitFor(s)}removeMatchingKeysForTargetId(t,e){return this.Nr.Vr(e),Ss.resolve()}getMatchingKeysForTargetId(t,e){const n=this.Nr.gr(e);return Ss.resolve(n)}containsKey(t,e){return Ss.resolve(this.Nr.containsKey(e))}}class Ll{constructor(t,e){this.Lr={},this.overlays={},this.kr=new Os(0),this.qr=!1,this.qr=!0,this.referenceDelegate=t(this),this.Qr=new Pl(this),this.indexManager=new Uc,this.remoteDocumentCache=function(t){return new Rl(t)}((t=>this.referenceDelegate.Kr(t))),this.serializer=new rc(e),this.$r=new Cl(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.qr=!1,Promise.resolve()}get started(){return this.qr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new Dl,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.Lr[t.toKey()];return n||(n=new kl(e,this.referenceDelegate),this.Lr[t.toKey()]=n),n}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.$r}runTransaction(t,e,n){Mr("MemoryPersistence","Starting transaction:",t);const r=new Fl(this.kr.next());return this.referenceDelegate.Ur(),n(r).next((t=>this.referenceDelegate.Wr(r).next((()=>t)))).toPromise().then((t=>(r.raiseOnCommittedEvent(),t)))}Gr(t,e){return Ss.or(Object.values(this.Lr).map((n=>()=>n.containsKey(t,e))))}}class Fl extends Ts{constructor(t){super(),this.currentSequenceNumber=t}}class Ol{constructor(t){this.persistence=t,this.zr=new Al,this.jr=null}static Hr(t){return new Ol(t)}get Jr(){if(this.jr)return this.jr;throw Or()}addReference(t,e,n){return this.zr.addReference(n,e),this.Jr.delete(n.toString()),Ss.resolve()}removeReference(t,e,n){return this.zr.removeReference(n,e),this.Jr.add(n.toString()),Ss.resolve()}markPotentiallyOrphaned(t,e){return this.Jr.add(e.toString()),Ss.resolve()}removeTarget(t,e){this.zr.Vr(e.targetId).forEach((t=>this.Jr.add(t.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next((t=>{t.forEach((t=>this.Jr.add(t.toString())))})).next((()=>n.removeTargetData(t,e)))}Ur(){this.jr=new Set}Wr(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Ss.forEach(this.Jr,(n=>{const r=ls.fromPath(n);return this.Yr(t,r).next((t=>{t||e.removeEntry(r,is.min())}))})).next((()=>(this.jr=null,e.apply(t))))}updateLimboDocument(t,e){return this.Yr(t,e).next((t=>{t?this.Jr.delete(e.toString()):this.Jr.add(e.toString())}))}Kr(t){return 0}Yr(t,e){return Ss.or([()=>Ss.resolve(this.zr.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Gr(t,e)])}}class Vl{constructor(t,e){this.persistence=t,this.Zr=new ia((t=>Bs(t.path)),((t,e)=>t.isEqual(e))),this.garbageCollector=fl(this,e)}static Hr(t,e){return new Vl(t,e)}Ur(){}Wr(t){return Ss.resolve()}forEachTarget(t,e){return this.persistence.getTargetCache().forEachTarget(t,e)}Hn(t){const e=this.Zn(t);return this.persistence.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}Zn(t){let e=0;return this.Jn(t,(t=>{e++})).next((()=>e))}Jn(t,e){return Ss.forEach(this.Zr,((n,r)=>this.er(t,n,r).next((t=>t?Ss.resolve():e(r)))))}removeTargets(t,e,n){return this.persistence.getTargetCache().removeTargets(t,e,n)}removeOrphanedDocuments(t,e){let n=0;const r=this.persistence.getRemoteDocumentCache(),s=r.newChangeBuffer();return r.Fr(t,(r=>this.er(t,r,e).next((t=>{t||(n++,s.removeEntry(r,is.min()))})))).next((()=>s.apply(t))).next((()=>n))}markPotentiallyOrphaned(t,e){return this.Zr.set(e,t.currentSequenceNumber),Ss.resolve()}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(t,n)}addReference(t,e,n){return this.Zr.set(n,t.currentSequenceNumber),Ss.resolve()}removeReference(t,e,n){return this.Zr.set(n,t.currentSequenceNumber),Ss.resolve()}updateLimboDocument(t,e){return this.Zr.set(e,t.currentSequenceNumber),Ss.resolve()}Kr(t){let e=t.key.toString().length;return t.isFoundDocument()&&(e+=Qi(t.data.value)),e}er(t,e,n){return Ss.or([()=>this.persistence.Gr(t,e),()=>this.persistence.getTargetCache().containsKey(t,e),()=>{const t=this.Zr.get(e);return Ss.resolve(void 0!==t&&t>n)}])}getCacheSize(t){return this.persistence.getRemoteDocumentCache().getSize(t)}}class ql{constructor(t){this.serializer=t}N(t,e,n,r){const s=new xs("createOrUpgrade",e);n<1&&r>=1&&(function(t){t.createObjectStore("owner")}(t),function(t){t.createObjectStore("mutationQueues",{keyPath:"userId"}),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",js,{unique:!0}),t.createObjectStore("documentMutations")}(t),Ul(t),function(t){t.createObjectStore("remoteDocuments")}(t));let i=Ss.resolve();return n<3&&r>=3&&(0!==n&&(function(t){t.deleteObjectStore("targetDocuments"),t.deleteObjectStore("targets"),t.deleteObjectStore("targetGlobal")}(t),Ul(t)),i=i.next((()=>function(t){const e=t.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:is.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(t,e){return e.store("mutations").W().next((n=>{t.deleteObjectStore("mutations"),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",js,{unique:!0});const r=e.store("mutations"),s=n.map((t=>r.put(t)));return Ss.waitFor(s)}))}(t,s)))),i=i.next((()=>{!function(t){t.createObjectStore("clientMetadata",{keyPath:"clientId"})}(t)}))),n<5&&r>=5&&(i=i.next((()=>this.Xr(s)))),n<6&&r>=6&&(i=i.next((()=>(function(t){t.createObjectStore("remoteDocumentGlobal")}(t),this.ei(s))))),n<7&&r>=7&&(i=i.next((()=>this.ti(s)))),n<8&&r>=8&&(i=i.next((()=>this.ni(t,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t)}))),n<10&&r>=10&&(i=i.next((()=>this.ri(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(t){t.createObjectStore("bundles",{keyPath:"bundleId"})}(t),function(t){t.createObjectStore("namedQueries",{keyPath:"name"})}(t)}))),n<12&&r>=12&&(i=i.next((()=>{!function(t){const e=t.createObjectStore("documentOverlays",{keyPath:oi});e.createIndex("collectionPathOverlayIndex",ai,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",ui,{unique:!1})}(t)}))),n<13&&r>=13&&(i=i.next((()=>function(t){const e=t.createObjectStore("remoteDocumentsV14",{keyPath:Hs});e.createIndex("documentKeyIndex",Ys),e.createIndex("collectionGroupIndex",Xs)}(t))).next((()=>this.ii(t,s))).next((()=>t.deleteObjectStore("remoteDocuments")))),n<14&&r>=14&&(i=i.next((()=>this.si(t,s)))),n<15&&r>=15&&(i=i.next((()=>function(t){t.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),t.createObjectStore("indexState",{keyPath:ni}).createIndex("sequenceNumberIndex",ri,{unique:!1}),t.createObjectStore("indexEntries",{keyPath:si}).createIndex("documentKeyIndex",ii,{unique:!1})}(t)))),i}ei(t){let e=0;return t.store("remoteDocuments").Y(((t,n)=>{e+=Jc(n)})).next((()=>{const n={byteSize:e};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Xr(t){const e=t.store("mutationQueues"),n=t.store("mutations");return e.W().next((e=>Ss.forEach(e,(e=>{const r=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return n.W("userMutationsIndex",r).next((n=>Ss.forEach(n,(n=>{Vr(n.userId===e.userId);const r=uc(this.serializer,n);return Xc(t,e.userId,r).next((()=>{}))}))))}))))}ti(t){const e=t.store("targetDocuments"),n=t.store("remoteDocuments");return t.store("targetGlobal").get("targetGlobalKey").next((t=>{const r=[];return n.Y(((n,s)=>{const i=new as(n),o=function(t){return[0,Bs(t)]}(i);r.push(e.get(o).next((n=>n?Ss.resolve():(n=>e.put({targetId:0,path:Bs(n),sequenceNumber:t.highestListenSequenceNumber}))(i))))})).next((()=>Ss.waitFor(r)))}))}ni(t,e){t.createObjectStore("collectionParents",{keyPath:ei});const n=e.store("collectionParents"),r=new Bc,s=t=>{if(r.add(t)){const e=t.lastSegment(),r=t.popLast();return n.put({collectionId:e,parent:Bs(r)})}};return e.store("remoteDocuments").Y({J:!0},((t,e)=>{const n=new as(t);return s(n.popLast())})).next((()=>e.store("documentMutations").Y({J:!0},(([t,e,n],r)=>{const i=Gs(e);return s(i.popLast())}))))}ri(t){const e=t.store("targets");return e.Y(((t,n)=>{const r=cc(n),s=lc(this.serializer,r);return e.put(s)}))}ii(t,e){const n=e.store("remoteDocuments"),r=[];return n.Y(((t,n)=>{const s=e.store("remoteDocumentsV14"),i=function(t){return t.document?new ls(as.fromString(t.document.name).popFirst(5)):t.noDocument?ls.fromSegments(t.noDocument.path):t.unknownDocument?ls.fromSegments(t.unknownDocument.path):Or()}(n).path.toArray(),o={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(s.put(o))})).next((()=>Ss.waitFor(r)))}si(t,e){const n=e.store("mutations"),r=wl(this.serializer),s=new Ll(Ol.Hr,this.serializer.ct);return n.W().next((t=>{const n=new Map;return t.forEach((t=>{var e;let r=null!==(e=n.get(t.userId))&&void 0!==e?e:pa();uc(this.serializer,t).keys().forEach((t=>r=r.add(t))),n.set(t.userId,r)})),Ss.forEach(n,((t,n)=>{const i=new Dr(n),o=wc.lt(this.serializer,i),a=s.getIndexManager(i),u=Zc.lt(i,this.serializer,a,s.referenceDelegate);return new xl(r,u,o,a).recalculateAndSaveOverlaysForDocumentKeys(new mi(e,Os._e),t).next()}))}))}}function Ul(t){t.createObjectStore("targetDocuments",{keyPath:Zs}).createIndex("documentTargetsIndex",ti,{unique:!0}),t.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Js,{unique:!0}),t.createObjectStore("targetGlobal")}const Bl="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class zl{constructor(t,e,n,r,s,i,o,a,u,c,l=15){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.oi=s,this.window=i,this.document=o,this._i=u,this.ai=c,this.ui=l,this.kr=null,this.qr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ci=null,this.inForeground=!1,this.li=null,this.hi=null,this.Pi=Number.NEGATIVE_INFINITY,this.Ii=t=>Promise.resolve(),!zl.D())throw new zr(Br.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new ml(this,r),this.Ti=e+"main",this.serializer=new rc(a),this.Ei=new Cs(this.Ti,this.ui,new ql(this.serializer)),this.Qr=new il(this.referenceDelegate,this.serializer),this.remoteDocumentCache=wl(this.serializer),this.$r=new gc,this.window&&this.window.localStorage?this.di=this.window.localStorage:(this.di=null,!1===c&&Pr("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ai().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new zr(Br.FAILED_PRECONDITION,Bl);return this.Ri(),this.Vi(),this.mi(),this.runTransaction("getHighestListenSequenceNumber","readonly",(t=>this.Qr.getHighestSequenceNumber(t)))})).then((t=>{this.kr=new Os(t,this._i)})).then((()=>{this.qr=!0})).catch((t=>(this.Ei&&this.Ei.close(),Promise.reject(t))))}fi(t){return this.Ii=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ei.L((async e=>{null===e.newVersion&&await t()}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.oi.enqueueAndForget((async()=>{this.started&&await this.Ai()})))}Ai(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(t=>Gl(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.gi(t).next((t=>{t||(this.isPrimary=!1,this.oi.enqueueRetryable((()=>this.Ii(!1))))}))})).next((()=>this.pi(t))).next((e=>this.isPrimary&&!e?this.yi(t).next((()=>!1)):!!e&&this.wi(t).next((()=>!0)))))).catch((t=>{if(Ns(t))return Mr("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return Mr("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((t=>{this.isPrimary!==t&&this.oi.enqueueRetryable((()=>this.Ii(t))),this.isPrimary=t}))}gi(t){return Kl(t).get("owner").next((t=>Ss.resolve(this.Si(t))))}bi(t){return Gl(t).delete(this.clientId)}async Di(){if(this.isPrimary&&!this.Ci(this.Pi,18e5)){this.Pi=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(t=>{const e=gi(t,"clientMetadata");return e.W().next((t=>{const n=this.vi(t,18e5),r=t.filter((t=>-1===n.indexOf(t)));return Ss.forEach(r,(t=>e.delete(t.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.di)for(const e of t)this.di.removeItem(this.Fi(e.clientId))}}mi(){this.hi=this.oi.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.Ai().then((()=>this.Di())).then((()=>this.mi()))))}Si(t){return!!t&&t.ownerId===this.clientId}pi(t){return this.ai?Ss.resolve(!0):Kl(t).get("owner").next((e=>{if(null!==e&&this.Ci(e.leaseTimestampMs,5e3)&&!this.Mi(e.ownerId)){if(this.Si(e)&&this.networkEnabled)return!0;if(!this.Si(e)){if(!e.allowTabSynchronization)throw new zr(Br.FAILED_PRECONDITION,Bl);return!1}}return!(!this.networkEnabled||!this.inForeground)||Gl(t).W().next((t=>void 0===this.vi(t,5e3).find((t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,r=this.networkEnabled===t.networkEnabled;if(e||n&&r)return!0}return!1}))))})).next((t=>(this.isPrimary!==t&&Mr("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t)))}async shutdown(){this.qr=!1,this.xi(),this.hi&&(this.hi.cancel(),this.hi=null),this.Oi(),this.Ni(),await this.Ei.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(t=>{const e=new mi(t,Os._e);return this.yi(e).next((()=>this.bi(e)))})),this.Ei.close(),this.Bi()}vi(t,e){return t.filter((t=>this.Ci(t.updateTimeMs,e)&&!this.Mi(t.clientId)))}Li(){return this.runTransaction("getActiveClients","readonly",(t=>Gl(t).W().next((t=>this.vi(t,18e5).map((t=>t.clientId))))))}get started(){return this.qr}getMutationQueue(t,e){return Zc.lt(t,this.serializer,e,this.referenceDelegate)}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(t){return new Kc(t,this.serializer.ct.databaseId)}getDocumentOverlayCache(t){return wc.lt(this.serializer,t)}getBundleCache(){return this.$r}runTransaction(t,e,n){Mr("IndexedDbPersistence","Starting transaction:",t);const r="readonly"===e?"readonly":"readwrite",s=function(t){return 15===t?fi:14===t?di:13===t?hi:12===t?li:11===t?ci:void Or()}(this.ui);let i;return this.Ei.runTransaction(t,r,s,(r=>(i=new mi(r,this.kr?this.kr.next():Os._e),"readwrite-primary"===e?this.gi(i).next((t=>!!t||this.pi(i))).next((e=>{if(!e)throw Pr(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.oi.enqueueRetryable((()=>this.Ii(!1))),new zr(Br.FAILED_PRECONDITION,_s);return n(i)})).next((t=>this.wi(i).next((()=>t)))):this.ki(i).next((()=>n(i)))))).then((t=>(i.raiseOnCommittedEvent(),t)))}ki(t){return Kl(t).get("owner").next((t=>{if(null!==t&&this.Ci(t.leaseTimestampMs,5e3)&&!this.Mi(t.ownerId)&&!this.Si(t)&&!(this.ai||this.allowTabSynchronization&&t.allowTabSynchronization))throw new zr(Br.FAILED_PRECONDITION,Bl)}))}wi(t){const e={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Kl(t).put("owner",e)}static D(){return Cs.D()}yi(t){const e=Kl(t);return e.get("owner").next((t=>this.Si(t)?(Mr("IndexedDbPersistence","Releasing primary lease."),e.delete("owner")):Ss.resolve()))}Ci(t,e){const n=Date.now();return!(t<n-e||t>n&&(Pr(`Detected an update time that is in the future: ${t} > ${n}`),1))}Ri(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.li=()=>{this.oi.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.Ai())))},this.document.addEventListener("visibilitychange",this.li),this.inForeground="visible"===this.document.visibilityState)}Oi(){this.li&&(this.document.removeEventListener("visibilitychange",this.li),this.li=null)}Vi(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.ci=()=>{this.xi();const t=/(?:Version|Mobile)\/1[456]/;(0,a.nr)()&&(navigator.appVersion.match(t)||navigator.userAgent.match(t))&&this.oi.enterRestrictedMode(!0),this.oi.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.ci))}Ni(){this.ci&&(this.window.removeEventListener("pagehide",this.ci),this.ci=null)}Mi(t){var e;try{const n=null!==(null===(e=this.di)||void 0===e?void 0:e.getItem(this.Fi(t)));return Mr("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return Pr("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}xi(){if(this.di)try{this.di.setItem(this.Fi(this.clientId),String(Date.now()))}catch(t){Pr("Failed to set zombie client id.",t)}}Bi(){if(this.di)try{this.di.removeItem(this.Fi(this.clientId))}catch(t){}}Fi(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function Kl(t){return gi(t,"owner")}function Gl(t){return gi(t,"clientMetadata")}function jl(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class $l{constructor(t,e,n,r){this.targetId=t,this.fromCache=e,this.qi=n,this.Qi=r}static Ki(t,e){let n=pa(),r=pa();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:r=r.add(t.doc.key)}return new $l(t,e.fromCache,n,r)}}class Ql{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(t){this._documentReadCount+=t}}class Wl{constructor(){this.$i=!1,this.Ui=!1,this.Wi=100,this.Gi=(0,a.nr)()?8:Cs.v((0,a.ZQ)())>0?6:4}initialize(t,e){this.zi=t,this.indexManager=e,this.$i=!0}getDocumentsMatchingQuery(t,e,n,r){const s={result:null};return this.ji(t,e).next((t=>{s.result=t})).next((()=>{if(!s.result)return this.Hi(t,e,r,n).next((t=>{s.result=t}))})).next((()=>{if(s.result)return;const n=new Ql;return this.Ji(t,e,n).next((r=>{if(s.result=r,this.Ui)return this.Yi(t,e,n,r.size)}))})).next((()=>s.result))}Yi(t,e,n,r){return n.documentReadCount<this.Wi?(kr()<=o.$b.DEBUG&&Mr("QueryEngine","SDK will not create cache indexes for query:",ta(e),"since it only creates cache indexes for collection contains","more than or equal to",this.Wi,"documents"),Ss.resolve()):(kr()<=o.$b.DEBUG&&Mr("QueryEngine","Query:",ta(e),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.Gi*r?(kr()<=o.$b.DEBUG&&Mr("QueryEngine","The SDK decides to create cache indexes for query:",ta(e),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(t,Wo(e))):Ss.resolve())}ji(t,e){if(jo(e))return Ss.resolve(null);let n=Wo(e);return this.indexManager.getIndexType(t,n).next((r=>0===r?null:(null!==e.limit&&1===r&&(e=Xo(e,null,"F"),n=Wo(e)),this.indexManager.getDocumentsMatchingTarget(t,n).next((r=>{const s=pa(...r);return this.zi.getDocuments(t,s).next((r=>this.indexManager.getMinOffset(t,n).next((n=>{const i=this.Zi(e,r);return this.Xi(e,i,s,n.readTime)?this.ji(t,Xo(e,null,"F")):this.es(t,i,e,n)}))))})))))}Hi(t,e,n,r){return jo(e)||r.isEqual(is.min())?Ss.resolve(null):this.zi.getDocuments(t,n).next((s=>{const i=this.Zi(e,s);return this.Xi(e,i,n,r)?Ss.resolve(null):(kr()<=o.$b.DEBUG&&Mr("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),ta(e)),this.es(t,i,e,ws(r,-1)).next((t=>t)))}))}Zi(t,e){let n=new _i(ra(t));return e.forEach(((e,r)=>{ea(t,r)&&(n=n.add(r))})),n}Xi(t,e,n,r){if(null===t.limit)return!1;if(n.size!==e.size)return!0;const s="F"===t.limitType?e.last():e.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Ji(t,e,n){return kr()<=o.$b.DEBUG&&Mr("QueryEngine","Using full collection scan to execute query:",ta(e)),this.zi.getDocumentsMatchingQuery(t,e,bs.min(),n)}es(t,e,n,r){return this.zi.getDocumentsMatchingQuery(t,n,r).next((t=>(e.forEach((e=>{t=t.insert(e.key,e)})),t)))}}class Hl{constructor(t,e,n,r){this.persistence=t,this.ts=e,this.serializer=r,this.ns=new vi(es),this.rs=new ia((t=>Fo(t)),Oo),this.ss=new Map,this.os=t.getRemoteDocumentCache(),this.Qr=t.getTargetCache(),this.$r=t.getBundleCache(),this._s(n)}_s(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new xl(this.os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.os.setIndexManager(this.indexManager),this.ts.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(e=>t.collect(e,this.ns)))}}function Yl(t,e,n,r){return new Hl(t,e,n,r)}async function Xl(t,e){const n=Ur(t);return await n.persistence.runTransaction("Handle user change","readonly",(t=>{let r;return n.mutationQueue.getAllMutationBatches(t).next((s=>(r=s,n._s(e),n.mutationQueue.getAllMutationBatches(t)))).next((e=>{const s=[],i=[];let o=pa();for(const t of r){s.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const t of e){i.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}return n.localDocuments.getDocuments(t,o).next((t=>({us:t,removedBatchIds:s,addedBatchIds:i})))}))}))}function Jl(t){const e=Ur(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.Qr.getLastRemoteSnapshotVersion(t)))}function Zl(t,e,n){let r=pa(),s=pa();return n.forEach((t=>r=r.add(t))),e.getEntries(t,r).next((t=>{let r=aa();return n.forEach(((n,i)=>{const o=t.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(s=s.add(n)),i.isNoDocument()&&i.version.isEqual(is.min())?(e.removeEntry(n,i.readTime),r=r.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(e.addEntry(i),r=r.insert(n,i)):Mr("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{cs:r,ls:s}}))}function th(t,e){const n=Ur(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(t=>(void 0===e&&(e=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(t,e))))}function eh(t,e){const n=Ur(t);return n.persistence.runTransaction("Allocate target","readwrite",(t=>{let r;return n.Qr.getTargetData(t,e).next((s=>s?(r=s,Ss.resolve(r)):n.Qr.allocateTargetId(t).next((s=>(r=new nc(e,s,"TargetPurposeListen",t.currentSequenceNumber),n.Qr.addTargetData(t,r).next((()=>r)))))))})).then((t=>{const r=n.ns.get(t.targetId);return(null===r||t.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.ns=n.ns.insert(t.targetId,t),n.rs.set(e,t.targetId)),t}))}async function nh(t,e,n){const r=Ur(t),s=r.ns.get(e),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(t=>r.persistence.referenceDelegate.removeTarget(t,s)))}catch(t){if(!Ns(t))throw t;Mr("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}r.ns=r.ns.remove(e),r.rs.delete(s.target)}function rh(t,e,n){const r=Ur(t);let s=is.min(),i=pa();return r.persistence.runTransaction("Execute query","readwrite",(t=>function(t,e,n){const r=Ur(t),s=r.rs.get(n);return void 0!==s?Ss.resolve(r.ns.get(s)):r.Qr.getTargetData(e,n)}(r,t,Wo(e)).next((e=>{if(e)return s=e.lastLimboFreeSnapshotVersion,r.Qr.getMatchingKeysForTargetId(t,e.targetId).next((t=>{i=t}))})).next((()=>r.ts.getDocumentsMatchingQuery(t,e,n?s:is.min(),n?i:pa()))).next((t=>(oh(r,na(e),t),{documents:t,hs:i})))))}function sh(t,e){const n=Ur(t),r=Ur(n.Qr),s=n.ns.get(e);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(t=>r._t(t,e).next((t=>t?t.target:null))))}function ih(t,e){const n=Ur(t),r=n.ss.get(e)||is.min();return n.persistence.runTransaction("Get new document changes","readonly",(t=>n.os.getAllFromCollectionGroup(t,e,ws(r,-1),Number.MAX_SAFE_INTEGER))).then((t=>(oh(n,e,t),t)))}function oh(t,e,n){let r=t.ss.get(e)||is.min();n.forEach(((t,e)=>{e.readTime.compareTo(r)>0&&(r=e.readTime)})),t.ss.set(e,r)}async function ah(t,e,n=pa()){const r=await eh(t,Wo(hc(e.bundledQuery))),s=Ur(t);return s.persistence.runTransaction("Save named query","readwrite",(t=>{const i=Nu(e.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.$r.saveNamedQuery(t,e);const o=r.withResumeToken(Di.EMPTY_BYTE_STRING,i);return s.ns=s.ns.insert(o.targetId,o),s.Qr.updateTargetData(t,o).next((()=>s.Qr.removeMatchingKeysForTargetId(t,r.targetId))).next((()=>s.Qr.addMatchingKeys(t,n,r.targetId))).next((()=>s.$r.saveNamedQuery(t,e)))}))}function uh(t,e){return`firestore_clients_${t}_${e}`}function ch(t,e,n){let r=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function lh(t,e){return`firestore_targets_${t}_${e}`}class hh{constructor(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r}static Es(t,e,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new zr(r.error.code,r.error.message))),i?new hh(t,e,r.state,s):(Pr("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}ds(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class dh{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Es(t,e){const n=JSON.parse(e);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new zr(n.error.code,n.error.message))),s?new dh(t,n.state,r):(Pr("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}ds(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class fh{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Es(t,e){const n=JSON.parse(e);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=wa();for(let t=0;r&&t<n.activeTargetIds.length;++t)r=Us(n.activeTargetIds[t]),s=s.add(n.activeTargetIds[t]);return r?new fh(t,s):(Pr("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class mh{constructor(t,e){this.clientId=t,this.onlineState=e}static Es(t){const e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new mh(e.clientId,e.onlineState):(Pr("SharedClientState",`Failed to parse online state: ${t}`),null)}}class gh{constructor(){this.activeTargetIds=wa()}As(t){this.activeTargetIds=this.activeTargetIds.add(t)}Rs(t){this.activeTargetIds=this.activeTargetIds.delete(t)}ds(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class ph{constructor(t,e,n,r,s){this.window=t,this.oi=e,this.persistenceKey=n,this.Vs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.fs=this.gs.bind(this),this.ps=new vi(es),this.started=!1,this.ys=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.ws=uh(this.persistenceKey,this.Vs),this.Ss=function(t){return`firestore_sequence_number_${t}`}(this.persistenceKey),this.ps=this.ps.insert(this.Vs,new gh),this.bs=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.Ds=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.Cs=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.vs=function(t){return`firestore_online_state_${t}`}(this.persistenceKey),this.Fs=function(t){return`firestore_bundle_loaded_v2_${t}`}(this.persistenceKey),this.window.addEventListener("storage",this.fs)}static D(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.Li();for(const e of t){if(e===this.Vs)continue;const t=this.getItem(uh(this.persistenceKey,e));if(t){const n=fh.Es(e,t);n&&(this.ps=this.ps.insert(n.clientId,n))}}this.Ms();const e=this.storage.getItem(this.vs);if(e){const t=this.xs(e);t&&this.Os(t)}for(const t of this.ys)this.gs(t);this.ys=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(t){this.setItem(this.Ss,JSON.stringify(t))}getAllActiveQueryTargets(){return this.Ns(this.ps)}isActiveQueryTarget(t){let e=!1;return this.ps.forEach(((n,r)=>{r.activeTargetIds.has(t)&&(e=!0)})),e}addPendingMutation(t){this.Bs(t,"pending")}updateMutationState(t,e,n){this.Bs(t,e,n),this.Ls(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){const n=this.storage.getItem(lh(this.persistenceKey,t));if(n){const r=dh.Es(t,n);r&&(e=r.state)}}return this.ks.As(t),this.Ms(),e}removeLocalQueryTarget(t){this.ks.Rs(t),this.Ms()}isLocalQueryTarget(t){return this.ks.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(lh(this.persistenceKey,t))}updateQueryState(t,e,n){this.qs(t,e,n)}handleUserChange(t,e,n){e.forEach((t=>{this.Ls(t)})),this.currentUser=t,n.forEach((t=>{this.addPendingMutation(t)}))}setOnlineState(t){this.Qs(t)}notifyBundleLoaded(t){this.Ks(t)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.fs),this.removeItem(this.ws),this.started=!1)}getItem(t){const e=this.storage.getItem(t);return Mr("SharedClientState","READ",t,e),e}setItem(t,e){Mr("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){Mr("SharedClientState","REMOVE",t),this.storage.removeItem(t)}gs(t){const e=t;if(e.storageArea===this.storage){if(Mr("SharedClientState","EVENT",e.key,e.newValue),e.key===this.ws)return void Pr("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.oi.enqueueRetryable((async()=>{if(this.started){if(null!==e.key)if(this.bs.test(e.key)){if(null==e.newValue){const t=this.$s(e.key);return this.Us(t,null)}{const t=this.Ws(e.key,e.newValue);if(t)return this.Us(t.clientId,t)}}else if(this.Ds.test(e.key)){if(null!==e.newValue){const t=this.Gs(e.key,e.newValue);if(t)return this.zs(t)}}else if(this.Cs.test(e.key)){if(null!==e.newValue){const t=this.js(e.key,e.newValue);if(t)return this.Hs(t)}}else if(e.key===this.vs){if(null!==e.newValue){const t=this.xs(e.newValue);if(t)return this.Os(t)}}else if(e.key===this.Ss){const t=function(t){let e=Os._e;if(null!=t)try{const n=JSON.parse(t);Vr("number"==typeof n),e=n}catch(t){Pr("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(e.newValue);t!==Os._e&&this.sequenceNumberHandler(t)}else if(e.key===this.Fs){const t=this.Js(e.newValue);await Promise.all(t.map((t=>this.syncEngine.Ys(t))))}}else this.ys.push(e)}))}}get ks(){return this.ps.get(this.Vs)}Ms(){this.setItem(this.ws,this.ks.ds())}Bs(t,e,n){const r=new hh(this.currentUser,t,e,n),s=ch(this.persistenceKey,this.currentUser,t);this.setItem(s,r.ds())}Ls(t){const e=ch(this.persistenceKey,this.currentUser,t);this.removeItem(e)}Qs(t){const e={clientId:this.Vs,onlineState:t};this.storage.setItem(this.vs,JSON.stringify(e))}qs(t,e,n){const r=lh(this.persistenceKey,t),s=new dh(t,e,n);this.setItem(r,s.ds())}Ks(t){const e=JSON.stringify(Array.from(t));this.setItem(this.Fs,e)}$s(t){const e=this.bs.exec(t);return e?e[1]:null}Ws(t,e){const n=this.$s(t);return fh.Es(n,e)}Gs(t,e){const n=this.Ds.exec(t),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return hh.Es(new Dr(s),r,e)}js(t,e){const n=this.Cs.exec(t),r=Number(n[1]);return dh.Es(r,e)}xs(t){return mh.Es(t)}Js(t){return JSON.parse(t)}async zs(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine.Zs(t.batchId,t.state,t.error);Mr("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}Hs(t){return this.syncEngine.Xs(t.targetId,t.state,t.error)}Us(t,e){const n=e?this.ps.insert(t,e):this.ps.remove(t),r=this.Ns(this.ps),s=this.Ns(n),i=[],o=[];return s.forEach((t=>{r.has(t)||i.push(t)})),r.forEach((t=>{s.has(t)||o.push(t)})),this.syncEngine.eo(i,o).then((()=>{this.ps=n}))}Os(t){this.ps.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}Ns(t){let e=wa();return t.forEach(((t,n)=>{e=e.unionWith(n.activeTargetIds)})),e}}class yh{constructor(){this.no=new gh,this.ro={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.no.As(t),this.ro[t]||"not-current"}updateQueryState(t,e,n){this.ro[t]=e}removeLocalQueryTarget(t){this.no.Rs(t)}isLocalQueryTarget(t){return this.no.activeTargetIds.has(t)}clearQueryState(t){delete this.ro[t]}getAllActiveQueryTargets(){return this.no.activeTargetIds}isActiveQueryTarget(t){return this.no.activeTargetIds.has(t)}start(){return this.no=new gh,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}class wh{io(t){}shutdown(){}}class vh{constructor(){this.so=()=>this.oo(),this._o=()=>this.ao(),this.uo=[],this.co()}io(t){this.uo.push(t)}shutdown(){window.removeEventListener("online",this.so),window.removeEventListener("offline",this._o)}co(){window.addEventListener("online",this.so),window.addEventListener("offline",this._o)}oo(){Mr("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.uo)t(0)}ao(){Mr("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.uo)t(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let bh=null;function Ih(){return null===bh?bh=268435456+Math.round(2147483648*Math.random()):bh++,"0x"+bh.toString(16)}const _h={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Th{constructor(t){this.lo=t.lo,this.ho=t.ho}Po(t){this.Io=t}To(t){this.Eo=t}onMessage(t){this.Ao=t}close(){this.ho()}send(t){this.lo(t)}Ro(){this.Io()}Vo(t){this.Eo(t)}mo(t){this.Ao(t)}}const Eh="WebChannelConnection";class Sh extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.fo=e+"://"+t.host,this.po=`projects/${n}/databases/${r}`,this.yo="(default)"===this.databaseId.database?`project_id=${n}`:`project_id=${n}&database_id=${r}`}get wo(){return!1}So(t,e,n,r,s){const i=Ih(),o=this.bo(t,e.toUriEncodedString());Mr("RestConnection",`Sending RPC '${t}' ${i}:`,o,n);const a={"google-cloud-resource-prefix":this.po,"x-goog-request-params":this.yo};return this.Do(a,r,s),this.Co(t,o,a,n).then((e=>(Mr("RestConnection",`Received RPC '${t}' ${i}: `,e),e)),(e=>{throw Lr("RestConnection",`RPC '${t}' ${i} failed with error: `,e,"url: ",o,"request:",n),e}))}vo(t,e,n,r,s,i){return this.So(t,e,n,r,s)}Do(t,e,n){t["X-Goog-Api-Client"]="gl-js/ fire/"+Ar,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach(((e,n)=>t[n]=e)),n&&n.headers.forEach(((e,n)=>t[n]=e))}bo(t,e){const n=_h[t];return`${this.fo}/v1/${e}:${n}`}terminate(){}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}Co(t,e,n,r){const s=Ih();return new Promise(((i,o)=>{const a=new Er;a.setWithCredentials(!0),a.listenOnce(br.COMPLETE,(()=>{try{switch(a.getLastErrorCode()){case vr.NO_ERROR:const e=a.getResponseJson();Mr(Eh,`XHR for RPC '${t}' ${s} received:`,JSON.stringify(e)),i(e);break;case vr.TIMEOUT:Mr(Eh,`RPC '${t}' ${s} timed out`),o(new zr(Br.DEADLINE_EXCEEDED,"Request time out"));break;case vr.HTTP_ERROR:const n=a.getStatus();if(Mr(Eh,`RPC '${t}' ${s} failed with status:`,n,"response text:",a.getResponseText()),n>0){let t=a.getResponseJson();Array.isArray(t)&&(t=t[0]);const e=null==t?void 0:t.error;if(e&&e.status&&e.message){const t=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(Br).indexOf(e)>=0?e:Br.UNKNOWN}(e.status);o(new zr(t,e.message))}else o(new zr(Br.UNKNOWN,"Server responded with status "+a.getStatus()))}else o(new zr(Br.UNAVAILABLE,"Connection failed."));break;default:Or()}}finally{Mr(Eh,`RPC '${t}' ${s} completed.`)}}));const u=JSON.stringify(r);Mr(Eh,`RPC '${t}' ${s} sending request:`,r),a.send(e,"POST",u,n,15)}))}Fo(t,e,n){const r=Ih(),s=[this.fo,"/","google.firestore.v1.Firestore","/",t,"/channel"],i=yr(),o=wr(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(a.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(a.useFetchStreams=!0),this.Do(a.initMessageHeaders,e,n),a.encodeInitMessageHeaders=!0;const c=s.join("");Mr(Eh,`Creating RPC '${t}' stream ${r}: ${c}`,a);const l=i.createWebChannel(c,a);let h=!1,d=!1;const f=new Th({lo:e=>{d?Mr(Eh,`Not sending because RPC '${t}' stream ${r} is closed:`,e):(h||(Mr(Eh,`Opening RPC '${t}' stream ${r} transport.`),l.open(),h=!0),Mr(Eh,`RPC '${t}' stream ${r} sending:`,e),l.send(e))},ho:()=>l.close()}),m=(t,e,n)=>{t.listen(e,(t=>{try{n(t)}catch(t){setTimeout((()=>{throw t}),0)}}))};return m(l,Tr.EventType.OPEN,(()=>{d||Mr(Eh,`RPC '${t}' stream ${r} transport opened.`)})),m(l,Tr.EventType.CLOSE,(()=>{d||(d=!0,Mr(Eh,`RPC '${t}' stream ${r} transport closed`),f.Vo())})),m(l,Tr.EventType.ERROR,(e=>{d||(d=!0,Lr(Eh,`RPC '${t}' stream ${r} transport errored:`,e),f.Vo(new zr(Br.UNAVAILABLE,"The operation could not be completed")))})),m(l,Tr.EventType.MESSAGE,(e=>{var n;if(!d){const s=e.data[0];Vr(!!s);const i=s,o=i.error||(null===(n=i[0])||void 0===n?void 0:n.error);if(o){Mr(Eh,`RPC '${t}' stream ${r} received error:`,o);const e=o.status;let n=function(t){const e=nu[t];if(void 0!==e)return iu(e)}(e),s=o.message;void 0===n&&(n=Br.INTERNAL,s="Unknown error status: "+e+" with message "+o.message),d=!0,f.Vo(new zr(n,s)),l.close()}else Mr(Eh,`RPC '${t}' stream ${r} received:`,s),f.mo(s)}})),m(o,Ir.STAT_EVENT,(e=>{e.stat===_r.PROXY?Mr(Eh,`RPC '${t}' stream ${r} detected buffering proxy`):e.stat===_r.NOPROXY&&Mr(Eh,`RPC '${t}' stream ${r} detected no buffering proxy`)})),setTimeout((()=>{f.Ro()}),0),f}}function xh(){return"undefined"!=typeof window?window:null}function Ch(){return"undefined"!=typeof document?document:null}function Dh(t){return new Su(t,!0)}class Ah{constructor(t,e,n=1e3,r=1.5,s=6e4){this.oi=t,this.timerId=e,this.Mo=n,this.xo=r,this.Oo=s,this.No=0,this.Bo=null,this.Lo=Date.now(),this.reset()}reset(){this.No=0}ko(){this.No=this.Oo}qo(t){this.cancel();const e=Math.floor(this.No+this.Qo()),n=Math.max(0,Date.now()-this.Lo),r=Math.max(0,e-n);r>0&&Mr("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.No} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Bo=this.oi.enqueueAfterDelay(this.timerId,r,(()=>(this.Lo=Date.now(),t()))),this.No*=this.xo,this.No<this.Mo&&(this.No=this.Mo),this.No>this.Oo&&(this.No=this.Oo)}Ko(){null!==this.Bo&&(this.Bo.skipDelay(),this.Bo=null)}cancel(){null!==this.Bo&&(this.Bo.cancel(),this.Bo=null)}Qo(){return(Math.random()-.5)*this.No}}class Nh{constructor(t,e,n,r,s,i,o,a){this.oi=t,this.$o=n,this.Uo=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.Wo=0,this.Go=null,this.zo=null,this.stream=null,this.jo=new Ah(t,e)}Ho(){return 1===this.state||5===this.state||this.Jo()}Jo(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Yo()}async stop(){this.Ho()&&await this.close(0)}Zo(){this.state=0,this.jo.reset()}Xo(){this.Jo()&&null===this.Go&&(this.Go=this.oi.enqueueAfterDelay(this.$o,6e4,(()=>this.e_())))}t_(t){this.n_(),this.stream.send(t)}async e_(){if(this.Jo())return this.close(0)}n_(){this.Go&&(this.Go.cancel(),this.Go=null)}r_(){this.zo&&(this.zo.cancel(),this.zo=null)}async close(t,e){this.n_(),this.r_(),this.jo.cancel(),this.Wo++,4!==t?this.jo.reset():e&&e.code===Br.RESOURCE_EXHAUSTED?(Pr(e.toString()),Pr("Using maximum backoff delay to prevent overloading the backend."),this.jo.ko()):e&&e.code===Br.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.i_(),this.stream.close(),this.stream=null),this.state=t,await this.listener.To(e)}i_(){}auth(){this.state=1;const t=this.s_(this.Wo),e=this.Wo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([t,n])=>{this.Wo===e&&this.o_(t,n)}),(e=>{t((()=>{const t=new zr(Br.UNKNOWN,"Fetching auth token failed: "+e.message);return this.__(t)}))}))}o_(t,e){const n=this.s_(this.Wo);this.stream=this.a_(t,e),this.stream.Po((()=>{n((()=>(this.state=2,this.zo=this.oi.enqueueAfterDelay(this.Uo,1e4,(()=>(this.Jo()&&(this.state=3),Promise.resolve()))),this.listener.Po())))})),this.stream.To((t=>{n((()=>this.__(t)))})),this.stream.onMessage((t=>{n((()=>this.onMessage(t)))}))}Yo(){this.state=5,this.jo.qo((async()=>{this.state=0,this.start()}))}__(t){return Mr("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}s_(t){return e=>{this.oi.enqueueAndForget((()=>this.Wo===t?e():(Mr("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class kh extends Nh{constructor(t,e,n,r,s,i){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,r,i),this.serializer=s}a_(t,e){return this.connection.Fo("Listen",t,e)}onMessage(t){this.jo.reset();const e=function(t,e){let n;if("targetChange"in e){e.targetChange;const r=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:Or()}(e.targetChange.targetChangeType||"NO_CHANGE"),s=e.targetChange.targetIds||[],i=function(t,e){return t.useProto3Json?(Vr(void 0===e||"string"==typeof e),Di.fromBase64String(e||"")):(Vr(void 0===e||e instanceof Uint8Array),Di.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(t){const e=void 0===t.code?Br.UNKNOWN:iu(t.code);return new zr(e,t.message||"")}(o);n=new yu(r,s,i,a||null)}else if("documentChange"in e){e.documentChange;const r=e.documentChange;r.document,r.document.name,r.document.updateTime;const s=Lu(t,r.document.name),i=Nu(r.document.updateTime),o=r.document.createTime?Nu(r.document.createTime):is.min(),a=new oo({mapValue:{fields:r.document.fields}}),u=uo.newFoundDocument(s,i,o,a),c=r.targetIds||[],l=r.removedTargetIds||[];n=new gu(c,l,u.key,u)}else if("documentDelete"in e){e.documentDelete;const r=e.documentDelete;r.document;const s=Lu(t,r.document),i=r.readTime?Nu(r.readTime):is.min(),o=uo.newNoDocument(s,i),a=r.removedTargetIds||[];n=new gu([],a,o.key,o)}else if("documentRemove"in e){e.documentRemove;const r=e.documentRemove;r.document;const s=Lu(t,r.document),i=r.removedTargetIds||[];n=new gu([],i,s,null)}else{if(!("filter"in e))return Or();{e.filter;const t=e.filter;t.targetId;const{count:r=0,unchangedNames:s}=t,i=new eu(r,s),o=t.targetId;n=new pu(o,i)}}return n}(this.serializer,t),n=function(t){if(!("targetChange"in t))return is.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?is.min():e.readTime?Nu(e.readTime):is.min()}(t);return this.listener.u_(e,n)}c_(t){const e={};e.database=Vu(this.serializer),e.addTarget=function(t,e){let n;const r=e.target;if(n=Vo(r)?{documents:Gu(t,r)}:{query:ju(t,r).ut},n.targetId=e.targetId,e.resumeToken.approximateByteSize()>0){n.resumeToken=Du(t,e.resumeToken);const r=xu(t,e.expectedCount);null!==r&&(n.expectedCount=r)}else if(e.snapshotVersion.compareTo(is.min())>0){n.readTime=Cu(t,e.snapshotVersion.toTimestamp());const r=xu(t,e.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,t);const n=function(t,e){const n=function(t){switch(t){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return Or()}}(e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,t);n&&(e.labels=n),this.t_(e)}l_(t){const e={};e.database=Vu(this.serializer),e.removeTarget=t,this.t_(e)}}class Rh extends Nh{constructor(t,e,n,r,s,i){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,r,i),this.serializer=s,this.h_=!1}get P_(){return this.h_}start(){this.h_=!1,this.lastStreamToken=void 0,super.start()}i_(){this.h_&&this.I_([])}a_(t,e){return this.connection.Fo("Write",t,e)}onMessage(t){if(Vr(!!t.streamToken),this.lastStreamToken=t.streamToken,this.h_){this.jo.reset();const e=function(t,e){return t&&t.length>0?(Vr(void 0!==e),t.map((t=>function(t,e){let n=t.updateTime?Nu(t.updateTime):Nu(e);return n.isEqual(is.min())&&(n=Nu(e)),new La(n,t.transformResults||[])}(t,e)))):[]}(t.writeResults,t.commitTime),n=Nu(t.commitTime);return this.listener.T_(n,e)}return Vr(!t.writeResults||0===t.writeResults.length),this.h_=!0,this.listener.E_()}d_(){const t={};t.database=Vu(this.serializer),this.t_(t)}I_(t){const e={streamToken:this.lastStreamToken,writes:t.map((t=>zu(this.serializer,t)))};this.t_(e)}}class Mh extends class{}{constructor(t,e,n,r){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=n,this.serializer=r,this.A_=!1}R_(){if(this.A_)throw new zr(Br.FAILED_PRECONDITION,"The client has already been terminated.")}So(t,e,n,r){return this.R_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,i])=>this.connection.So(t,Ru(e,n),r,s,i))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Br.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new zr(Br.UNKNOWN,t.toString())}))}vo(t,e,n,r,s){return this.R_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([i,o])=>this.connection.vo(t,Ru(e,n),r,i,o,s))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Br.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new zr(Br.UNKNOWN,t.toString())}))}terminate(){this.A_=!0,this.connection.terminate()}}class Ph{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.m_=0,this.f_=null,this.g_=!0}p_(){0===this.m_&&(this.y_("Unknown"),this.f_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.f_=null,this.w_("Backend didn't respond within 10 seconds."),this.y_("Offline"),Promise.resolve()))))}S_(t){"Online"===this.state?this.y_("Unknown"):(this.m_++,this.m_>=1&&(this.b_(),this.w_(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.y_("Offline")))}set(t){this.b_(),this.m_=0,"Online"===t&&(this.g_=!1),this.y_(t)}y_(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}w_(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.g_?(Pr(e),this.g_=!1):Mr("OnlineStateTracker",e)}b_(){null!==this.f_&&(this.f_.cancel(),this.f_=null)}}class Lh{constructor(t,e,n,r,s){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.D_=[],this.C_=new Map,this.v_=new Set,this.F_=[],this.M_=s,this.M_.io((t=>{n.enqueueAndForget((async()=>{Gh(this)&&(Mr("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=Ur(t);e.v_.add(4),await Oh(e),e.x_.set("Unknown"),e.v_.delete(4),await Fh(e)}(this))}))})),this.x_=new Ph(n,r)}}async function Fh(t){if(Gh(t))for(const e of t.F_)await e(!0)}async function Oh(t){for(const e of t.F_)await e(!1)}function Vh(t,e){const n=Ur(t);n.C_.has(e.targetId)||(n.C_.set(e.targetId,e),Kh(n)?zh(n):ud(n).Jo()&&Uh(n,e))}function qh(t,e){const n=Ur(t),r=ud(n);n.C_.delete(e),r.Jo()&&Bh(n,e),0===n.C_.size&&(r.Jo()?r.Xo():Gh(n)&&n.x_.set("Unknown"))}function Uh(t,e){if(t.O_.Oe(e.targetId),e.resumeToken.approximateByteSize()>0||e.snapshotVersion.compareTo(is.min())>0){const n=t.remoteSyncer.getRemoteKeysForTarget(e.targetId).size;e=e.withExpectedCount(n)}ud(t).c_(e)}function Bh(t,e){t.O_.Oe(e),ud(t).l_(e)}function zh(t){t.O_=new vu({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),_t:e=>t.C_.get(e)||null,nt:()=>t.datastore.serializer.databaseId}),ud(t).start(),t.x_.p_()}function Kh(t){return Gh(t)&&!ud(t).Ho()&&t.C_.size>0}function Gh(t){return 0===Ur(t).v_.size}function jh(t){t.O_=void 0}async function $h(t){t.C_.forEach(((e,n)=>{Uh(t,e)}))}async function Qh(t,e){jh(t),Kh(t)?(t.x_.S_(e),zh(t)):t.x_.set("Unknown")}async function Wh(t,e,n){if(t.x_.set("Online"),e instanceof yu&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const r of e.targetIds)t.C_.has(r)&&(await t.remoteSyncer.rejectListen(r,n),t.C_.delete(r),t.O_.removeTarget(r))}(t,e)}catch(n){Mr("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),await Hh(t,n)}else if(e instanceof gu?t.O_.$e(e):e instanceof pu?t.O_.Je(e):t.O_.Ge(e),!n.isEqual(is.min()))try{const e=await Jl(t.localStore);n.compareTo(e)>=0&&await function(t,e){const n=t.O_.it(e);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=t.C_.get(r);s&&t.C_.set(r,s.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach(((e,n)=>{const r=t.C_.get(e);if(!r)return;t.C_.set(e,r.withResumeToken(Di.EMPTY_BYTE_STRING,r.snapshotVersion)),Bh(t,e);const s=new nc(r.target,e,n,r.sequenceNumber);Uh(t,s)})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){Mr("RemoteStore","Failed to raise snapshot:",e),await Hh(t,e)}}async function Hh(t,e,n){if(!Ns(e))throw e;t.v_.add(1),await Oh(t),t.x_.set("Offline"),n||(n=()=>Jl(t.localStore)),t.asyncQueue.enqueueRetryable((async()=>{Mr("RemoteStore","Retrying IndexedDB access"),await n(),t.v_.delete(1),await Fh(t)}))}function Yh(t,e){return e().catch((n=>Hh(t,n,e)))}async function Xh(t){const e=Ur(t),n=cd(e);let r=e.D_.length>0?e.D_[e.D_.length-1].batchId:-1;for(;Jh(e);)try{const t=await th(e.localStore,r);if(null===t){0===e.D_.length&&n.Xo();break}r=t.batchId,Zh(e,t)}catch(t){await Hh(e,t)}td(e)&&ed(e)}function Jh(t){return Gh(t)&&t.D_.length<10}function Zh(t,e){t.D_.push(e);const n=cd(t);n.Jo()&&n.P_&&n.I_(e.mutations)}function td(t){return Gh(t)&&!cd(t).Ho()&&t.D_.length>0}function ed(t){cd(t).start()}async function nd(t){cd(t).d_()}async function rd(t){const e=cd(t);for(const n of t.D_)e.I_(n.mutations)}async function sd(t,e,n){const r=t.D_.shift(),s=Ja.from(r,e,n);await Yh(t,(()=>t.remoteSyncer.applySuccessfulWrite(s))),await Xh(t)}async function id(t,e){e&&cd(t).P_&&await async function(t,e){if(function(t){return su(t)&&t!==Br.ABORTED}(e.code)){const n=t.D_.shift();cd(t).Zo(),await Yh(t,(()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e))),await Xh(t)}}(t,e),td(t)&&ed(t)}async function od(t,e){const n=Ur(t);n.asyncQueue.verifyOperationInProgress(),Mr("RemoteStore","RemoteStore received new credentials");const r=Gh(n);n.v_.add(3),await Oh(n),r&&n.x_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.v_.delete(3),await Fh(n)}async function ad(t,e){const n=Ur(t);e?(n.v_.delete(2),await Fh(n)):e||(n.v_.add(2),await Oh(n),n.x_.set("Unknown"))}function ud(t){return t.N_||(t.N_=function(t,e,n){const r=Ur(t);return r.R_(),new kh(e,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{Po:$h.bind(null,t),To:Qh.bind(null,t),u_:Wh.bind(null,t)}),t.F_.push((async e=>{e?(t.N_.Zo(),Kh(t)?zh(t):t.x_.set("Unknown")):(await t.N_.stop(),jh(t))}))),t.N_}function cd(t){return t.B_||(t.B_=function(t,e,n){const r=Ur(t);return r.R_(),new Rh(e,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{Po:nd.bind(null,t),To:id.bind(null,t),E_:rd.bind(null,t),T_:sd.bind(null,t)}),t.F_.push((async e=>{e?(t.B_.Zo(),await Xh(t)):(await t.B_.stop(),t.D_.length>0&&(Mr("RemoteStore",`Stopping write stream with ${t.D_.length} pending writes`),t.D_=[]))}))),t.B_}class ld{constructor(t,e,n,r,s){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new Kr,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((t=>{}))}get promise(){return this.deferred.promise}static createAndSchedule(t,e,n,r,s){const i=Date.now()+n,o=new ld(t,e,i,r,s);return o.start(n),o}start(t){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new zr(Br.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((t=>this.deferred.resolve(t)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function hd(t,e){if(Pr("AsyncQueue",`${e}: ${t}`),Ns(t))return new zr(Br.UNAVAILABLE,`${e}: ${t}`);throw t}class dd{constructor(t){this.comparator=t?(e,n)=>t(e,n)||ls.comparator(e.key,n.key):(t,e)=>ls.comparator(t.key,e.key),this.keyedMap=ca(),this.sortedSet=new vi(this.comparator)}static emptySet(t){return new dd(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal(((e,n)=>(t(e),!1)))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof dd))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(!t.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach((e=>{t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new dd;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class fd{constructor(){this.L_=new vi(ls.comparator)}track(t){const e=t.doc.key,n=this.L_.get(e);n?0!==t.type&&3===n.type?this.L_=this.L_.insert(e,t):3===t.type&&1!==n.type?this.L_=this.L_.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.L_=this.L_.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.L_=this.L_.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.L_=this.L_.remove(e):1===t.type&&2===n.type?this.L_=this.L_.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.L_=this.L_.insert(e,{type:2,doc:t.doc}):Or():this.L_=this.L_.insert(e,t)}k_(){const t=[];return this.L_.inorderTraversal(((e,n)=>{t.push(n)})),t}}class md{constructor(t,e,n,r,s,i,o,a,u){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=u}static fromInitialDocuments(t,e,n,r,s){const i=[];return e.forEach((t=>{i.push({type:0,doc:t})})),new md(t,e,dd.emptySet(e),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&Jo(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let t=0;t<e.length;t++)if(e[t].type!==n[t].type||!e[t].doc.isEqual(n[t].doc))return!1;return!0}}class gd{constructor(){this.q_=void 0,this.Q_=[]}}class pd{constructor(){this.queries=new ia((t=>Zo(t)),Jo),this.onlineState="Unknown",this.K_=new Set}}async function yd(t,e){const n=Ur(t),r=e.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new gd),s)try{i.q_=await n.onListen(r)}catch(t){const n=hd(t,`Initialization of query '${ta(e.query)}' failed`);return void e.onError(n)}n.queries.set(r,i),i.Q_.push(e),e.U_(n.onlineState),i.q_&&e.W_(i.q_)&&Id(n)}async function wd(t,e){const n=Ur(t),r=e.query;let s=!1;const i=n.queries.get(r);if(i){const t=i.Q_.indexOf(e);t>=0&&(i.Q_.splice(t,1),s=0===i.Q_.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function vd(t,e){const n=Ur(t);let r=!1;for(const t of e){const e=t.query,s=n.queries.get(e);if(s){for(const e of s.Q_)e.W_(t)&&(r=!0);s.q_=t}}r&&Id(n)}function bd(t,e,n){const r=Ur(t),s=r.queries.get(e);if(s)for(const t of s.Q_)t.onError(n);r.queries.delete(e)}function Id(t){t.K_.forEach((t=>{t.next()}))}class _d{constructor(t,e,n){this.query=t,this.G_=e,this.z_=!1,this.j_=null,this.onlineState="Unknown",this.options=n||{}}W_(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new md(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.z_?this.H_(t)&&(this.G_.next(t),e=!0):this.J_(t,this.onlineState)&&(this.Y_(t),e=!0),this.j_=t,e}onError(t){this.G_.error(t)}U_(t){this.onlineState=t;let e=!1;return this.j_&&!this.z_&&this.J_(this.j_,t)&&(this.Y_(this.j_),e=!0),e}J_(t,e){if(!t.fromCache)return!0;const n="Offline"!==e;return(!this.options.Z_||!n)&&(!t.docs.isEmpty()||t.hasCachedResults||"Offline"===e)}H_(t){if(t.docChanges.length>0)return!0;const e=this.j_&&this.j_.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}Y_(t){t=md.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.z_=!0,this.G_.next(t)}}class Td{constructor(t,e){this.X_=t,this.byteLength=e}ea(){return"metadata"in this.X_}}class Ed{constructor(t){this.serializer=t}Ps(t){return Lu(this.serializer,t)}Is(t){return t.metadata.exists?Bu(this.serializer,t.document,!1):uo.newNoDocument(this.Ps(t.metadata.name),this.Ts(t.metadata.readTime))}Ts(t){return Nu(t)}}class Sd{constructor(t,e,n){this.ta=t,this.localStore=e,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=xd(t)}na(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;if(t.X_.namedQuery)this.queries.push(t.X_.namedQuery);else if(t.X_.documentMetadata){this.documents.push({metadata:t.X_.documentMetadata}),t.X_.documentMetadata.exists||++e;const n=as.fromString(t.X_.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else t.X_.document&&(this.documents[this.documents.length-1].document=t.X_.document,++e);return e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}ra(t){const e=new Map,n=new Ed(this.serializer);for(const r of t)if(r.metadata.queries){const t=n.Ps(r.metadata.name);for(const n of r.metadata.queries){const r=(e.get(n)||pa()).add(t);e.set(n,r)}}return e}async complete(){const t=await async function(t,e,n,r){const s=Ur(t);let i=pa(),o=aa();for(const t of n){const n=e.Ps(t.metadata.name);t.document&&(i=i.add(n));const r=e.Is(t);r.setReadTime(e.Ts(t.metadata.readTime)),o=o.insert(n,r)}const a=s.os.newChangeBuffer({trackRemovals:!0}),u=await eh(s,function(t){return Wo(Go(as.fromString(`__bundle__/docs/${t}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(t=>Zl(t,a,o).next((e=>(a.apply(t),e))).next((e=>s.Qr.removeMatchingKeysForTargetId(t,u.targetId).next((()=>s.Qr.addMatchingKeys(t,i,u.targetId))).next((()=>s.localDocuments.getLocalViewOfDocuments(t,e.cs,e.ls))).next((()=>e.cs))))))}(this.localStore,new Ed(this.serializer),this.documents,this.ta.id),e=this.ra(this.documents);for(const t of this.queries)await ah(this.localStore,t,e.get(t.name));return this.progress.taskState="Success",{progress:this.progress,ia:this.collectionGroups,sa:t}}}function xd(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class Cd{constructor(t){this.key=t}}class Dd{constructor(t){this.key=t}}class Ad{constructor(t,e){this.query=t,this.oa=e,this._a=null,this.hasCachedResults=!1,this.current=!1,this.aa=pa(),this.mutatedKeys=pa(),this.ua=ra(t),this.ca=new dd(this.ua)}get la(){return this.oa}ha(t,e){const n=e?e.Pa:new fd,r=e?e.ca:this.ca;let s=e?e.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,u="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(t.inorderTraversal(((t,e)=>{const c=r.get(t),l=ea(this.query,e)?e:null,h=!!c&&this.mutatedKeys.has(c.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;c&&l?c.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.Ia(c,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.ua(l,a)>0||u&&this.ua(l,u)<0)&&(o=!0)):!c&&l?(n.track({type:0,doc:l}),f=!0):c&&!l&&(n.track({type:1,doc:c}),f=!0,(a||u)&&(o=!0)),f&&(l?(i=i.add(l),s=d?s.add(t):s.delete(t)):(i=i.delete(t),s=s.delete(t)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const t="F"===this.query.limitType?i.last():i.first();i=i.delete(t.key),s=s.delete(t.key),n.track({type:1,doc:t})}return{ca:i,Pa:n,Xi:o,mutatedKeys:s}}Ia(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n,r){const s=this.ca;this.ca=t.ca,this.mutatedKeys=t.mutatedKeys;const i=t.Pa.k_();i.sort(((t,e)=>function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Or()}};return n(t)-n(e)}(t.type,e.type)||this.ua(t.doc,e.doc))),this.Ta(n),r=null!=r&&r;const o=e&&!r?this.Ea():[],a=0===this.aa.size&&this.current&&!r?1:0,u=a!==this._a;return this._a=a,0!==i.length||u?{snapshot:new md(this.query,t.ca,s,i,t.mutatedKeys,0===a,u,!1,!!n&&n.resumeToken.approximateByteSize()>0),da:o}:{da:o}}U_(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({ca:this.ca,Pa:new fd,mutatedKeys:this.mutatedKeys,Xi:!1},!1)):{da:[]}}Aa(t){return!this.oa.has(t)&&!!this.ca.has(t)&&!this.ca.get(t).hasLocalMutations}Ta(t){t&&(t.addedDocuments.forEach((t=>this.oa=this.oa.add(t))),t.modifiedDocuments.forEach((t=>{})),t.removedDocuments.forEach((t=>this.oa=this.oa.delete(t))),this.current=t.current)}Ea(){if(!this.current)return[];const t=this.aa;this.aa=pa(),this.ca.forEach((t=>{this.Aa(t.key)&&(this.aa=this.aa.add(t.key))}));const e=[];return t.forEach((t=>{this.aa.has(t)||e.push(new Dd(t))})),this.aa.forEach((n=>{t.has(n)||e.push(new Cd(n))})),e}Ra(t){this.oa=t.hs,this.aa=pa();const e=this.ha(t.documents);return this.applyChanges(e,!0)}Va(){return md.fromInitialDocuments(this.query,this.ca,this.mutatedKeys,0===this._a,this.hasCachedResults)}}class Nd{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class kd{constructor(t){this.key=t,this.ma=!1}}class Rd{constructor(t,e,n,r,s,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.fa={},this.ga=new ia((t=>Zo(t)),Jo),this.pa=new Map,this.ya=new Set,this.wa=new vi(ls.comparator),this.Sa=new Map,this.ba=new Al,this.Da={},this.Ca=new Map,this.va=sl.Bn(),this.onlineState="Unknown",this.Fa=void 0}get isPrimaryClient(){return!0===this.Fa}}async function Md(t,e){const n=of(t);let r,s;const i=n.ga.get(e);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.Va();else{const t=await eh(n.localStore,Wo(e)),i=n.sharedClientState.addLocalQueryTarget(t.targetId);r=t.targetId,s=await Pd(n,e,r,"current"===i,t.resumeToken),n.isPrimaryClient&&Vh(n.remoteStore,t)}return s}async function Pd(t,e,n,r,s){t.Ma=(e,n,r)=>async function(t,e,n,r){let s=e.view.ha(n);s.Xi&&(s=await rh(t.localStore,e.query,!1).then((({documents:t})=>e.view.ha(t,s))));const i=r&&r.targetChanges.get(e.targetId),o=r&&null!=r.targetMismatches.get(e.targetId),a=e.view.applyChanges(s,t.isPrimaryClient,i,o);return jd(t,e.targetId,a.da),a.snapshot}(t,e,n,r);const i=await rh(t.localStore,e,!0),o=new Ad(e,i.hs),a=o.ha(i.documents),u=mu.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==t.onlineState,s),c=o.applyChanges(a,t.isPrimaryClient,u);jd(t,n,c.da);const l=new Nd(e,n,o);return t.ga.set(e,l),t.pa.has(n)?t.pa.get(n).push(e):t.pa.set(n,[e]),c.snapshot}async function Ld(t,e){const n=Ur(t),r=n.ga.get(e),s=n.pa.get(r.targetId);if(s.length>1)return n.pa.set(r.targetId,s.filter((t=>!Jo(t,e)))),void n.ga.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await nh(n.localStore,r.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(r.targetId),qh(n.remoteStore,r.targetId),Kd(n,r.targetId)})).catch(Es)):(Kd(n,r.targetId),await nh(n.localStore,r.targetId,!0))}async function Fd(t,e){const n=Ur(t);try{const t=await function(t,e){const n=Ur(t),r=e.snapshotVersion;let s=n.ns;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(t=>{const i=n.os.newChangeBuffer({trackRemovals:!0});s=n.ns;const o=[];e.targetChanges.forEach(((i,a)=>{const u=s.get(a);if(!u)return;o.push(n.Qr.removeMatchingKeys(t,i.removedDocuments,a).next((()=>n.Qr.addMatchingKeys(t,i.addedDocuments,a))));let c=u.withSequenceNumber(t.currentSequenceNumber);null!==e.targetMismatches.get(a)?c=c.withResumeToken(Di.EMPTY_BYTE_STRING,is.min()).withLastLimboFreeSnapshotVersion(is.min()):i.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(i.resumeToken,r)),s=s.insert(a,c),function(t,e,n){return 0===t.resumeToken.approximateByteSize()||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(u,c,i)&&o.push(n.Qr.updateTargetData(t,c))}));let a=aa(),u=pa();if(e.documentUpdates.forEach((r=>{e.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(t,r))})),o.push(Zl(t,i,e.documentUpdates).next((t=>{a=t.cs,u=t.ls}))),!r.isEqual(is.min())){const e=n.Qr.getLastRemoteSnapshotVersion(t).next((e=>n.Qr.setTargetsMetadata(t,t.currentSequenceNumber,r)));o.push(e)}return Ss.waitFor(o).next((()=>i.apply(t))).next((()=>n.localDocuments.getLocalViewOfDocuments(t,a,u))).next((()=>a))})).then((t=>(n.ns=s,t)))}(n.localStore,e);e.targetChanges.forEach(((t,e)=>{const r=n.Sa.get(e);r&&(Vr(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?r.ma=!0:t.modifiedDocuments.size>0?Vr(r.ma):t.removedDocuments.size>0&&(Vr(r.ma),r.ma=!1))})),await Wd(n,t,e)}catch(t){await Es(t)}}function Od(t,e,n){const r=Ur(t);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const t=[];r.ga.forEach(((n,r)=>{const s=r.view.U_(e);s.snapshot&&t.push(s.snapshot)})),function(t,e){const n=Ur(t);n.onlineState=e;let r=!1;n.queries.forEach(((t,n)=>{for(const t of n.Q_)t.U_(e)&&(r=!0)})),r&&Id(n)}(r.eventManager,e),t.length&&r.fa.u_(t),r.onlineState=e,r.isPrimaryClient&&r.sharedClientState.setOnlineState(e)}}async function Vd(t,e,n){const r=Ur(t);r.sharedClientState.updateQueryState(e,"rejected",n);const s=r.Sa.get(e),i=s&&s.key;if(i){let t=new vi(ls.comparator);t=t.insert(i,uo.newNoDocument(i,is.min()));const n=pa().add(i),s=new fu(is.min(),new Map,new vi(es),t,n);await Fd(r,s),r.wa=r.wa.remove(i),r.Sa.delete(e),Qd(r)}else await nh(r.localStore,e,!1).then((()=>Kd(r,e,n))).catch(Es)}async function qd(t,e){const n=Ur(t),r=e.batch.batchId;try{const t=await function(t,e){const n=Ur(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(t=>{const r=e.batch.keys(),s=n.os.newChangeBuffer({trackRemovals:!0});return function(t,e,n,r){const s=n.batch,i=s.keys();let o=Ss.resolve();return i.forEach((t=>{o=o.next((()=>r.getEntry(e,t))).next((e=>{const i=n.docVersions.get(t);Vr(null!==i),e.version.compareTo(i)<0&&(s.applyToRemoteDocument(e,n),e.isValidDocument()&&(e.setReadTime(n.commitVersion),r.addEntry(e)))}))})),o.next((()=>t.mutationQueue.removeMutationBatch(e,s)))}(n,t,e,s).next((()=>s.apply(t))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,r,e.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,function(t){let e=pa();for(let n=0;n<t.mutationResults.length;++n)t.mutationResults[n].transformResults.length>0&&(e=e.add(t.batch.mutations[n].key));return e}(e)))).next((()=>n.localDocuments.getDocuments(t,r)))}))}(n.localStore,e);zd(n,r,null),Bd(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Wd(n,t)}catch(t){await Es(t)}}async function Ud(t,e,n){const r=Ur(t);try{const t=await function(t,e){const n=Ur(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(t=>{let r;return n.mutationQueue.lookupMutationBatch(t,e).next((e=>(Vr(null!==e),r=e.keys(),n.mutationQueue.removeMutationBatch(t,e)))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,r,e))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,r))).next((()=>n.localDocuments.getDocuments(t,r)))}))}(r.localStore,e);zd(r,e,n),Bd(r,e),r.sharedClientState.updateMutationState(e,"rejected",n),await Wd(r,t)}catch(n){await Es(n)}}function Bd(t,e){(t.Ca.get(e)||[]).forEach((t=>{t.resolve()})),t.Ca.delete(e)}function zd(t,e,n){const r=Ur(t);let s=r.Da[r.currentUser.toKey()];if(s){const t=s.get(e);t&&(n?t.reject(n):t.resolve(),s=s.remove(e)),r.Da[r.currentUser.toKey()]=s}}function Kd(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.pa.get(e))t.ga.delete(r),n&&t.fa.xa(r,n);t.pa.delete(e),t.isPrimaryClient&&t.ba.Vr(e).forEach((e=>{t.ba.containsKey(e)||Gd(t,e)}))}function Gd(t,e){t.ya.delete(e.path.canonicalString());const n=t.wa.get(e);null!==n&&(qh(t.remoteStore,n),t.wa=t.wa.remove(e),t.Sa.delete(n),Qd(t))}function jd(t,e,n){for(const r of n)r instanceof Cd?(t.ba.addReference(r.key,e),$d(t,r)):r instanceof Dd?(Mr("SyncEngine","Document no longer in limbo: "+r.key),t.ba.removeReference(r.key,e),t.ba.containsKey(r.key)||Gd(t,r.key)):Or()}function $d(t,e){const n=e.key,r=n.path.canonicalString();t.wa.get(n)||t.ya.has(r)||(Mr("SyncEngine","New document in limbo: "+n),t.ya.add(r),Qd(t))}function Qd(t){for(;t.ya.size>0&&t.wa.size<t.maxConcurrentLimboResolutions;){const e=t.ya.values().next().value;t.ya.delete(e);const n=new ls(as.fromString(e)),r=t.va.next();t.Sa.set(r,new kd(n)),t.wa=t.wa.insert(n,r),Vh(t.remoteStore,new nc(Wo(Go(n.path)),r,"TargetPurposeLimboResolution",Os._e))}}async function Wd(t,e,n){const r=Ur(t),s=[],i=[],o=[];r.ga.isEmpty()||(r.ga.forEach(((t,a)=>{o.push(r.Ma(a,e,n).then((t=>{if((t||n)&&r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,(null==t?void 0:t.fromCache)?"not-current":"current"),t){s.push(t);const e=$l.Ki(a.targetId,t);i.push(e)}})))})),await Promise.all(o),r.fa.u_(s),await async function(t,e){const n=Ur(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(t=>Ss.forEach(e,(e=>Ss.forEach(e.qi,(r=>n.persistence.referenceDelegate.addReference(t,e.targetId,r))).next((()=>Ss.forEach(e.Qi,(r=>n.persistence.referenceDelegate.removeReference(t,e.targetId,r)))))))))}catch(t){if(!Ns(t))throw t;Mr("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=n.ns.get(e),r=t.snapshotVersion,s=t.withLastLimboFreeSnapshotVersion(r);n.ns=n.ns.insert(e,s)}}}(r.localStore,i))}async function Hd(t,e){const n=Ur(t);if(!n.currentUser.isEqual(e)){Mr("SyncEngine","User change. New user:",e.toKey());const t=await Xl(n.localStore,e);n.currentUser=e,function(t,e){t.Ca.forEach((t=>{t.forEach((t=>{t.reject(new zr(Br.CANCELLED,e))}))})),t.Ca.clear()}(n,"'waitForPendingWrites' promise is rejected due to a user change."),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await Wd(n,t.us)}}function Yd(t,e){const n=Ur(t),r=n.Sa.get(e);if(r&&r.ma)return pa().add(r.key);{let t=pa();const r=n.pa.get(e);if(!r)return t;for(const e of r){const r=n.ga.get(e);t=t.unionWith(r.view.la)}return t}}async function Xd(t,e){const n=Ur(t),r=await rh(n.localStore,e.query,!0),s=e.view.Ra(r);return n.isPrimaryClient&&jd(n,e.targetId,s.da),s}async function Jd(t,e){const n=Ur(t);return ih(n.localStore,e).then((t=>Wd(n,t)))}async function Zd(t,e,n,r){const s=Ur(t),i=await function(t,e){const n=Ur(t),r=Ur(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(t=>r.vn(t,e).next((e=>e?n.localDocuments.getDocuments(t,e):Ss.resolve(null)))))}(s.localStore,e);null!==i?("pending"===n?await Xh(s.remoteStore):"acknowledged"===n||"rejected"===n?(zd(s,e,r||null),Bd(s,e),function(t,e){Ur(Ur(t).mutationQueue).Mn(e)}(s.localStore,e)):Or(),await Wd(s,i)):Mr("SyncEngine","Cannot apply mutation batch with id: "+e)}async function tf(t,e,n){const r=Ur(t),s=[],i=[];for(const t of e){let e;const n=r.pa.get(t);if(n&&0!==n.length){e=await eh(r.localStore,Wo(n[0]));for(const t of n){const e=r.ga.get(t),n=await Xd(r,e);n.snapshot&&i.push(n.snapshot)}}else{const n=await sh(r.localStore,t);e=await eh(r.localStore,n),await Pd(r,ef(n),t,!1,e.resumeToken)}s.push(e)}return r.fa.u_(i),s}function ef(t){return Ko(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function nf(t){return function(t){return Ur(Ur(t).persistence).Li()}(Ur(t).localStore)}async function rf(t,e,n,r){const s=Ur(t);if(s.Fa)return void Mr("SyncEngine","Ignoring unexpected query state notification.");const i=s.pa.get(e);if(i&&i.length>0)switch(n){case"current":case"not-current":{const t=await ih(s.localStore,na(i[0])),r=fu.createSynthesizedRemoteEventForCurrentChange(e,"current"===n,Di.EMPTY_BYTE_STRING);await Wd(s,t,r);break}case"rejected":await nh(s.localStore,e,!0),Kd(s,e,r);break;default:Or()}}async function sf(t,e,n){const r=of(t);if(r.Fa){for(const t of e){if(r.pa.has(t)){Mr("SyncEngine","Adding an already active target "+t);continue}const e=await sh(r.localStore,t),n=await eh(r.localStore,e);await Pd(r,ef(e),n.targetId,!1,n.resumeToken),Vh(r.remoteStore,n)}for(const t of n)r.pa.has(t)&&await nh(r.localStore,t,!1).then((()=>{qh(r.remoteStore,t),Kd(r,t)})).catch(Es)}}function of(t){const e=Ur(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=Fd.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=Yd.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=Vd.bind(null,e),e.fa.u_=vd.bind(null,e.eventManager),e.fa.xa=bd.bind(null,e.eventManager),e}function af(t){const e=Ur(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=qd.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=Ud.bind(null,e),e}class uf{constructor(){this.synchronizeTabs=!1}async initialize(t){this.serializer=Dh(t.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(t),this.persistence=this.createPersistence(t),await this.persistence.start(),this.localStore=this.createLocalStore(t),this.gcScheduler=this.createGarbageCollectionScheduler(t,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(t,this.localStore)}createGarbageCollectionScheduler(t,e){return null}createIndexBackfillerScheduler(t,e){return null}createLocalStore(t){return Yl(this.persistence,new Wl,t.initialUser,this.serializer)}createPersistence(t){return new Ll(Ol.Hr,this.serializer)}createSharedClientState(t){return new yh}async terminate(){var t,e;null===(t=this.gcScheduler)||void 0===t||t.stop(),null===(e=this.indexBackfillerScheduler)||void 0===e||e.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class cf extends uf{constructor(t){super(),this.cacheSizeBytes=t}createGarbageCollectionScheduler(t,e){Vr(this.persistence.referenceDelegate instanceof Vl);const n=this.persistence.referenceDelegate.garbageCollector;return new hl(n,t.asyncQueue,e)}createPersistence(t){const e=void 0!==this.cacheSizeBytes?Yc.withCacheSize(this.cacheSizeBytes):Yc.DEFAULT;return new Ll((t=>Vl.Hr(t,e)),this.serializer)}}class lf extends uf{constructor(t,e,n){super(),this.Na=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await this.Na.initialize(this,t),await af(this.Na.syncEngine),await Xh(this.Na.remoteStore),await this.persistence.fi((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}createLocalStore(t){return Yl(this.persistence,new Wl,t.initialUser,this.serializer)}createGarbageCollectionScheduler(t,e){const n=this.persistence.referenceDelegate.garbageCollector;return new hl(n,t.asyncQueue,e)}createIndexBackfillerScheduler(t,e){const n=new Fs(e,this.persistence);return new Ls(t.asyncQueue,n)}createPersistence(t){const e=jl(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Yc.withCacheSize(this.cacheSizeBytes):Yc.DEFAULT;return new zl(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,xh(),Ch(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(t){return new yh}}class hf extends lf{constructor(t,e){super(t,e,!1),this.Na=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);const e=this.Na.syncEngine;this.sharedClientState instanceof ph&&(this.sharedClientState.syncEngine={Zs:Zd.bind(null,e),Xs:rf.bind(null,e),eo:sf.bind(null,e),Li:nf.bind(null,e),Ys:Jd.bind(null,e)},await this.sharedClientState.start()),await this.persistence.fi((async t=>{await async function(t,e){const n=Ur(t);if(of(n),af(n),!0===e&&!0!==n.Fa){const t=n.sharedClientState.getAllActiveQueryTargets(),e=await tf(n,t.toArray());n.Fa=!0,await ad(n.remoteStore,!0);for(const t of e)Vh(n.remoteStore,t)}else if(!1===e&&!1!==n.Fa){const t=[];let e=Promise.resolve();n.pa.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?t.push(s):e=e.then((()=>(Kd(n,s),nh(n.localStore,s,!0)))),qh(n.remoteStore,s)})),await e,await tf(n,t),function(t){const e=Ur(t);e.Sa.forEach(((t,n)=>{qh(e.remoteStore,n)})),e.ba.mr(),e.Sa=new Map,e.wa=new vi(ls.comparator)}(n),n.Fa=!1,await ad(n.remoteStore,!1)}}(this.Na.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start():t||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(t&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():t||this.indexBackfillerScheduler.stop())}))}createSharedClientState(t){const e=xh();if(!ph.D(e))throw new zr(Br.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=jl(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new ph(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class df{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>Od(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=Hd.bind(null,this.syncEngine),await ad(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new pd}createDatastore(t){const e=Dh(t.databaseInfo.databaseId),n=function(t){return new Sh(t)}(t.databaseInfo);return function(t,e,n,r){return new Mh(t,e,n,r)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return function(t,e,n,r,s){return new Lh(t,e,n,r,s)}(this.localStore,this.datastore,t.asyncQueue,(t=>Od(this.syncEngine,t,0)),vh.D()?new vh:new wh)}createSyncEngine(t,e){return function(t,e,n,r,s,i,o){const a=new Rd(t,e,n,r,s,i);return o&&(a.Fa=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}async terminate(){var t;await async function(t){const e=Ur(t);Mr("RemoteStore","RemoteStore shutting down."),e.v_.add(5),await Oh(e),e.M_.shutdown(),e.x_.set("Unknown")}(this.remoteStore),null===(t=this.datastore)||void 0===t||t.terminate()}}function ff(t,e=10240){let n=0;return{async read(){if(n<t.byteLength){const r={value:t.slice(n,n+e),done:!1};return n+=e,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class mf{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.Ba(this.observer.next,t)}error(t){this.observer.error?this.Ba(this.observer.error,t):Pr("Uncaught Error in snapshot listener:",t.toString())}La(){this.muted=!0}Ba(t,e){this.muted||setTimeout((()=>{this.muted||t(e)}),0)}}class gf{constructor(t,e){this.ka=t,this.serializer=e,this.metadata=new Kr,this.buffer=new Uint8Array,this.qa=new TextDecoder("utf-8"),this.Qa().then((t=>{t&&t.ea()?this.metadata.resolve(t.X_.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.X_)}`))}),(t=>this.metadata.reject(t)))}close(){return this.ka.cancel()}async getMetadata(){return this.metadata.promise}async Oa(){return await this.getMetadata(),this.Qa()}async Qa(){const t=await this.Ka();if(null===t)return null;const e=this.qa.decode(t),n=Number(e);isNaN(n)&&this.$a(`length string (${e}) is not valid number`);const r=await this.Ua(n);return new Td(JSON.parse(r),t.length+n)}Wa(){return this.buffer.findIndex((t=>t==="{".charCodeAt(0)))}async Ka(){for(;this.Wa()<0&&!await this.Ga(););if(0===this.buffer.length)return null;const t=this.Wa();t<0&&this.$a("Reached the end of bundle when a length string is expected.");const e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async Ua(t){for(;this.buffer.length<t;)await this.Ga()&&this.$a("Reached the end of bundle when more is expected.");const e=this.qa.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}$a(t){throw this.ka.cancel(),new Error(`Invalid bundle format: ${t}`)}async Ga(){const t=await this.ka.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class pf{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new zr(Br.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;const e=await async function(t,e){const n=Ur(t),r={documents:e.map((t=>Pu(n.serializer,t)))},s=await n.vo("BatchGetDocuments",n.serializer.databaseId,as.emptyPath(),r,e.length),i=new Map;s.forEach((t=>{const e=function(t,e){return"found"in e?function(t,e){Vr(!!e.found),e.found.name,e.found.updateTime;const n=Lu(t,e.found.name),r=Nu(e.found.updateTime),s=e.found.createTime?Nu(e.found.createTime):is.min(),i=new oo({mapValue:{fields:e.found.fields}});return uo.newFoundDocument(n,r,s,i)}(t,e):"missing"in e?function(t,e){Vr(!!e.missing),Vr(!!e.readTime);const n=Lu(t,e.missing),r=Nu(e.readTime);return uo.newNoDocument(n,r)}(t,e):Or()}(n.serializer,t);i.set(e.key.toString(),e)}));const o=[];return e.forEach((t=>{const e=i.get(t.toString());Vr(!!e),o.push(e)})),o}(this.datastore,t);return e.forEach((t=>this.recordVersion(t))),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastTransactionError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new Ha(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;const t=this.readVersions;this.mutations.forEach((e=>{t.delete(e.key.toString())})),t.forEach(((t,e)=>{const n=ls.fromPath(e);this.mutations.push(new Ya(n,this.precondition(n)))})),await async function(t,e){const n=Ur(t),r={writes:e.map((t=>zu(n.serializer,t)))};await n.So("Commit",n.serializer.databaseId,as.emptyPath(),r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw Or();e=is.min()}const n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new zr(Br.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){const e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?e.isEqual(is.min())?Fa.exists(!1):Fa.updateTime(e):Fa.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(is.min()))throw new zr(Br.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Fa.updateTime(e)}return Fa.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class yf{constructor(t,e,n,r,s){this.asyncQueue=t,this.datastore=e,this.options=n,this.updateFunction=r,this.deferred=s,this.za=n.maxAttempts,this.jo=new Ah(this.asyncQueue,"transaction_retry")}ja(){this.za-=1,this.Ha()}Ha(){this.jo.qo((async()=>{const t=new pf(this.datastore),e=this.Ja(t);e&&e.then((e=>{this.asyncQueue.enqueueAndForget((()=>t.commit().then((()=>{this.deferred.resolve(e)})).catch((t=>{this.Ya(t)}))))})).catch((t=>{this.Ya(t)}))}))}Ja(t){try{const e=this.updateFunction(t);return!Vs(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}Ya(t){this.za>0&&this.Za(t)?(this.za-=1,this.asyncQueue.enqueueAndForget((()=>(this.Ha(),Promise.resolve())))):this.deferred.reject(t)}Za(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||"already-exists"===e||!su(e)}return!1}}class wf{constructor(t,e,n,r){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=r,this.user=Dr.UNAUTHENTICATED,this.clientId=ts.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async t=>{Mr("FirestoreClient","Received user=",t.uid),await this.authCredentialListener(t),this.user=t})),this.appCheckCredentials.start(n,(t=>(Mr("FirestoreClient","Received new app check token=",t),this.appCheckCredentialListener(t,this.user))))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new zr(Br.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const t=new Kr;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const n=hd(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}}async function vf(t,e){t.asyncQueue.verifyOperationInProgress(),Mr("FirestoreClient","Initializing OfflineComponentProvider");const n=t.configuration;await e.initialize(n);let r=n.initialUser;t.setCredentialChangeListener((async t=>{r.isEqual(t)||(await Xl(e.localStore,t),r=t)})),e.persistence.setDatabaseDeletedListener((()=>t.terminate())),t._offlineComponents=e}async function bf(t,e){t.asyncQueue.verifyOperationInProgress();const n=await _f(t);Mr("FirestoreClient","Initializing OnlineComponentProvider"),await e.initialize(n,t.configuration),t.setCredentialChangeListener((t=>od(e.remoteStore,t))),t.setAppCheckTokenChangeListener(((t,n)=>od(e.remoteStore,n))),t._onlineComponents=e}function If(t){return"FirebaseError"===t.name?t.code===Br.FAILED_PRECONDITION||t.code===Br.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code}async function _f(t){if(!t._offlineComponents)if(t._uninitializedComponentsProvider){Mr("FirestoreClient","Using user provided OfflineComponentProvider");try{await vf(t,t._uninitializedComponentsProvider._offline)}catch(e){const n=e;if(!If(n))throw n;Lr("Error using user provided cache. Falling back to memory cache: "+n),await vf(t,new uf)}}else Mr("FirestoreClient","Using default OfflineComponentProvider"),await vf(t,new uf);return t._offlineComponents}async function Tf(t){return t._onlineComponents||(t._uninitializedComponentsProvider?(Mr("FirestoreClient","Using user provided OnlineComponentProvider"),await bf(t,t._uninitializedComponentsProvider._online)):(Mr("FirestoreClient","Using default OnlineComponentProvider"),await bf(t,new df))),t._onlineComponents}function Ef(t){return _f(t).then((t=>t.persistence))}function Sf(t){return _f(t).then((t=>t.localStore))}function xf(t){return Tf(t).then((t=>t.remoteStore))}function Cf(t){return Tf(t).then((t=>t.syncEngine))}function Df(t){return Tf(t).then((t=>t.datastore))}async function Af(t){const e=await Tf(t),n=e.eventManager;return n.onListen=Md.bind(null,e.syncEngine),n.onUnlisten=Ld.bind(null,e.syncEngine),n}function Nf(t,e,n={}){const r=new Kr;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,r,s){const i=new mf({next:i=>{e.enqueueAndForget((()=>wd(t,o)));const a=i.docs.has(n);!a&&i.fromCache?s.reject(new zr(Br.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&r&&"server"===r.source?s.reject(new zr(Br.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(i)},error:t=>s.reject(t)}),o=new _d(Go(n.path),i,{includeMetadataChanges:!0,Z_:!0});return yd(t,o)}(await Af(t),t.asyncQueue,e,n,r))),r.promise}function kf(t,e,n={}){const r=new Kr;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,r,s){const i=new mf({next:n=>{e.enqueueAndForget((()=>wd(t,o))),n.fromCache&&"server"===r.source?s.reject(new zr(Br.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:t=>s.reject(t)}),o=new _d(n,i,{includeMetadataChanges:!0,Z_:!0});return yd(t,o)}(await Af(t),t.asyncQueue,e,n,r))),r.promise}function Rf(t,e,n,r){const s=function(t,e){let n;return n="string"==typeof t?au().encode(t):t,function(t,e){return new gf(t,e)}(function(t,e){if(t instanceof Uint8Array)return ff(t,e);if(t instanceof ArrayBuffer)return ff(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),e)}(n,Dh(e));t.asyncQueue.enqueueAndForget((async()=>{!function(t,e,n){const r=Ur(t);(async function(t,e,n){try{const r=await e.getMetadata();if(await function(t,e){const n=Ur(t),r=Nu(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(t=>n.$r.getBundleMetadata(t,e.id))).then((t=>!!t&&t.createTime.compareTo(r)>=0))}(t.localStore,r))return await e.close(),n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(xd(r));const s=new Sd(r,t.localStore,e.serializer);let i=await e.Oa();for(;i;){const t=await s.na(i);t&&n._updateProgress(t),i=await e.Oa()}const o=await s.complete();return await Wd(t,o.sa,void 0),await function(t,e){const n=Ur(t);return n.persistence.runTransaction("Save bundle","readwrite",(t=>n.$r.saveBundleMetadata(t,e)))}(t.localStore,r),n._completeWith(o.progress),Promise.resolve(o.ia)}catch(t){return Lr("SyncEngine",`Loading bundle failed with ${t}`),n._failWith(t),Promise.resolve(new Set)}})(r,e,n).then((t=>{r.sharedClientState.notifyBundleLoaded(t)}))}(await Cf(t),s,r)}))}function Mf(t){const e={};return void 0!==t.timeoutSeconds&&(e.timeoutSeconds=t.timeoutSeconds),e}const Pf=new Map;function Lf(t,e,n){if(!n)throw new zr(Br.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function Ff(t,e,n,r){if(!0===e&&!0===r)throw new zr(Br.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function Of(t){if(!ls.isDocumentKey(t))throw new zr(Br.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function Vf(t){if(ls.isDocumentKey(t))throw new zr(Br.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function qf(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){return t.constructor?t.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":Or()}function Uf(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new zr(Br.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=qf(t);throw new zr(Br.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}function Bf(t,e){if(e<=0)throw new zr(Br.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class zf{constructor(t){var e,n;if(void 0===t.host){if(void 0!==t.ssl)throw new zr(Br.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.localCache=t.localCache,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new zr(Br.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}Ff("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===t.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Mf(null!==(n=t.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(t){if(void 0!==t.timeoutSeconds){if(isNaN(t.timeoutSeconds))throw new zr(Br.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (must not be NaN)`);if(t.timeoutSeconds<5)throw new zr(Br.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (minimum allowed value is 5)`);if(t.timeoutSeconds>30)throw new zr(Br.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&function(t,e){return t.timeoutSeconds===e.timeoutSeconds}(this.experimentalLongPollingOptions,t.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class Kf{constructor(t,e,n,r){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new zf({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new zr(Br.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new zr(Br.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new zf(t),void 0!==t.credentials&&(this._authCredentials=function(t){if(!t)return new jr;switch(t.type){case"firstParty":return new Hr(t.sessionIndex||"0",t.iamToken||null,t.authTokenFactory||null);case"provider":return t.client;default:throw new zr(Br.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=Pf.get(t);e&&(Mr("ComponentProvider","Removing Datastore"),Pf.delete(t),e.terminate())}(this),Promise.resolve()}}function Gf(t,e,n,r={}){var s;const i=(t=Uf(t,Kf))._getSettings(),o=`${e}:${n}`;if("firestore.googleapis.com"!==i.host&&i.host!==o&&Lr("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),t._setSettings(Object.assign(Object.assign({},i),{host:o,ssl:!1})),r.mockUserToken){let e,n;if("string"==typeof r.mockUserToken)e=r.mockUserToken,n=Dr.MOCK_USER;else{e=(0,a.Fy)(r.mockUserToken,null===(s=t._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new zr(Br.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new Dr(i)}t._authCredentials=new $r(new Gr(e,n))}}class jf{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new jf(this.firestore,t,this._query)}}class $f{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Qf(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new $f(this.firestore,t,this._key)}}class Qf extends jf{constructor(t,e,n){super(t,e,Go(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new $f(this.firestore,null,new ls(t))}withConverter(t){return new Qf(this.firestore,t,this._path)}}function Wf(t,e,...n){if(t=(0,a.Ku)(t),Lf("collection","path",e),t instanceof Kf){const r=as.fromString(e,...n);return Vf(r),new Qf(t,null,r)}{if(!(t instanceof $f||t instanceof Qf))throw new zr(Br.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=t._path.child(as.fromString(e,...n));return Vf(r),new Qf(t.firestore,null,r)}}function Hf(t,e){if(t=Uf(t,Kf),Lf("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new zr(Br.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new jf(t,null,function(t){return new zo(as.emptyPath(),t)}(e))}function Yf(t,e,...n){if(t=(0,a.Ku)(t),1===arguments.length&&(e=ts.newId()),Lf("doc","path",e),t instanceof Kf){const r=as.fromString(e,...n);return Of(r),new $f(t,null,new ls(r))}{if(!(t instanceof $f||t instanceof Qf))throw new zr(Br.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=t._path.child(as.fromString(e,...n));return Of(r),new $f(t.firestore,t instanceof Qf?t.converter:null,new ls(r))}}function Xf(t,e){return t=(0,a.Ku)(t),e=(0,a.Ku)(e),(t instanceof $f||t instanceof Qf)&&(e instanceof $f||e instanceof Qf)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function Jf(t,e){return t=(0,a.Ku)(t),e=(0,a.Ku)(e),t instanceof jf&&e instanceof jf&&t.firestore===e.firestore&&Jo(t._query,e._query)&&t.converter===e.converter}class Zf{constructor(){this.Xa=Promise.resolve(),this.eu=[],this.tu=!1,this.nu=[],this.ru=null,this.iu=!1,this.su=!1,this.ou=[],this.jo=new Ah(this,"async_queue_retry"),this._u=()=>{const t=Ch();t&&Mr("AsyncQueue","Visibility state changed to "+t.visibilityState),this.jo.Ko()};const t=Ch();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this._u)}get isShuttingDown(){return this.tu}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.au(),this.uu(t)}enterRestrictedMode(t){if(!this.tu){this.tu=!0,this.su=t||!1;const e=Ch();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this._u)}}enqueue(t){if(this.au(),this.tu)return new Promise((()=>{}));const e=new Kr;return this.uu((()=>this.tu&&this.su?Promise.resolve():(t().then(e.resolve,e.reject),e.promise))).then((()=>e.promise))}enqueueRetryable(t){this.enqueueAndForget((()=>(this.eu.push(t),this.cu())))}async cu(){if(0!==this.eu.length){try{await this.eu[0](),this.eu.shift(),this.jo.reset()}catch(t){if(!Ns(t))throw t;Mr("AsyncQueue","Operation failed with retryable error: "+t)}this.eu.length>0&&this.jo.qo((()=>this.cu()))}}uu(t){const e=this.Xa.then((()=>(this.iu=!0,t().catch((t=>{this.ru=t,this.iu=!1;const e=function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t);throw Pr("INTERNAL UNHANDLED ERROR: ",e),t})).then((t=>(this.iu=!1,t))))));return this.Xa=e,e}enqueueAfterDelay(t,e,n){this.au(),this.ou.indexOf(t)>-1&&(e=0);const r=ld.createAndSchedule(this,t,e,n,(t=>this.lu(t)));return this.nu.push(r),r}au(){this.ru&&Or()}verifyOperationInProgress(){}async hu(){let t;do{t=this.Xa,await t}while(t!==this.Xa)}Pu(t){for(const e of this.nu)if(e.timerId===t)return!0;return!1}Iu(t){return this.hu().then((()=>{this.nu.sort(((t,e)=>t.targetTimeMs-e.targetTimeMs));for(const e of this.nu)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.hu()}))}Tu(t){this.ou.push(t)}lu(t){const e=this.nu.indexOf(t);this.nu.splice(e,1)}}function tm(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const n=t;for(const t of e)if(t in n&&"function"==typeof n[t])return!0;return!1}(t,["next","error","complete"])}class em{constructor(){this._progressObserver={},this._taskCompletionResolver=new Kr,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const nm=-1;class rm extends Kf{constructor(t,e,n,r){super(t,e,n,r),this.type="firestore",this._queue=new Zf,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||am(this),this._firestoreClient.terminate()}}function sm(t,e,n){n||(n="(default)");const r=(0,s.j6)(t,"firestore");if(r.isInitialized(n)){const t=r.getImmediate({identifier:n}),s=r.getOptions(n);if((0,a.bD)(s,e))return t;throw new zr(Br.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==e.cacheSizeBytes&&void 0!==e.localCache)throw new zr(Br.INVALID_ARGUMENT,"cache and cacheSizeBytes cannot be specified at the same time as cacheSizeBytes willbe deprecated. Instead, specify the cache size in the cache object");if(void 0!==e.cacheSizeBytes&&-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new zr(Br.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return r.initialize({options:e,instanceIdentifier:n})}function im(t,e){const n="object"==typeof t?t:(0,s.Sx)(),r="string"==typeof t?t:e||"(default)",i=(0,s.j6)(n,"firestore").getImmediate({identifier:r});if(!i._initialized){const t=(0,a.yU)("firestore");t&&Gf(i,...t)}return i}function om(t){return t._firestoreClient||am(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function am(t){var e,n,r;const s=t._freezeSettings(),i=function(t,e,n,r){return new Fi(t,e,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,Mf(r.experimentalLongPollingOptions),r.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,s);t._firestoreClient=new wf(t._authCredentials,t._appCheckCredentials,t._queue,i),(null===(n=s.localCache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=s.localCache)||void 0===r?void 0:r._onlineComponentProvider)&&(t._firestoreClient._uninitializedComponentsProvider={_offlineKind:s.localCache.kind,_offline:s.localCache._offlineComponentProvider,_online:s.localCache._onlineComponentProvider})}function um(t,e){wm(t=Uf(t,rm));const n=om(t);if(n._uninitializedComponentsProvider)throw new zr(Br.FAILED_PRECONDITION,"SDK cache is already specified.");Lr("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const r=t._freezeSettings(),s=new df;return lm(n,s,new lf(s,r.cacheSizeBytes,null==e?void 0:e.forceOwnership))}function cm(t){wm(t=Uf(t,rm));const e=om(t);if(e._uninitializedComponentsProvider)throw new zr(Br.FAILED_PRECONDITION,"SDK cache is already specified.");Lr("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=t._freezeSettings(),r=new df;return lm(e,r,new hf(r,n.cacheSizeBytes))}function lm(t,e,n){const r=new Kr;return t.asyncQueue.enqueue((async()=>{try{await vf(t,n),await bf(t,e),r.resolve()}catch(t){const e=t;if(!If(e))throw e;Lr("Error enabling indexeddb cache. Falling back to memory cache: "+e),r.reject(e)}})).then((()=>r.promise))}function hm(t){if(t._initialized&&!t._terminated)throw new zr(Br.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new Kr;return t._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(t){if(!Cs.D())return Promise.resolve();const e=t+"main";await Cs.delete(e)}(jl(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function dm(t){return function(t){const e=new Kr;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e){const n=Ur(t);Gh(n.remoteStore)||Mr("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(t){const e=Ur(t);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(t=>e.mutationQueue.getHighestUnacknowledgedBatchId(t)))}(n.localStore);if(-1===t)return void e.resolve();const r=n.Ca.get(t)||[];r.push(e),n.Ca.set(t,r)}catch(t){const n=hd(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await Cf(t),e))),e.promise}(om(t=Uf(t,rm)))}function fm(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await Ef(t),n=await xf(t);return e.setNetworkEnabled(!0),function(t){const e=Ur(t);return e.v_.delete(0),Fh(e)}(n)}))}(om(t=Uf(t,rm)))}function mm(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await Ef(t),n=await xf(t);return e.setNetworkEnabled(!1),async function(t){const e=Ur(t);e.v_.add(0),await Oh(e),e.x_.set("Offline")}(n)}))}(om(t=Uf(t,rm)))}function gm(t){return(0,s.Us)(t.app,"firestore",t._databaseId.database),t._delete()}function pm(t,e){const n=om(t=Uf(t,rm)),r=new em;return Rf(n,t._databaseId,e,r),r}function ym(t,e){return function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){const n=Ur(t);return n.persistence.runTransaction("Get named query","readonly",(t=>n.$r.getNamedQuery(t,e)))}(await Sf(t),e)))}(om(t=Uf(t,rm)),e).then((e=>e?new jf(t,null,e.query):null))}function wm(t){if(t._initialized||t._terminated)throw new zr(Br.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class vm{constructor(t="count",e){this._internalFieldPath=e,this.type="AggregateField",this.aggregateType=t}}class bm{constructor(t,e,n){this._userDataWriter=e,this._data=n,this.type="AggregateQuerySnapshot",this.query=t}data(){return this._userDataWriter.convertObjectMap(this._data)}}class Im{constructor(t){this._byteString=t}static fromBase64String(t){try{return new Im(Di.fromBase64String(t))}catch(t){throw new zr(Br.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new Im(Di.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class _m{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new zr(Br.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new cs(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}function Tm(){return new _m("__name__")}class Em{constructor(t){this._methodName=t}}class Sm{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new zr(Br.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new zr(Br.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return es(this._lat,t._lat)||es(this._long,t._long)}}const xm=/^__.*__$/;class Cm{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new ja(t,this.data,this.fieldMask,e,this.fieldTransforms):new Ga(t,this.data,e,this.fieldTransforms)}}class Dm{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new ja(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function Am(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw Or()}}class Nm{constructor(t,e,n,r,s,i){this.settings=t,this.databaseId=e,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===s&&this.Eu(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get du(){return this.settings.du}Au(t){return new Nm(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Ru(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.Au({path:n,Vu:!1});return r.mu(t),r}fu(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.Au({path:n,Vu:!1});return r.Eu(),r}gu(t){return this.Au({path:void 0,Vu:!0})}pu(t){return Ym(t,this.settings.methodName,this.settings.yu||!1,this.path,this.settings.wu)}contains(t){return void 0!==this.fieldMask.find((e=>t.isPrefixOf(e)))||void 0!==this.fieldTransforms.find((e=>t.isPrefixOf(e.field)))}Eu(){if(this.path)for(let t=0;t<this.path.length;t++)this.mu(this.path.get(t))}mu(t){if(0===t.length)throw this.pu("Document fields must not be empty");if(Am(this.du)&&xm.test(t))throw this.pu('Document fields cannot begin and end with "__"')}}class km{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=n||Dh(t)}Su(t,e,n,r=!1){return new Nm({du:t,methodName:e,wu:n,path:cs.emptyPath(),Vu:!1,yu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function Rm(t){const e=t._freezeSettings(),n=Dh(t._databaseId);return new km(t._databaseId,!!e.ignoreUndefinedProperties,n)}function Mm(t,e,n,r,s,i={}){const o=t.Su(i.merge||i.mergeFields?2:0,e,n,s);$m("Data must be an object, but it was:",o,r);const a=Gm(r,o);let u,c;if(i.merge)u=new Si(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const r of i.mergeFields){const s=Qm(e,r,n);if(!o.contains(s))throw new zr(Br.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);Xm(t,s)||t.push(s)}u=new Si(t),c=o.fieldTransforms.filter((t=>u.covers(t.field)))}else u=null,c=o.fieldTransforms;return new Cm(new oo(a),u,c)}class Pm extends Em{_toFieldTransform(t){if(2!==t.du)throw 1===t.du?t.pu(`${this._methodName}() can only appear at the top level of your update data`):t.pu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof Pm}}function Lm(t,e,n){return new Nm({du:3,wu:e.settings.wu,methodName:t._methodName,Vu:n},e.databaseId,e.serializer,e.ignoreUndefinedProperties)}class Fm extends Em{_toFieldTransform(t){return new Pa(t.path,new xa)}isEqual(t){return t instanceof Fm}}class Om extends Em{constructor(t,e){super(t),this.bu=e}_toFieldTransform(t){const e=Lm(this,t,!0),n=this.bu.map((t=>Km(t,e))),r=new Ca(n);return new Pa(t.path,r)}isEqual(t){return t instanceof Om&&(0,a.bD)(this.bu,t.bu)}}class Vm extends Em{constructor(t,e){super(t),this.bu=e}_toFieldTransform(t){const e=Lm(this,t,!0),n=this.bu.map((t=>Km(t,e))),r=new Aa(n);return new Pa(t.path,r)}isEqual(t){return t instanceof Vm&&(0,a.bD)(this.bu,t.bu)}}class qm extends Em{constructor(t,e){super(t),this.Du=e}_toFieldTransform(t){const e=new ka(t.serializer,Ia(t.serializer,this.Du));return new Pa(t.path,e)}isEqual(t){return t instanceof qm&&this.Du===t.Du}}function Um(t,e,n,r){const s=t.Su(1,e,n);$m("Data must be an object, but it was:",s,r);const i=[],o=oo.empty();yi(r,((t,r)=>{const u=Hm(e,t,n);r=(0,a.Ku)(r);const c=s.fu(u);if(r instanceof Pm)i.push(u);else{const t=Km(r,c);null!=t&&(i.push(u),o.set(u,t))}}));const u=new Si(i);return new Dm(o,u,s.fieldTransforms)}function Bm(t,e,n,r,s,i){const o=t.Su(1,e,n),u=[Qm(e,r,n)],c=[s];if(i.length%2!=0)throw new zr(Br.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let t=0;t<i.length;t+=2)u.push(Qm(e,i[t])),c.push(i[t+1]);const l=[],h=oo.empty();for(let t=u.length-1;t>=0;--t)if(!Xm(l,u[t])){const e=u[t];let n=c[t];n=(0,a.Ku)(n);const r=o.fu(e);if(n instanceof Pm)l.push(e);else{const t=Km(n,r);null!=t&&(l.push(e),h.set(e,t))}}const d=new Si(l);return new Dm(h,d,o.fieldTransforms)}function zm(t,e,n,r=!1){return Km(n,t.Su(r?4:3,e))}function Km(t,e){if(jm(t=(0,a.Ku)(t)))return $m("Unsupported field value:",e,t),Gm(t,e);if(t instanceof Em)return function(t,e){if(!Am(e.du))throw e.pu(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.pu(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.Vu&&4!==e.du)throw e.pu("Nested arrays are not supported");return function(t,e){const n=[];let r=0;for(const s of t){let t=Km(s,e.gu(r));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),r++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=(0,a.Ku)(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return Ia(e.serializer,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=ss.fromDate(t);return{timestampValue:Cu(e.serializer,n)}}if(t instanceof ss){const n=new ss(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:Cu(e.serializer,n)}}if(t instanceof Sm)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof Im)return{bytesValue:Du(e.serializer,t._byteString)};if(t instanceof $f){const n=e.databaseId,r=t.firestore._databaseId;if(!r.isEqual(n))throw e.pu(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:ku(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.pu(`Unsupported field value: ${qf(t)}`)}(t,e)}function Gm(t,e){const n={};return wi(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):yi(t,((t,r)=>{const s=Km(r,e.Ru(t));null!=s&&(n[t]=s)})),{mapValue:{fields:n}}}function jm(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof ss||t instanceof Sm||t instanceof Im||t instanceof $f||t instanceof Em)}function $m(t,e,n){if(!jm(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const r=qf(n);throw"an object"===r?e.pu(t+" a custom object"):e.pu(t+" "+r)}}function Qm(t,e,n){if((e=(0,a.Ku)(e))instanceof _m)return e._internalPath;if("string"==typeof e)return Hm(t,e);throw Ym("Field path arguments must be of type string or ",t,!1,void 0,n)}const Wm=new RegExp("[~\\*/\\[\\]]");function Hm(t,e,n){if(e.search(Wm)>=0)throw Ym(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new _m(...e.split("."))._internalPath}catch(r){throw Ym(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function Ym(t,e,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(i||o)&&(u+=" (found",i&&(u+=` in field ${r}`),o&&(u+=` in document ${s}`),u+=")"),new zr(Br.INVALID_ARGUMENT,a+t+u)}function Xm(t,e){return t.some((t=>t.isEqual(e)))}class Jm{constructor(t,e,n,r,s){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new $f(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new Zm(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(tg("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class Zm extends Jm{data(){return super.data()}}function tg(t,e){return"string"==typeof e?Hm(t,e):e instanceof _m?e._internalPath:e._delegate._internalPath}function eg(t){if("L"===t.limitType&&0===t.explicitOrderBy.length)throw new zr(Br.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class ng{}class rg extends ng{}function sg(t,e,...n){let r=[];e instanceof ng&&r.push(e),r=r.concat(n),function(t){const e=t.filter((t=>t instanceof ag)).length,n=t.filter((t=>t instanceof ig)).length;if(e>1||e>0&&n>0)throw new zr(Br.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const e of r)t=e._apply(t);return t}class ig extends rg{constructor(t,e,n){super(),this._field=t,this._op=e,this._value=n,this.type="where"}static _create(t,e,n){return new ig(t,e,n)}_apply(t){const e=this._parse(t);return Eg(t._query,e),new jf(t.firestore,t.converter,Yo(t._query,e))}_parse(t){const e=Rm(t.firestore),n=function(t,e,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new zr(Br.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){Tg(o,i);const e=[];for(const n of o)e.push(_g(r,t,n));a={arrayValue:{values:e}}}else a=_g(r,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Tg(o,i),a=zm(n,e,o,"in"===i||"not-in"===i);return po.create(s,i,a)}(t._query,"where",e,t.firestore._databaseId,this._field,this._op,this._value);return n}}function og(t,e,n){const r=e,s=tg("where",t);return ig._create(s,r,n)}class ag extends ng{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new ag(t,e)}_parse(t){const e=this._queryConstraints.map((e=>e._parse(t))).filter((t=>t.getFilters().length>0));return 1===e.length?e[0]:yo.create(e,this._getOperator())}_apply(t){const e=this._parse(t);return 0===e.getFilters().length?t:(function(t,e){let n=t;const r=e.getFlattenedFilters();for(const t of r)Eg(n,t),n=Yo(n,t)}(t._query,e),new jf(t.firestore,t.converter,Yo(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}function ug(...t){return t.forEach((t=>Sg("or",t))),ag._create("or",t)}function cg(...t){return t.forEach((t=>Sg("and",t))),ag._create("and",t)}class lg extends rg{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new lg(t,e)}_apply(t){const e=function(t,e,n){if(null!==t.startAt)throw new zr(Br.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new zr(Br.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new fo(e,n)}(t._query,this._field,this._direction);return new jf(t.firestore,t.converter,function(t,e){const n=t.explicitOrderBy.concat([e]);return new zo(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))}}function hg(t,e="asc"){const n=e,r=tg("orderBy",t);return lg._create(r,n)}class dg extends rg{constructor(t,e,n){super(),this.type=t,this._limit=e,this._limitType=n}static _create(t,e,n){return new dg(t,e,n)}_apply(t){return new jf(t.firestore,t.converter,Xo(t._query,this._limit,this._limitType))}}function fg(t){return Bf("limit",t),dg._create("limit",t,"F")}function mg(t){return Bf("limitToLast",t),dg._create("limitToLast",t,"L")}class gg extends rg{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new gg(t,e,n)}_apply(t){const e=Ig(t,this.type,this._docOrFields,this._inclusive);return new jf(t.firestore,t.converter,function(t,e){return new zo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))}}function pg(...t){return gg._create("startAt",t,!0)}function yg(...t){return gg._create("startAfter",t,!1)}class wg extends rg{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new wg(t,e,n)}_apply(t){const e=Ig(t,this.type,this._docOrFields,this._inclusive);return new jf(t.firestore,t.converter,function(t,e){return new zo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))}}function vg(...t){return wg._create("endBefore",t,!1)}function bg(...t){return wg._create("endAt",t,!0)}function Ig(t,e,n,r){if(n[0]=(0,a.Ku)(n[0]),n[0]instanceof Jm)return function(t,e,n,r,s){if(!r)throw new zr(Br.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of Qo(t))if(n.field.isKeyField())i.push(Wi(e,r.key));else{const t=r.data.field(n.field);if(Mi(t))throw new zr(Br.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=n.field.canonicalString();throw new zr(Br.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new co(i,s)}(t._query,t.firestore._databaseId,e,n[0]._document,r);{const s=Rm(t.firestore);return function(t,e,n,r,s,i){const o=t.explicitOrderBy;if(s.length>o.length)throw new zr(Br.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let i=0;i<s.length;i++){const u=s[i];if(o[i].field.isKeyField()){if("string"!=typeof u)throw new zr(Br.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof u}`);if(!$o(t)&&-1!==u.indexOf("/"))throw new zr(Br.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${u}' contains a slash.`);const n=t.path.child(as.fromString(u));if(!ls.isDocumentKey(n))throw new zr(Br.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new ls(n);a.push(Wi(e,s))}else{const t=zm(n,r,u);a.push(t)}}return new co(a,i)}(t._query,t.firestore._databaseId,s,e,n,r)}}function _g(t,e,n){if("string"==typeof(n=(0,a.Ku)(n))){if(""===n)throw new zr(Br.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!$o(e)&&-1!==n.indexOf("/"))throw new zr(Br.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=e.path.child(as.fromString(n));if(!ls.isDocumentKey(r))throw new zr(Br.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Wi(t,new ls(r))}if(n instanceof $f)return Wi(t,n._key);throw new zr(Br.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${qf(n)}.`)}function Tg(t,e){if(!Array.isArray(t)||0===t.length)throw new zr(Br.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`)}function Eg(t,e){const n=function(t,e){for(const n of t)for(const t of n.getFlattenedFilters())if(e.indexOf(t.op)>=0)return t.op;return null}(t.filters,function(t){switch(t){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==n)throw n===e.op?new zr(Br.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new zr(Br.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${n.toString()}' filters.`)}function Sg(t,e){if(!(e instanceof ig||e instanceof ag))throw new zr(Br.INVALID_ARGUMENT,`Function ${t}() requires AppliableConstraints created with a call to 'where(...)', 'or(...)', or 'and(...)'.`)}class xg{convertValue(t,e="none"){switch(Ui(t)){case 0:return null;case 1:return t.booleanValue;case 2:return ki(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(Ri(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw Or()}}convertObject(t,e){return this.convertObjectMap(t.fields,e)}convertObjectMap(t,e="none"){const n={};return yi(t,((t,r)=>{n[t]=this.convertValue(r,e)})),n}convertGeoPoint(t){return new Sm(ki(t.latitude),ki(t.longitude))}convertArray(t,e){return(t.values||[]).map((t=>this.convertValue(t,e)))}convertServerTimestamp(t,e){switch(e){case"previous":const n=Pi(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(Li(t));default:return null}}convertTimestamp(t){const e=Ni(t);return new ss(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=as.fromString(t);Vr(ec(n));const r=new Oi(n.get(1),n.get(3)),s=new ls(n.popFirst(5));return r.isEqual(e)||Pr(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),s}}function Cg(t,e,n){let r;return r=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e,r}class Dg extends xg{constructor(t){super(),this.firestore=t}convertBytes(t){return new Im(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new $f(this.firestore,null,e)}}function Ag(t){return new vm("sum",Qm("sum",t))}function Ng(t){return new vm("avg",Qm("average",t))}function kg(){return new vm("count")}function Rg(t,e){var n,r;return t instanceof vm&&e instanceof vm&&t.aggregateType===e.aggregateType&&(null===(n=t._internalFieldPath)||void 0===n?void 0:n.canonicalString())===(null===(r=e._internalFieldPath)||void 0===r?void 0:r.canonicalString())}function Mg(t,e){return Jf(t.query,e.query)&&(0,a.bD)(t.data(),e.data())}class Pg{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class Lg extends Jm{constructor(t,e,n,r,s,i){super(t,e,n,r,i),this._firestore=t,this._firestoreImpl=t,this.metadata=s}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new Fg(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const n=this._document.data.field(tg("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class Fg extends Lg{data(t={}){return super.data(t)}}class Og{constructor(t,e,n,r){this._firestore=t,this._userDataWriter=e,this._snapshot=r,this.metadata=new Pg(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach((e=>t.push(e))),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach((n=>{t.call(e,new Fg(this._firestore,this._userDataWriter,n.key,n,new Pg(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new zr(Br.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map((n=>{const r=new Fg(t._firestore,t._userDataWriter,n.doc.key,n.doc,new Pg(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:e++}}))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((t=>e||3!==t.type)).map((e=>{const r=new Fg(t._firestore,t._userDataWriter,e.doc.key,e.doc,new Pg(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let s=-1,i=-1;return 0!==e.type&&(s=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(n=n.add(e.doc),i=n.indexOf(e.doc.key)),{type:Vg(e.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function Vg(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Or()}}function qg(t,e){return t instanceof Lg&&e instanceof Lg?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof Og&&e instanceof Og&&t._firestore===e._firestore&&Jf(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function Ug(t){t=Uf(t,$f);const e=Uf(t.firestore,rm);return Nf(om(e),t._key).then((n=>tp(e,t,n)))}class Bg extends xg{constructor(t){super(),this.firestore=t}convertBytes(t){return new Im(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new $f(this.firestore,null,e)}}function zg(t){t=Uf(t,$f);const e=Uf(t.firestore,rm),n=om(e),r=new Bg(e);return function(t,e){const n=new Kr;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const r=await function(t,e){const n=Ur(t);return n.persistence.runTransaction("read document","readonly",(t=>n.localDocuments.getDocument(t,e)))}(t,e);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new zr(Br.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){const r=hd(t,`Failed to get document '${e} from cache`);n.reject(r)}}(await Sf(t),e,n))),n.promise}(n,t._key).then((n=>new Lg(e,r,t._key,n,new Pg(null!==n&&n.hasLocalMutations,!0),t.converter)))}function Kg(t){t=Uf(t,$f);const e=Uf(t.firestore,rm);return Nf(om(e),t._key,{source:"server"}).then((n=>tp(e,t,n)))}function Gg(t){t=Uf(t,jf);const e=Uf(t.firestore,rm),n=om(e),r=new Bg(e);return eg(t._query),kf(n,t._query).then((n=>new Og(e,r,t,n)))}function jg(t){t=Uf(t,jf);const e=Uf(t.firestore,rm),n=om(e),r=new Bg(e);return function(t,e){const n=new Kr;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const r=await rh(t,e,!0),s=new Ad(e,r.hs),i=s.ha(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(t){const r=hd(t,`Failed to execute query '${e} against cache`);n.reject(r)}}(await Sf(t),e,n))),n.promise}(n,t._query).then((n=>new Og(e,r,t,n)))}function $g(t){t=Uf(t,jf);const e=Uf(t.firestore,rm),n=om(e),r=new Bg(e);return kf(n,t._query,{source:"server"}).then((n=>new Og(e,r,t,n)))}function Qg(t,e,n){t=Uf(t,$f);const r=Uf(t.firestore,rm),s=Cg(t.converter,e,n);return Zg(r,[Mm(Rm(r),"setDoc",t._key,s,null!==t.converter,n).toMutation(t._key,Fa.none())])}function Wg(t,e,n,...r){t=Uf(t,$f);const s=Uf(t.firestore,rm),i=Rm(s);let o;return o="string"==typeof(e=(0,a.Ku)(e))||e instanceof _m?Bm(i,"updateDoc",t._key,e,n,r):Um(i,"updateDoc",t._key,e),Zg(s,[o.toMutation(t._key,Fa.exists(!0))])}function Hg(t){return Zg(Uf(t.firestore,rm),[new Ha(t._key,Fa.none())])}function Yg(t,e){const n=Uf(t.firestore,rm),r=Yf(t),s=Cg(t.converter,e);return Zg(n,[Mm(Rm(t.firestore),"addDoc",r._key,s,null!==t.converter,{}).toMutation(r._key,Fa.exists(!1))]).then((()=>r))}function Xg(t,...e){var n,r,s;t=(0,a.Ku)(t);let i={includeMetadataChanges:!1},o=0;"object"!=typeof e[o]||tm(e[o])||(i=e[o],o++);const u={includeMetadataChanges:i.includeMetadataChanges};if(tm(e[o])){const t=e[o];e[o]=null===(n=t.next)||void 0===n?void 0:n.bind(t),e[o+1]=null===(r=t.error)||void 0===r?void 0:r.bind(t),e[o+2]=null===(s=t.complete)||void 0===s?void 0:s.bind(t)}let c,l,h;if(t instanceof $f)l=Uf(t.firestore,rm),h=Go(t._key.path),c={next:n=>{e[o]&&e[o](tp(l,t,n))},error:e[o+1],complete:e[o+2]};else{const n=Uf(t,jf);l=Uf(n.firestore,rm),h=n._query;const r=new Bg(l);c={next:t=>{e[o]&&e[o](new Og(l,r,n,t))},error:e[o+1],complete:e[o+2]},eg(t._query)}return function(t,e,n,r){const s=new mf(r),i=new _d(e,s,n);return t.asyncQueue.enqueueAndForget((async()=>yd(await Af(t),i))),()=>{s.La(),t.asyncQueue.enqueueAndForget((async()=>wd(await Af(t),i)))}}(om(l),h,u,c)}function Jg(t,e){return function(t,e){const n=new mf(e);return t.asyncQueue.enqueueAndForget((async()=>function(t,e){Ur(t).K_.add(e),e.next()}(await Af(t),n))),()=>{n.La(),t.asyncQueue.enqueueAndForget((async()=>function(t,e){Ur(t).K_.delete(e)}(await Af(t),n)))}}(om(t=Uf(t,rm)),tm(e)?e:{next:e})}function Zg(t,e){return function(t,e){const n=new Kr;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){const r=af(t);try{const t=await function(t,e){const n=Ur(t),r=ss.now(),s=e.reduce(((t,e)=>t.add(e.key)),pa());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(t=>{let a=aa(),u=pa();return n.os.getEntries(t,s).next((t=>{a=t,a.forEach(((t,e)=>{e.isValidDocument()||(u=u.add(t))}))})).next((()=>n.localDocuments.getOverlayedDocuments(t,a))).next((s=>{i=s;const o=[];for(const t of e){const e=za(t,i.get(t.key).overlayedDocument);null!=e&&o.push(new ja(t.key,e,ao(e.value.mapValue),Fa.exists(!0)))}return n.mutationQueue.addMutationBatch(t,r,o,e)})).next((e=>{o=e;const r=e.applyToLocalDocumentSet(i,u);return n.documentOverlayCache.saveOverlays(t,e.batchId,r)}))})).then((()=>({batchId:o.batchId,changes:la(i)})))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let r=t.Da[t.currentUser.toKey()];r||(r=new vi(es)),r=r.insert(e,n),t.Da[t.currentUser.toKey()]=r}(r,t.batchId,n),await Wd(r,t.changes),await Xh(r.remoteStore)}catch(t){const e=hd(t,"Failed to persist write");n.reject(e)}}(await Cf(t),e,n))),n.promise}(om(t),e)}function tp(t,e,n){const r=n.docs.get(e._key),s=new Bg(t);return new Lg(t,s,e._key,r,new Pg(n.hasPendingWrites,n.fromCache),e.converter)}function ep(t){return np(t,{count:kg()})}function np(t,e){const n=Uf(t.firestore,rm),r=om(n),s=function(t,e){const n=[];for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&n.push(e(t[r],r,t));return n}(e,((t,e)=>new tu(e,t.aggregateType,t._internalFieldPath)));return function(t,e,n){const r=new Kr;return t.asyncQueue.enqueueAndForget((async()=>{try{const s=await Df(t);r.resolve(async function(t,e,n){var r;const s=Ur(t),{request:i,V_:o,parent:a}=function(t,e,n){const{ut:r,parent:s}=ju(t,e),i={},o=[];let a=0;return n.forEach((t=>{const e="aggregate_"+a++;i[e]=t.alias,"count"===t.aggregateType?o.push({alias:e,count:{}}):"avg"===t.aggregateType?o.push({alias:e,avg:{field:Xu(t.fieldPath)}}):"sum"===t.aggregateType&&o.push({alias:e,sum:{field:Xu(t.fieldPath)}})})),{request:{structuredAggregationQuery:{aggregations:o,structuredQuery:r.structuredQuery},parent:r.parent},V_:i,parent:s}}(s.serializer,function(t){const e=Ur(t);return e.Pe||(e.Pe=Ho(e,t.explicitOrderBy)),e.Pe}(e),n);s.connection.wo||delete i.parent;const u=(await s.vo("RunAggregationQuery",s.serializer.databaseId,a,i,1)).filter((t=>!!t.result));Vr(1===u.length);const c=null===(r=u[0].result)||void 0===r?void 0:r.aggregateFields;return Object.keys(c).reduce(((t,e)=>(t[o[e]]=c[e],t)),{})}(s,e,n))}catch(t){r.reject(t)}})),r.promise}(r,t._query,s).then((e=>function(t,e,n){const r=new Bg(t);return new bm(e,r,n)}(n,t,e)))}class rp{constructor(t){this.kind="memory",this._onlineComponentProvider=new df,(null==t?void 0:t.garbageCollector)?this._offlineComponentProvider=t.garbageCollector._offlineComponentProvider:this._offlineComponentProvider=new uf}toJSON(){return{kind:this.kind}}}class sp{constructor(t){let e;this.kind="persistent",(null==t?void 0:t.tabManager)?(t.tabManager._initialize(t),e=t.tabManager):(e=fp(void 0),e._initialize(t)),this._onlineComponentProvider=e._onlineComponentProvider,this._offlineComponentProvider=e._offlineComponentProvider}toJSON(){return{kind:this.kind}}}class ip{constructor(){this.kind="memoryEager",this._offlineComponentProvider=new uf}toJSON(){return{kind:this.kind}}}class op{constructor(t){this.kind="memoryLru",this._offlineComponentProvider=new cf(t)}toJSON(){return{kind:this.kind}}}function ap(){return new ip}function up(t){return new op(null==t?void 0:t.cacheSizeBytes)}function cp(t){return new rp(t)}function lp(t){return new sp(t)}class hp{constructor(t){this.forceOwnership=t,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(t){this._onlineComponentProvider=new df,this._offlineComponentProvider=new lf(this._onlineComponentProvider,null==t?void 0:t.cacheSizeBytes,this.forceOwnership)}}class dp{constructor(){this.kind="PersistentMultipleTab"}toJSON(){return{kind:this.kind}}_initialize(t){this._onlineComponentProvider=new df,this._offlineComponentProvider=new hf(this._onlineComponentProvider,null==t?void 0:t.cacheSizeBytes)}}function fp(t){return new hp(null==t?void 0:t.forceOwnership)}function mp(){return new dp}const gp={maxAttempts:5};class pp{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=Rm(t)}set(t,e,n){this._verifyNotCommitted();const r=yp(t,this._firestore),s=Cg(r.converter,e,n),i=Mm(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,Fa.none())),this}update(t,e,n,...r){this._verifyNotCommitted();const s=yp(t,this._firestore);let i;return i="string"==typeof(e=(0,a.Ku)(e))||e instanceof _m?Bm(this._dataReader,"WriteBatch.update",s._key,e,n,r):Um(this._dataReader,"WriteBatch.update",s._key,e),this._mutations.push(i.toMutation(s._key,Fa.exists(!0))),this}delete(t){this._verifyNotCommitted();const e=yp(t,this._firestore);return this._mutations=this._mutations.concat(new Ha(e._key,Fa.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new zr(Br.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function yp(t,e){if((t=(0,a.Ku)(t)).firestore!==e)throw new zr(Br.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}class wp extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=Rm(t)}get(t){const e=yp(t,this._firestore),n=new Dg(this._firestore);return this._transaction.lookup([e._key]).then((t=>{if(!t||1!==t.length)return Or();const r=t[0];if(r.isFoundDocument())return new Jm(this._firestore,n,r.key,r,e.converter);if(r.isNoDocument())return new Jm(this._firestore,n,e._key,null,e.converter);throw Or()}))}set(t,e,n){const r=yp(t,this._firestore),s=Cg(r.converter,e,n),i=Mm(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(t,e,n,...r){const s=yp(t,this._firestore);let i;return i="string"==typeof(e=(0,a.Ku)(e))||e instanceof _m?Bm(this._dataReader,"Transaction.update",s._key,e,n,r):Um(this._dataReader,"Transaction.update",s._key,e),this._transaction.update(s._key,i),this}delete(t){const e=yp(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=yp(t,this._firestore),n=new Bg(this._firestore);return super.get(t).then((t=>new Lg(this._firestore,n,e._key,t._document,new Pg(!1,!1),e.converter)))}}function vp(t,e,n){t=Uf(t,rm);const r=Object.assign(Object.assign({},gp),n);return function(t){if(t.maxAttempts<1)throw new zr(Br.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(t,e,n){const r=new Kr;return t.asyncQueue.enqueueAndForget((async()=>{const s=await Df(t);new yf(t.asyncQueue,s,n,e,r).ja()})),r.promise}(om(t),(n=>e(new wp(t,n))),r)}function bp(){return new Pm("deleteField")}function Ip(){return new Fm("serverTimestamp")}function _p(...t){return new Om("arrayUnion",t)}function Tp(...t){return new Vm("arrayRemove",t)}function Ep(t){return new qm("increment",t)}function Sp(t){return om(t=Uf(t,rm)),new pp(t,(e=>Zg(t,e)))}function xp(t,e){var n;const r=om(t=Uf(t,rm));if(!r._uninitializedComponentsProvider||"memory"===(null===(n=r._uninitializedComponentsProvider)||void 0===n?void 0:n._offlineKind))return Lr("Cannot enable indexes when persistence is disabled"),Promise.resolve();const s=function(t){const e="string"==typeof t?function(t){try{return JSON.parse(t)}catch(t){throw new zr(Br.INVALID_ARGUMENT,"Failed to parse JSON: "+(null==t?void 0:t.message))}}(t):t,n=[];if(Array.isArray(e.indexes))for(const t of e.indexes){const e=Cp(t,"collectionGroup"),r=[];if(Array.isArray(t.fields))for(const e of t.fields){const t=Hm("setIndexConfiguration",Cp(e,"fieldPath"));"CONTAINS"===e.arrayConfig?r.push(new gs(t,2)):"ASCENDING"===e.order?r.push(new gs(t,0)):"DESCENDING"===e.order&&r.push(new gs(t,1))}n.push(new hs(hs.UNKNOWN_ID,e,r,ys.empty()))}return n}(e);return function(t,e){return t.asyncQueue.enqueue((async()=>async function(t,e){const n=Ur(t),r=n.indexManager,s=[];return n.persistence.runTransaction("Configure indexes","readwrite",(t=>r.getFieldIndexes(t).next((n=>function(t,e,n,r,s){t=[...t],e=[...e],t.sort(n),e.sort(n);const i=t.length,o=e.length;let a=0,u=0;for(;a<o&&u<i;){const i=n(t[u],e[a]);i<0?s(t[u++]):i>0?r(e[a++]):(a++,u++)}for(;a<o;)r(e[a++]);for(;u<i;)s(t[u++])}(n,e,ms,(e=>{s.push(r.addFieldIndex(t,e))}),(e=>{s.push(r.deleteFieldIndex(t,e))})))).next((()=>Ss.waitFor(s)))))}(await Sf(t),e)))}(r,s)}function Cp(t,e){if("string"!=typeof t[e])throw new zr(Br.INVALID_ARGUMENT,"Missing string value for: "+e);return t[e]}class Dp{constructor(t){this._client=t,this.type="PersistentCacheIndexManager"}}function Ap(t){var e;t=Uf(t,rm);const n=Pp.get(t);if(n)return n;const r=om(t);if("persistent"!==(null===(e=r._uninitializedComponentsProvider)||void 0===e?void 0:e._offlineKind))return null;const s=new Dp(r);return Pp.set(t,s),s}function Np(t){Mp(t,!0)}function kp(t){Mp(t,!1)}function Rp(t){t._client.verifyNotTerminated(),function(t){return t.asyncQueue.enqueue((async()=>function(t){const e=Ur(t),n=e.indexManager;return e.persistence.runTransaction("Delete All Indexes","readwrite",(t=>n.deleteAllFieldIndexes(t)))}(await Sf(t))))}(t._client).then((t=>Mr("deleting all persistent cache indexes succeeded"))).catch((t=>Lr("deleting all persistent cache indexes failed",t)))}function Mp(t,e){t._client.verifyNotTerminated(),function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){Ur(t).ts.Ui=e}(await Sf(t),e)))}(t._client,e).then((t=>Mr(`setting persistent cache index auto creation isEnabled=${e} succeeded`))).catch((t=>Lr(`setting persistent cache index auto creation isEnabled=${e} failed`,t)))}const Pp=new WeakMap;class Lp{constructor(){throw new Error("instances of this class should not be created")}static onExistenceFilterMismatch(t){return Fp.instance.onExistenceFilterMismatch(t)}}class Fp{constructor(){this.Cu=new Map}static get instance(){return Op||(Op=new Fp,function(t){if(ou)throw new Error("a TestingHooksSpi instance is already set");ou=t}(Op)),Op}tt(t){this.Cu.forEach((e=>e(t)))}onExistenceFilterMismatch(t){const e=Symbol(),n=this.Cu;return n.set(e,t),()=>n.delete(e)}}let Op=null;!function(t,e=!0){!function(t){Ar=t}(s.MF),(0,s.om)(new i.uA("firestore",((t,{instanceIdentifier:n,options:r})=>{const s=t.getProvider("app").getImmediate(),i=new rm(new Qr(t.getProvider("auth-internal")),new Xr(t.getProvider("app-check-internal")),function(t,e){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new zr(Br.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Oi(t.options.projectId,e)}(s,n),s);return r=Object.assign({useFetchStreams:e},r),i._setSettings(r),i}),"PUBLIC").setMultipleInstances(!0)),(0,s.KO)(Cr,"4.4.1",t),(0,s.KO)(Cr,"4.4.1","esm2017")}()}}]);